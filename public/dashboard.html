<!DOCTYPE html>
<html lang="pt">

<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Restaurant Menu Admin Dashboard</title>
    <!-- ======= Styles ====== -->
    <style>
        /* =========== Google Fonts ============ */
        @import url("https://fonts.googleapis.com/css2?family=Ubuntu:wght@300;400;500;700&display=swap");

        /* =============== Globals ============== */
        * {
            font-family: "Ubuntu", sans-serif;
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            /* --primary-color: #2a2185; */
            --white: #fff;
            --gray: #f5f5f5;
            --black1: #222;
            --black2: #999;
            --green: #4CAF50;
            --orange: #FF9800;
            --red: #f44336;
            --purple: #9C27B0;
            --primary-color: #FF7043;
            --secondary-color: #FF5722;
        }

        body {
            min-height: 100vh;
            overflow-x: hidden;
        }

        .container {
            position: relative;
            width: 100%;
        }

        /* =============== Navigation ================ */
        .navigation {
            position: fixed;
            width: 300px;
            height: 100%;
            background: var(--primary-color);
            border-left: 10px solid var(--primary-color);
            transition: 0.5s;
            overflow: hidden;
            z-index: 1000;
        }

        .navigation.active {
            width: 80px;
        }

        .navigation ul {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
        }

        .navigation ul li {
            position: relative;
            width: 100%;
            list-style: none;
            border-top-left-radius: 30px;
            border-bottom-left-radius: 30px;
        }

        .navigation ul li:hover,
        .navigation ul li.hovered {
            background-color: var(--white);
        }

        .navigation ul li:nth-child(1) {
            margin-bottom: 40px;
            pointer-events: none;
        }

        .navigation ul li a {
            position: relative;
            display: block;
            width: 100%;
            display: flex;
            text-decoration: none;
            color: var(--white);
            cursor: pointer;
        }

        .navigation ul li:hover a,
        .navigation ul li.hovered a {
            color: var(--primary-color);
        }

        .navigation ul li a .icon {
            position: relative;
            display: block;
            min-width: 60px;
            height: 60px;
            line-height: 75px;
            text-align: center;
        }

        .navigation ul li a .icon ion-icon {
            font-size: 1.75rem;
        }

        .navigation ul li a .title {
            position: relative;
            display: block;
            padding: 0 10px;
            height: 60px;
            line-height: 60px;
            text-align: start;
            white-space: nowrap;
        }

        /* --------- curve outside ---------- */
        .navigation ul li:hover a::before,
        .navigation ul li.hovered a::before {
            content: "";
            position: absolute;
            right: 0;
            top: -50px;
            width: 50px;
            height: 50px;
            background-color: transparent;
            border-radius: 50%;
            box-shadow: 35px 35px 0 10px var(--white);
            pointer-events: none;
        }

        .navigation ul li:hover a::after,
        .navigation ul li.hovered a::after {
            content: "";
            position: absolute;
            right: 0;
            bottom: -50px;
            width: 50px;
            height: 50px;
            background-color: transparent;
            border-radius: 50%;
            box-shadow: 35px -35px 0 10px var(--white);
            pointer-events: none;
        }

        /* ===================== Main ===================== */
        .main {
            position: absolute;
            width: calc(100% - 300px);
            left: 300px;
            min-height: 100vh;
            background: var(--white);
            transition: 0.5s;
        }

        .main.active {
            width: calc(100% - 80px);
            left: 80px;
        }

        .topbar {
            width: 100%;
            height: 60px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0 10px;
            background: var(--white);
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        }

        .toggle {
            position: relative;
            width: 60px;
            height: 60px;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 2.5rem;
            cursor: pointer;
        }

        .search {
            position: relative;
            width: 400px;
            margin: 0 10px;
        }

        .search label {
            position: relative;
            width: 100%;
        }

        .search label input {
            width: 100%;
            height: 40px;
            border-radius: 40px;
            padding: 5px 20px;
            padding-left: 35px;
            font-size: 18px;
            outline: none;
            border: 1px solid var(--black2);
        }

        .search label ion-icon {
            position: absolute;
            top: 0;
            left: 10px;
            font-size: 1.2rem;
        }

        .user {
            position: relative;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            overflow: hidden;
            cursor: pointer;
            background: var(--primary-color);
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--white);
        }

        /* ======================= Cards ====================== */
        .cardBox {
            position: relative;
            width: 100%;
            padding: 20px;
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            grid-gap: 30px;
        }

        .cardBox .card {
            position: relative;
            background: var(--white);
            padding: 30px;
            border-radius: 20px;
            display: flex;
            justify-content: space-between;
            cursor: pointer;
            box-shadow: 0 7px 25px rgba(0, 0, 0, 0.08);
            transition: all 0.3s ease;
        }

        .cardBox .card:hover {
            transform: translateY(-5px);
            box-shadow: 0 15px 35px rgba(0, 0, 0, 0.15);
        }

        .cardBox .card .numbers {
            position: relative;
            font-weight: 500;
            font-size: 2.5rem;
            color: var(--primary-color);
        }

        .cardBox .card .cardName {
            color: var(--black2);
            font-size: 1.1rem;
            margin-top: 5px;
        }

        .cardBox .card .iconBx {
            font-size: 3.5rem;
            color: var(--black2);
        }

        .cardBox .card:hover {
            background: var(--primary-color);
        }

        .cardBox .card:hover .numbers,
        .cardBox .card:hover .cardName,
        .cardBox .card:hover .iconBx {
            color: var(--white);
        }

        /* ================== Details Section ============== */
        .details {
            position: relative;
            width: 100%;
            padding: 20px;
            display: grid;
            grid-template-columns: 2fr 1fr;
            grid-gap: 30px;
        }

        .details .recentOrders {
            position: relative;
            display: grid;
            min-height: 500px;
            background: var(--white);
            padding: 20px;
            box-shadow: 0 7px 25px rgba(0, 0, 0, 0.08);
            border-radius: 20px;
        }

        .details .cardHeader {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 20px;
        }

        .cardHeader h2 {
            font-weight: 600;
            color: var(--primary-color);
        }

        .cardHeader .btn {
            position: relative;
            padding: 8px 15px;
            background: var(--primary-color);
            text-decoration: none;
            color: var(--white);
            border-radius: 8px;
            border: none;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .cardHeader .btn:hover {
            background: var(--black1);
            transform: translateY(-2px);
        }

        .details table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 10px;
        }

        .details table thead td {
            font-weight: 600;
            padding: 15px 10px;
            background: var(--gray);
            border-radius: 8px;
        }

        .details .recentOrders table tr {
            color: var(--black1);
            border-bottom: 1px solid rgba(0, 0, 0, 0.1);
        }

        .details .recentOrders table tr:last-child {
            border-bottom: none;
        }

        .details .recentOrders table tbody tr:hover {
            background: var(--primary-color);
            color: var(--white);
        }

        .details .recentOrders table tr td {
            padding: 15px 10px;
        }

        .status {
            padding: 5px 10px;
            border-radius: 6px;
            font-size: 12px;
            font-weight: 500;
            text-transform: uppercase;
        }

        .status.active {
            background: var(--green);
            color: var(--white);
        }

        .status.inactive {
            background: var(--red);
            color: var(--white);
        }

        .status.promotion {
            background: var(--orange);
            color: var(--white);
        }

        .recentCustomers {
            position: relative;
            display: grid;
            min-height: 500px;
            padding: 20px;
            background: var(--white);
            box-shadow: 0 7px 25px rgba(0, 0, 0, 0.08);
            border-radius: 20px;
        }

        /* ============ Modal Styles ============ */
        .modal {
            display: none;
            position: fixed;
            z-index: 2000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
        }

        .modal-content {
            background-color: var(--white);
            margin: 5% auto;
            padding: 30px;
            border-radius: 20px;
            width: 90%;
            max-width: 500px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.3);
            animation: modalShow 0.3s ease;
        }

        @keyframes modalShow {
            from {
                opacity: 0;
                transform: translateY(-50px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .close {
            color: var(--black2);
            float: right;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
        }

        .close:hover {
            color: var(--red);
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: 500;
            color: var(--black1);
        }

        .form-group input,
        .form-group textarea,
        .form-group select {
            width: 100%;
            padding: 12px;
            border: 1px solid var(--black2);
            border-radius: 8px;
            font-size: 16px;
            outline: none;
            transition: border-color 0.3s ease;
        }

        .form-group input:focus,
        .form-group textarea:focus,
        .form-group select:focus {
            border-color: var(--primary-color);
        }

        .btn-primary {
            background: var(--primary-color);
            color: var(--white);
            padding: 12px 30px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 16px;
            font-weight: 500;
            transition: all 0.3s ease;
        }

        .btn-primary:hover {
            background: var(--black1);
            transform: translateY(-2px);
        }

        .btn-secondary {
            background: var(--black2);
            color: var(--white);
            padding: 12px 30px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 16px;
            font-weight: 500;
            margin-right: 10px;
            transition: all 0.3s ease;
        }

        .loading {
            display: none;
            text-align: center;
            padding: 20px;
        }

        .spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid var(--primary-color);
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto 10px;
        }

        @keyframes spin {
            0% {
                transform: rotate(0deg);
            }

            100% {
                transform: rotate(360deg);
            }
        }

        .alert {
            padding: 15px;
            margin-bottom: 20px;
            border-radius: 8px;
            display: none;
        }

        .alert.success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .alert.error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        /* ====================== Responsive Design ========================== */
        @media (max-width: 991px) {
            .navigation {
                left: -300px;
            }

            .navigation.active {
                width: 300px;
                left: 0;
            }

            .main {
                width: 100%;
                left: 0;
            }

            .main.active {
                left: 300px;
            }

            .cardBox {
                grid-template-columns: repeat(2, 1fr);
            }
        }

        @media (max-width: 768px) {
            .details {
                grid-template-columns: 1fr;
            }

            .cardBox {
                grid-template-columns: repeat(2, 1fr);
            }
        }

        @media (max-width: 480px) {
            .cardBox {
                grid-template-columns: repeat(1, 1fr);
            }

            .navigation {
                width: 100%;
                left: -100%;
                z-index: 1000;
            }

            .navigation.active {
                width: 100%;
                left: 0;
            }

            .toggle {
                z-index: 10001;
            }

            .main.active .toggle {
                color: #fff;
                position: fixed;
                right: 0;
                left: initial;
            }
        }

        /* ============ Content Sections ============ */
        .content-section {
            display: none;
        }

        .content-section.active {
            display: block;
        }

        .restaurant-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 20px;
            padding: 20px;
        }

        .restaurant-card {
            background: var(--white);
            border-radius: 15px;
            padding: 20px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
            transition: all 0.3s ease;
        }

        .restaurant-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 15px 30px rgba(0, 0, 0, 0.15);
        }

        .restaurant-card h3 {
            color: var(--primary-color);
            margin-bottom: 10px;
        }

        .restaurant-card .info {
            color: var(--black2);
            margin-bottom: 15px;
        }

        .restaurant-card .actions {
            display: flex;
            gap: 10px;
        }

        .btn-sm {
            padding: 8px 15px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.3s ease;
        }

        .btn-edit {
            background: var(--primary-color);
            color: var(--white);
        }

        .btn-delete {
            background: var(--red);
            color: var(--white);
        }

        .btn-view {
            background: var(--green);
            color: var(--white);
        }

        .category-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 20px;
        }

        .category-card {
            background: var(--white);
            border-radius: 15px;
            padding: 20px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
            transition: all 0.3s ease;
        }

        .category-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 15px 30px rgba(0, 0, 0, 0.15);
        }

        .category-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .category-info {
            margin-bottom: 20px;
        }

        .category-info p {
            margin: 5px 0;
            color: var(--black2);
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .category-info .description {
            color: var(--black1);
            font-style: italic;
            margin: 10px 0;
        }

        .category-info .created-date {
            font-size: 0.9rem;
            color: var(--black2);
        }

        .category-actions {
            display: flex;
            gap: 8px;
            justify-content: flex-end;
        }

        .btn-warning {
            background: var(--orange);
            color: var(--white);
        }

        /* Estilos específicos para produtos */
        .product-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(350px, 1fr));
            gap: 20px;
        }

        .product-card {
            background: var(--white);
            border-radius: 15px;
            padding: 20px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
            transition: all 0.3s ease;
            position: relative;
        }

        .product-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 15px 30px rgba(0, 0, 0, 0.15);
        }

        .product-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 15px;
        }

        .product-title {
            flex: 1;
        }

        .product-title h3 {
            color: var(--primary-color);
            margin-bottom: 5px;
            font-size: 1.2rem;
        }

        .product-category {
            color: var(--black2);
            font-size: 0.9rem;
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .product-status-badges {
            display: flex;
            flex-direction: column;
            gap: 5px;
            align-items: flex-end;
        }

        .product-price {
            background: var(--light-color);
            padding: 15px;
            border-radius: 10px;
            margin: 15px 0;
        }

        .price-regular {
            font-size: 1.1rem;
            font-weight: 600;
            color: var(--dark-color);
        }

        .price-promotion {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-top: 5px;
        }

        .price-current {
            font-size: 1.3rem;
            font-weight: 700;
            color: var(--primary-color);
        }

        .price-old {
            text-decoration: line-through;
            color: var(--black2);
            font-size: 0.9rem;
        }

        .discount-badge {
            background: var(--red);
            color: white;
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 0.8rem;
            font-weight: 600;
        }

        .product-description {
            color: var(--black1);
            font-size: 0.9rem;
            margin: 10px 0;
            line-height: 1.4;
        }

        .product-meta {
            margin: 15px 0;
            color: var(--black2);
            font-size: 0.9rem;
        }

        .product-meta p {
            margin: 5px 0;
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .product-actions {
            display: flex;
            gap: 8px;
            justify-content: flex-end;
            margin-top: 15px;
        }

        .status.available {
            background: var(--green);
            color: var(--white);
        }

        .status.unavailable {
            background: var(--red);
            color: var(--white);
        }

        .status.promotion {
            background: var(--orange);
            color: var(--white);
        }

        .filters-bar .filter-group {
            display: flex;
            flex-direction: column;
            gap: 5px;
        }

        .filters-bar label {
            font-size: 0.9rem;
            font-weight: 500;
            color: var(--dark-color);
        }

        /* Responsive adjustments */
        @media (max-width: 768px) {
            .product-grid {
                grid-template-columns: 1fr;
            }

            .filters-bar>div {
                flex-direction: column;
                align-items: stretch;
            }

            .filter-group {
                width: 100%;
            }
        }

        /* ============ Modal Styles for Profile/Password ============ */
        .profile-modal {
            display: none;
            position: fixed;
            z-index: 2000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
        }

        .profile-modal-content {
            background-color: var(--white);
            margin: 5% auto;
            padding: 30px;
            border-radius: 15px;
            width: 90%;
            max-width: 500px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.3);
        }

        .logout-confirmation {
            text-align: center;
            padding: 20px;
        }

        .logout-confirmation h3 {
            color: var(--primary-color);
            margin-bottom: 15px;
        }

        .logout-confirmation p {
            margin-bottom: 25px;
            color: var(--dark-color);
        }

        .logout-buttons {
            display: flex;
            gap: 15px;
            justify-content: center;
        }

        .btn-logout-confirm {
            background: var(--red);
            color: var(--white);
            padding: 10px 25px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s ease;
        }

        .btn-logout-confirm:hover {
            background: #d32f2f;
            transform: translateY(-2px);
        }

        .btn-logout-cancel {
            background: var(--black2);
            color: var(--white);
            padding: 10px 25px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s ease;
        }

        .btn-logout-cancel:hover {
            background: var(--black1);
        }

        /* Estilos para utilizadores */
        .user-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(350px, 1fr));
            gap: 20px;
        }

        .user-card {
            background: var(--white);
            border-radius: 15px;
            padding: 20px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
            transition: all 0.3s ease;
            position: relative;
        }

        .user-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 15px 30px rgba(0, 0, 0, 0.15);
        }

        .user-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 15px;
        }

        .user-title h3 {
            color: var(--primary-color);
            margin-bottom: 5px;
            font-size: 1.2rem;
        }

        .user-email {
            color: var(--black2);
            font-size: 0.9rem;
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .user-info {
            margin: 15px 0;
        }

        .user-info p {
            margin: 5px 0;
            color: var(--black2);
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .user-role {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 0.8rem;
            font-weight: 600;
            margin: 5px 0;
        }

        .user-role.super-admin {
            background: var(--red);
            color: white;
        }

        .user-role.restaurant-user {
            background: var(--green);
            color: white;
        }

        .user-actions {
            display: flex;
            gap: 8px;
            justify-content: flex-end;
            margin-top: 15px;
        }

        .last-login {
            font-size: 0.8rem;
            color: var(--black2);
            font-style: italic;
        }

        /* Loading screen inicial */
        .initial-loading {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: var(--white);
            z-index: 9999;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
        }

        .initial-loading .spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid var(--primary-color);
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
            margin-bottom: 20px;
        }

        .initial-loading h3 {
            color: var(--primary-color);
            margin-bottom: 10px;
        }

        .initial-loading p {
            color: var(--black2);
        }

        /* Ocultar conteúdo até carregar */
        .main.loading {
            visibility: hidden;
        }

        /* ============ Controle de visibilidade por role ============ */
        /* Ocultar elementos por role via CSS para evitar flash */
        body[data-user-role="restaurant_user"] .nav-item[data-section="users"],
        body[data-user-role="restaurant_user"] .nav-item[data-section="restaurants"],
        body[data-user-role="restaurant_user"] .nav-item[data-section="menu"],
        body[data-user-role="restaurant_user"] .nav-item[data-section="api"],
        body[data-user-role="restaurant_user"] a[onclick*="health"] {
            display: none !important;
        }

        /* Ocultar cards específicos para restaurant_user */
        body[data-user-role="restaurant_user"] #restaurantCount,
        body[data-user-role="restaurant_user"] #userCount {
            display: none !important;
        }

        /* Ajustar grid de cards para restaurant_user */
        body[data-user-role="restaurant_user"] .cardBox {
            grid-template-columns: repeat(2, 1fr) !important;
        }

        /* Loading indicator para stats */
        .stat-loading {
            font-size: 1.5rem;
            color: var(--black2);
            animation: pulse 1.5s ease-in-out infinite;
        }

        @keyframes pulse {
            0% {
                opacity: 0.6;
            }

            50% {
                opacity: 1;
            }

            100% {
                opacity: 0.6;
            }
        }

        /* Transições suaves para stats */
        .numbers {
            transition: opacity 0.3s ease;
        }

        < !-- 5. ESTILOS CSS ADICIONAIS (adicionar no <style>) --><style>

        /* Estilos para a seção de mesas */
        .table-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(320px, 1fr));
            gap: 20px;
        }

        .table-card {
            background: var(--white);
            border-radius: 15px;
            padding: 20px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }

        .table-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 15px 30px rgba(0, 0, 0, 0.15);
        }

        .table-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 15px;
        }

        .table-number {
            font-size: 2rem;
            font-weight: 700;
            color: var(--primary-color);
            line-height: 1;
        }

        .table-status {
            display: flex;
            flex-direction: column;
            gap: 5px;
            align-items: flex-end;
        }

        .table-info {
            margin: 15px 0;
        }

        .table-info p {
            margin: 8px 0;
            color: var(--black2);
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .table-name {
            font-weight: 600;
            color: var(--dark-color);
            font-size: 1.1rem;
            margin-bottom: 5px;
        }

        .table-actions {
            display: flex;
            gap: 8px;
            justify-content: flex-end;
            margin-top: 15px;
            flex-wrap: wrap;
        }

        .qr-indicator {
            display: inline-flex;
            align-items: center;
            gap: 5px;
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 0.8rem;
            font-weight: 600;
        }

        .qr-indicator.has-qr {
            background: var(--success);
            color: white;
        }

        .qr-indicator.no-qr {
            background: var(--black2);
            color: white;
        }

        /* Estilos para QR Manager */
        .qr-tabs {
            display: flex;
            margin-bottom: 20px;
        }

        .qr-tab {
            flex: 1;
            padding: 12px 20px;
            border: none;
            background: var(--gray);
            color: var(--dark-color);
            cursor: pointer;
            transition: all 0.3s ease;
            border-bottom: 3px solid transparent;
        }

        .qr-tab.active {
            background: var(--primary-color);
            color: var(--white);
            border-bottom-color: var(--secondary-color);
        }

        .qr-tab:hover:not(.active) {
            background: var(--light-color);
        }

        .qr-tab-content {
            display: none;
        }

        .qr-tab-content.active {
            display: block;
        }

        .qr-preview-container {
            background: var(--gray);
            padding: 30px;
            border-radius: 10px;
            text-align: center;
        }

        .qr-preview-container img {
            max-width: 100%;
            border: 2px solid var(--white);
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }

        .table-checkbox-item {
            display: flex;
            /* align-items: center; */
            padding: 8px;
            border-bottom: 1px solid #f0f0f0;
            flex-direction: column;
        }

        .table-checkbox-item:last-child {
            border-bottom: none;
        }

        .table-checkbox-item label {
            margin-left: 10px;
            cursor: pointer;
            flex: 1;
        }

        .qr-batch-result {
            background: var(--gray);
            padding: 15px;
            border-radius: 8px;
            margin: 10px 0;
        }

        .qr-batch-success {
            border-left: 4px solid var(--success);
        }

        .qr-batch-error {
            border-left: 4px solid var(--error);
        }

        /* Responsive */
        @media (max-width: 768px) {
            .table-grid {
                grid-template-columns: 1fr;
            }

            .table-actions {
                justify-content: center;
            }

            .qr-tabs {
                flex-direction: column;
            }
        }
    </style>


    <!-- Estilos CSS para organizar -->
    <style>
        .print-section {
            margin-bottom: 12px;
            padding: 6px;
            background: #f8f9fa;
            border-radius: 10px;
            border-left: 4px solid var(--primary-color);
        }

        .section-title {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 15px;
            color: var(--primary-color);
            font-size: 1.1rem;
            font-weight: 600;
        }

        .radio-group {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .radio-option {
            display: flex;
            align-items: center;
            padding: 12px;
            background: white;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .radio-option:hover {
            border-color: var(--primary-color);
            transform: translateY(-1px);
        }

        .radio-option input[type="radio"]:checked+.radio-content {
            color: var(--primary-color);
        }

        .radio-option input[type="radio"]:checked {
            accent-color: var(--primary-color);
        }

        .radio-content {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-left: 10px;
        }

        .radio-content ion-icon {
            font-size: 1.3rem;
            color: var(--black2);
        }

        .radio-content strong {
            display: block;
            margin-bottom: 2px;
        }

        .radio-content small {
            color: var(--black2);
            font-size: 0.85rem;
        }

        .input-group {
            margin-top: 15px;
            padding: 15px;
            background: white;
            border-radius: 8px;
            border: 1px solid #e0e0e0;
        }

        .input-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
            color: var(--black1);
        }

        .table-input {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: 14px;
        }

        .table-input:focus {
            outline: none;
            border-color: var(--primary-color);
        }

        .input-group small {
            display: block;
            margin-top: 5px;
            color: var(--black2);
            font-size: 0.8rem;
        }

        .info-card {
            background: white;
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            padding: 20px;
        }

        .info-header {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 12px;
            color: var(--primary-color);
        }

        .info-list {
            margin: 10px 0;
            padding-left: 20px;
        }

        .info-list li {
            margin-bottom: 5px;
            color: var(--black1);
        }

        .action-section {
            text-align: center;
            padding: 25px 0;
        }

        .btn-large {
            padding: 15px 40px;
            font-size: 1.1rem;
            min-width: 250px;
        }

        .btn-large ion-icon {
            font-size: 1.3rem;
            margin-right: 10px;
        }

        /* Responsivo */
        @media (max-width: 768px) {
            .print-section {
                margin-bottom: 20px;
                padding: 15px;
            }

            .btn-large {
                width: 100%;
                min-width: auto;
            }
        }

        /* CSS para scroll no modal */
        .modal-content {
            overflow: hidden !important;
        }

        .tab-content-scroll {
            max-height: calc(90vh - 200px);
            overflow-y: auto;
            padding-right: 10px;
        }

        .tab-content-scroll::-webkit-scrollbar {
            width: 6px;
        }

        .tab-content-scroll::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 3px;
        }

        .tab-content-scroll::-webkit-scrollbar-thumb {
            background: var(--primary-color);
            border-radius: 3px;
        }

        .tab-content-scroll::-webkit-scrollbar-thumb:hover {
            background: var(--secondary-color);
        }

        /* Responsivo */
        @media (max-width: 768px) {
            .modal-content {
                max-height: 95vh !important;
                margin: 2.5% auto !important;
            }

            .tab-content-scroll {
                max-height: calc(95vh - 150px);
            }
        }
/* ================ ESTILOS MELHORADOS PARA MODAL DE NOVO PEDIDO ================ */

/* Modal principal */
#newOrderModal .modal-content {
    max-width: 1000px !important;
    max-height: 95vh !important;
    height: 90vh !important;
    overflow: hidden !important;
    display: flex !important;
    flex-direction: column !important;
    padding: 0 !important;
}

/* Header do modal */
.new-order-header {
    padding: 20px 30px;
    border-bottom: 2px solid var(--primary-color);
    background: linear-gradient(135deg, #FF5722, #FF7043);
    color: white;
    border-radius: 20px 20px 0 0;
    position: relative;
}

.new-order-header h2 {
    margin: 0;
    color: white;
}

.new-order-header .close {
    color: white;
    top: 15px;
    right: 20px;
}

.new-order-header .close:hover {
    background: rgba(255,255,255,0.2);
}

/* Área scrollável do conteúdo */
.new-order-content {
    flex: 1;
    overflow-y: auto;
    padding: 20px 30px;
}

/* Footer fixo */
.new-order-footer {
    padding: 20px 30px;
    border-top: 1px solid #eee;
    background: #f8f9fa;
    border-radius: 0 0 20px 20px;
}

/* Seção de dados do cliente */
.customer-section {
    background: linear-gradient(135deg, #f8f9fa, #e3f2fd);
    padding: 20px;
    border-radius: 15px;
    margin-bottom: 25px;
    border-left: 4px solid var(--primary-color);
}

.customer-section h3 {
    margin-bottom: 15px;
    color: var(--primary-color);
    display: flex;
    align-items: center;
    gap: 8px;
}

/* Grid de produtos e carrinho */
.products-cart-grid {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 25px;
    height: 500px; /* Altura fixa */
}

/* Seção de produtos */
.products-section {
    display: flex;
    flex-direction: column;
    border: 2px solid #e0e0e0;
    border-radius: 15px;
    overflow: hidden;
}

.products-header {
    background: var(--primary-color);
    color: white;
    padding: 15px 20px;
    font-weight: 600;
    display: flex;
    align-items: center;
    gap: 8px;
}

.products-filter {
    padding: 15px 20px;
    background: #f8f9fa;
    border-bottom: 1px solid #e0e0e0;
}

.products-filter select {
    width: 100%;
    padding: 8px 12px;
    border: 1px solid #ddd;
    border-radius: 8px;
    background: white;
}

.products-list {
    flex: 1;
    overflow-y: auto;
    background: white;
}

/* Seção do carrinho */
.cart-section {
    display: flex;
    flex-direction: column;
    border: 2px solid #e0e0e0;
    border-radius: 15px;
    overflow: hidden;
}

.cart-header {
    background: var(--green);
    color: white;
    padding: 15px 20px;
    font-weight: 600;
    display: flex;
    align-items: center;
    gap: 8px;
}

.cart-content {
    flex: 1;
    display: flex;
    flex-direction: column;
    background: white;
}

.cart-items {
    flex: 1;
    overflow-y: auto;
    padding: 15px;
    min-height: 200px;
}

.cart-summary {
    background: linear-gradient(135deg, #f8f9fa, #e8f5e8);
    border-top: 2px solid var(--green);
    padding: 15px;
}

/* Itens de produto */
.order-product-item {
    padding: 15px;
    border-bottom: 1px solid #f0f0f0;
    transition: all 0.3s ease;
    cursor: pointer;
}

.order-product-item:hover {
    background: linear-gradient(135deg, #fff3e0, #ffebee);
    transform: translateY(-1px);
    box-shadow: 0 2px 8px rgba(0,0,0,0.1);
}

.order-product-item:last-child {
    border-bottom: none;
}

.product-item-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 8px;
}

.product-item-name {
    font-weight: 600;
    color: var(--dark-color);
    font-size: 1rem;
}

.product-item-price {
    font-weight: 700;
    color: var(--primary-color);
    font-size: 1.1rem;
}

.product-item-description {
    font-size: 0.9rem;
    color: var(--black2);
    margin-bottom: 10px;
    line-height: 1.4;
}

.add-product-btn {
    background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
    color: white;
    border: none;
    padding: 8px 16px;
    border-radius: 8px;
    cursor: pointer;
    font-size: 0.9rem;
    font-weight: 600;
    transition: all 0.3s ease;
    display: flex;
    align-items: center;
    gap: 5px;
    box-shadow: 0 2px 6px rgba(255, 87, 34, 0.3);
}

.add-product-btn:hover {
    background: linear-gradient(135deg, var(--secondary-color), #E64A19);
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(255, 87, 34, 0.4);
}

/* Itens do carrinho */
.cart-item {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 12px 0;
    border-bottom: 1px solid #f0f0f0;
    animation: slideIn 0.3s ease;
}

@keyframes slideIn {
    from { opacity: 0; transform: translateX(-20px); }
    to { opacity: 1; transform: translateX(0); }
}

.cart-item:last-child {
    border-bottom: none;
}

.cart-item-info {
    flex: 1;
}

.cart-item-name {
    font-weight: 600;
    margin-bottom: 3px;
    color: var(--dark-color);
}

.cart-item-price {
    font-size: 0.9rem;
    color: var(--black2);
}

.cart-item-controls {
    display: flex;
    align-items: center;
    gap: 12px;
}

.quantity-control-simple {
    display: flex;
    align-items: center;
    gap: 10px;
    background: #f8f9fa;
    padding: 4px 8px;
    border-radius: 20px;
}

.quantity-btn-simple {
    width: 28px;
    height: 28px;
    border: none;
    border-radius: 50%;
    background: var(--primary-color);
    color: white;
    font-size: 1rem;
    font-weight: 600;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: all 0.3s ease;
}

.quantity-btn-simple:hover:not(:disabled) {
    background: var(--secondary-color);
    transform: scale(1.1);
}

.quantity-btn-simple:disabled {
    background: #ccc;
    cursor: not-allowed;
    transform: none;
}

.quantity-btn-simple.remove-all {
    background: var(--red);
    margin-left: 8px;
}

.quantity-btn-simple.remove-all:hover {
    background: #d32f2f;
}

.quantity-display-simple {
    min-width: 24px;
    text-align: center;
    font-weight: 600;
    font-size: 1rem;
}

/* Estados especiais */
.empty-state {
    text-align: center;
    padding: 40px 20px;
    color: #666;
}

.empty-state ion-icon {
    font-size: 3rem;
    margin-bottom: 15px;
    opacity: 0.5;
}

/* Resumo do carrinho */
.cart-summary-content {
    display: flex;
    flex-direction: column;
    gap: 10px;
}

.cart-summary-row {
    display: flex;
    justify-content: space-between;
    align-items: center;
}

.cart-summary-row.total {
    font-size: 1.3rem;
    font-weight: 700;
    color: var(--green);
    padding-top: 10px;
    border-top: 2px solid var(--green);
}

/* Responsivo */
@media (max-width: 1024px) {
    #newOrderModal .modal-content {
        max-width: 95% !important;
        height: 95vh !important;
    }
    
    .products-cart-grid {
        grid-template-columns: 1fr;
        height: auto;
        gap: 20px;
    }
    
    .products-section,
    .cart-section {
        height: 350px;
    }
}

@media (max-width: 768px) {
    .new-order-content {
        padding: 15px;
    }
    
    .customer-section {
        padding: 15px;
    }
    
    .new-order-header,
    .new-order-footer {
        padding: 15px 20px;
    }
}
    </style>
</head>

<body>
    <!-- Loading screen inicial -->
    <div class="initial-loading" id="initialLoading">
        <div class="spinner"></div>
        <h3>Carregando Dados...</h3>
        <p>Preparando sua área de trabalho</p>
    </div>
    <!-- =============== Navigation ================ -->
    <div class="container">
        <div class="navigation">
            <ul>
                <li>
                    <a href="#">
                        <span class="icon">
                            <ion-icon name="restaurant-outline"></ion-icon>
                        </span>
                        <span class="title">Manna Software</span>
                    </a>
                </li>

                <li class="nav-item hovered" data-section="dashboard" onclick="loadStatsInBackground();">
                    <a href="#">
                        <span class="icon">
                            <ion-icon name="home-outline"></ion-icon>
                        </span>
                        <span class="title">Dashboard</span>
                    </a>
                </li>

                <li class="nav-item" data-section="orders">
                    <a href="#">
                        <span class="icon">
                            <ion-icon name="receipt-outline"></ion-icon>
                        </span>
                        <span class="title">Pedidos</span>
                    </a>
                </li>

                <li class="nav-item" data-section="restaurants">
                    <a href="#">
                        <span class="icon">
                            <ion-icon name="storefront-outline"></ion-icon>
                        </span>
                        <span class="title">Restaurantes</span>
                    </a>
                </li>

                <li class="nav-item" data-section="categories">
                    <a href="#">
                        <span class="icon">
                            <ion-icon name="pricetags-outline"></ion-icon>
                        </span>
                        <span class="title">Categorias</span>
                    </a>
                </li>

                <li class="nav-item" data-section="products">
                    <a href="#">
                        <span class="icon">
                            <ion-icon name="fast-food-outline"></ion-icon>
                        </span>
                        <span class="title">Produtos</span>
                    </a>
                </li>

                <li class="nav-item" data-section="tables">
                    <a href="#">
                        <span class="icon">
                            <ion-icon name="grid-outline"></ion-icon>
                        </span>
                        <span class="title">Mesas</span>
                    </a>
                </li>

                <li class="nav-item" data-section="users" onclick="loadUsers()">
                    <a href="#">
                        <span class="icon">
                            <ion-icon name="people-outline"></ion-icon>
                        </span>
                        <span class="title">Utilizadores</span>
                    </a>
                </li>

                <li class="nav-item" data-section="menu">
                    <a href="#">
                        <span class="icon">
                            <ion-icon name="list-outline"></ion-icon>
                        </span>
                        <span class="title">Menu Preview</span>
                    </a>
                </li>

                <li class="nav-item" data-section="api">
                    <a href="#">
                        <span class="icon">
                            <ion-icon name="code-outline"></ion-icon>
                        </span>
                        <span class="title">API Docs</span>
                    </a>
                </li>

                <!-- <li class="nav-item" onclick="showProfile()">
                    <a href="#">
                        <span class="icon">
                            <ion-icon name="person-outline"></ion-icon>
                        </span>
                        <span class="title">Meu Perfil</span>
                    </a>
                </li> -->

                <li>
                    <a href="#" onclick="window.open(apiBaseUrl + '/health', '_blank')">
                        <span class="icon">
                            <ion-icon name="settings-outline"></ion-icon>
                        </span>
                        <span class="title">Health Check</span>
                    </a>
                </li>

                <li class="nav-item">
                    <a href="#" onclick="performLogout()">
                        <span class="icon">
                            <ion-icon name="exit"></ion-icon>
                        </span>
                        <span class="title">Logout</span>
                    </a>
                </li>
            </ul>


        </div>

        <!-- ========================= Main ==================== -->
        <div class="main loading">
            <div class="topbar">
                <div class="toggle">
                    <ion-icon name="menu-outline"></ion-icon>
                </div>

                <div class="search">
                    <label>
                        <input type="text" placeholder="Buscar..." id="searchInput">
                        <ion-icon name="search-outline"></ion-icon>
                    </label>
                </div>

                <div class="user">
                    <ion-icon name="person-outline"></ion-icon>
                </div>
            </div>

            <!-- Loading Indicator -->
            <div class="loading" id="loading">
                <div class="spinner"></div>
                <p>Carregando dados...</p>
            </div>

            <!-- Alert Messages -->
            <div class="alert success" id="successAlert"></div>
            <div class="alert error" id="errorAlert"></div>

            <!-- ======================= Dashboard Section ================== -->
            <div class="content-section active" id="dashboard">
                <!-- ======================= Cards ================== -->
                <div class="cardBox">
                    <div class="card">
                        <div>
                            <div class="numbers" id="restaurantCount">0</div>
                            <div class="cardName">Restaurantes</div>
                        </div>
                        <div class="iconBx">
                            <ion-icon name="storefront-outline"></ion-icon>
                        </div>
                    </div>

                    <div class="card">
                        <div>
                            <div class="numbers" id="orderCount">0</div>
                            <div class="cardName">Pedidos Hoje</div>
                        </div>
                        <div class="iconBx">
                            <ion-icon name="receipt-outline"></ion-icon>
                        </div>
                    </div>

                    <div class="card">
                        <div>
                            <div class="numbers" id="categoryCount">0</div>
                            <div class="cardName">Categorias</div>
                        </div>
                        <div class="iconBx">
                            <ion-icon name="pricetags-outline"></ion-icon>
                        </div>
                    </div>

                    <div class="card">
                        <div>
                            <div class="numbers" id="productCount">0</div>
                            <div class="cardName">Produtos</div>
                        </div>
                        <div class="iconBx">
                            <ion-icon name="fast-food-outline"></ion-icon>
                        </div>
                    </div>

                    <div class="card">
                        <div>
                            <div class="numbers" id="promotionCount">0</div>
                            <div class="cardName">Promoções</div>
                        </div>
                        <div class="iconBx">
                            <ion-icon name="pricetag-outline"></ion-icon>
                        </div>
                    </div>

                    <div class="card">
                        <div>
                            <div class="numbers" id="tableCount">0</div>
                            <div class="cardName">Mesas</div>
                        </div>
                        <div class="iconBx">
                            <ion-icon name="grid-outline"></ion-icon>
                        </div>
                    </div>

                    <div class="card">
                        <div>
                            <div class="numbers" id="userCount">0</div>
                            <div class="cardName">Utilizadores</div>
                        </div>
                        <div class="iconBx">
                            <ion-icon name="people-outline"></ion-icon>
                        </div>
                    </div>
                </div>

                <!-- ================ Recent Data ================= -->
                <div class="details">
                    <div class="recentOrders">
                        <div class="cardHeader">
                            <h2>Restaurantes Recentes</h2>
                            <button class="btn" onclick="showSection('restaurants')">Ver Todos</button>
                        </div>
                        <table>
                            <thead>
                                <tr>
                                    <td>Nome</td>
                                    <td>Cidade</td>
                                    <td>Status</td>
                                    <td>Ações</td>
                                </tr>
                            </thead>
                            <tbody id="recentRestaurants">
                                <!-- Populated by JavaScript -->
                            </tbody>
                        </table>
                    </div>

                    <!-- ================= Quick Actions ================ -->
                    <div class="recentCustomers">
                        <div class="cardHeader">
                            <h2>Ações Rápidas</h2>
                        </div>
                        <div style="padding: 20px 0;">
                            <button class="btn-primary" style="width: 100%; margin-bottom: 15px;"
                                onclick="openModal('restaurant')">
                                <ion-icon name="add-outline" style="margin-right: 8px;"></ion-icon>
                                Novo Restaurante
                            </button>
                            <button class="btn-primary" style="width: 100%; margin-bottom: 15px;"
                                onclick="openModal('category')">
                                <ion-icon name="add-outline" style="margin-right: 8px;"></ion-icon>
                                Nova Categoria
                            </button>
                            <button class="btn-primary" style="width: 100%; margin-bottom: 15px;"
                                onclick="openModal('product')">
                                <ion-icon name="add-outline" style="margin-right: 8px;"></ion-icon>
                                Novo Produto
                            </button>
                            <button class="btn-secondary" style="width: 100%;" onclick="refreshData()">
                                <ion-icon name="refresh-outline" style="margin-right: 8px;"></ion-icon>
                                Atualizar Dados
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- ======================= Restaurants Section ================== -->
            <div class="content-section" id="restaurants">
                <div style="padding: 20px;">
                    <div class="cardHeader" style="margin-bottom: 30px;">
                        <h2>Gestão de Restaurantes</h2>
                        <button class="btn" onclick="openModal('restaurant')">
                            <ion-icon name="add-outline" style="margin-right: 8px;"></ion-icon>
                            Novo Restaurante
                        </button>
                    </div>
                    <div class="restaurant-grid" id="restaurantGrid">
                        <!-- Populated by JavaScript -->
                    </div>
                </div>
            </div>

            <!-- ======================= Orders Section ================== -->
             <div class="content-section" id="orders">
    <div style="padding: 20px;">
       <div class="cardHeader" style="margin-bottom: 30px;">
    <h2>Gestão de Pedidos</h2>
    <div style="display: flex; gap: 10px;">
        <button class="btn" onclick="openNewOrderModal()">
            <ion-icon name="add-outline" style="margin-right: 8px;"></ion-icon>
            Novo Pedido
        </button>
        <button class="btn" onclick="showKitchenView()">
            <ion-icon name="restaurant-outline" style="margin-right: 8px;"></ion-icon>
            Visão Cozinha
        </button>
        <button class="btn-secondary" onclick="refreshOrders()">
            <ion-icon name="refresh-outline" style="margin-right: 8px;"></ion-icon>
            Atualizar
        </button>
    </div>
</div>

        <!-- Status Cards -->
        <div class="order-status-cards" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 15px; margin-bottom: 30px;">
            <div class="status-card pending">
                <div class="status-number" id="pendingCount">0</div>
                <div class="status-label">Pendentes</div>
            </div>
            <div class="status-card confirmed">
                <div class="status-number" id="confirmedCount">0</div>
                <div class="status-label">Confirmados</div>
            </div>
            <div class="status-card preparing">
                <div class="status-number" id="preparingCount">0</div>
                <div class="status-label">Preparando</div>
            </div>
            <div class="status-card ready">
                <div class="status-number" id="readyCount">0</div>
                <div class="status-label">Prontos</div>
            </div>
        </div>

        <!-- Filtros -->
        <div class="filters-bar" style="background: var(--white); padding: 20px; border-radius: 10px; margin-bottom: 20px; box-shadow: 0 2px 10px rgba(0,0,0,0.1);">
            <div style="display: flex; gap: 15px; align-items: center; flex-wrap: wrap;">
                <div class="filter-group">
                    <label>Status:</label>
                    <select id="orderStatusFilter" style="padding: 8px 12px; border: 1px solid var(--black2); border-radius: 5px;">
                        <option value="">Todos</option>
                        <option value="pending">Pendente</option>
                        <option value="confirmed">Confirmado</option>
                        <option value="preparing">Preparando</option>
                        <option value="ready">Pronto</option>
                        <option value="delivered">Entregue</option>
                        <option value="cancelled">Cancelado</option>
                    </select>
                </div>
                <div class="filter-group">
                    <label>Mesa:</label>
                    <select id="orderTableFilter" style="padding: 8px 12px; border: 1px solid var(--black2); border-radius: 5px;">
                        <option value="">Todas</option>
                    </select>
                </div>
                <div class="filter-group">
                    <label>Período:</label>
                    <select id="orderPeriodFilter" style="padding: 8px 12px; border: 1px solid var(--black2); border-radius: 5px;">
                        <option value="today">Hoje</option>
                        <option value="week">Esta Semana</option>
                        <option value="month">Este Mês</option>
                    </select>
                </div>
                <button class="btn-secondary" onclick="clearOrderFilters()" style="padding: 8px 15px;">
                    <ion-icon name="refresh-outline"></ion-icon>
                    Limpar
                </button>
            </div>
        </div>

        <!-- Lista de Pedidos -->
        <div class="orders-container" id="ordersContainer">
            <!-- Orders will be loaded here -->
        </div>
    </div>
</div>

            <!-- ======================= Other Sections ================== -->
            <!-- No dashboard.html, atualize a seção de categorias para incluir filtros -->
            <div class="content-section" id="categories">
                <div style="padding: 20px;">
                    <div class="cardHeader" style="margin-bottom: 30px;">
                        <h2>Gestão de Categorias</h2>
                        <button class="btn" onclick="openModal('category')">
                            <ion-icon name="add-outline" style="margin-right: 8px;"></ion-icon>
                            Nova Categoria
                        </button>
                    </div>

                    <!-- Filtros -->
                    <div class="filters-bar"
                        style="background: var(--white); padding: 20px; border-radius: 10px; margin-bottom: 20px; box-shadow: 0 2px 10px rgba(0,0,0,0.1);">
                        <div style="display: flex; gap: 15px; align-items: center; flex-wrap: wrap;">
                            <div class="filter-group">
                                <label>Buscar:</label>
                                <input type="text" id="categorySearch" placeholder="Nome da categoria..."
                                    style="padding: 8px 12px; border: 1px solid var(--black2); border-radius: 5px;">
                            </div>
                            <div class="filter-group">
                                <label>Restaurante:</label>
                                <select id="categoryRestaurantFilter"
                                    style="padding: 8px 12px; border: 1px solid var(--black2); border-radius: 5px;">
                                    <option value="">Todos</option>
                                </select>
                            </div>
                            <div class="filter-group">
                                <label>Status:</label>
                                <select id="categoryStatusFilter"
                                    style="padding: 8px 12px; border: 1px solid var(--black2); border-radius: 5px;">
                                    <option value="">Todos</option>
                                    <option value="true">Ativo</option>
                                    <option value="false">Inativo</option>
                                </select>
                            </div>
                            <button class="btn-secondary" onclick="clearCategoryFilters()" style="padding: 8px 15px;">
                                <ion-icon name="refresh-outline"></ion-icon>
                                Limpar
                            </button>
                        </div>
                    </div>

                    <div class="category-grid" id="categoryGrid">
                        <!-- Categories will be loaded here -->
                    </div>
                </div>
            </div>

            <div class="content-section" id="products">
                <div style="padding: 20px;">
                    <div class="cardHeader" style="margin-bottom: 30px;">
                        <h2>Gestão de Produtos</h2>
                        <button class="btn" onclick="openModal('product')">
                            <ion-icon name="add-outline" style="margin-right: 8px;"></ion-icon>
                            Novo Produto
                        </button>
                    </div>

                    <!-- Filtros -->
                    <div class="filters-bar"
                        style="background: var(--white); padding: 20px; border-radius: 10px; margin-bottom: 20px; box-shadow: 0 2px 10px rgba(0,0,0,0.1);">
                        <div style="display: flex; gap: 15px; align-items: center; flex-wrap: wrap;">
                            <div class="filter-group">
                                <label>Buscar:</label>
                                <input type="text" id="productSearch" placeholder="Nome do produto..."
                                    style="padding: 8px 12px; border: 1px solid var(--black2); border-radius: 5px;">
                            </div>
                            <div class="filter-group">
                                <label>Categoria:</label>
                                <select id="productCategoryFilter"
                                    style="padding: 8px 12px; border: 1px solid var(--black2); border-radius: 5px;">
                                    <option value="">Todas</option>
                                </select>
                            </div>
                            <div class="filter-group">
                                <label>Restaurante:</label>
                                <select id="productRestaurantFilter"
                                    style="padding: 8px 12px; border: 1px solid var(--black2); border-radius: 5px;">
                                    <option value="">Todos</option>
                                </select>
                            </div>
                            <div class="filter-group">
                                <label>Status:</label>
                                <select id="productStatusFilter"
                                    style="padding: 8px 12px; border: 1px solid var(--black2); border-radius: 5px;">
                                    <option value="">Todos</option>
                                    <option value="true">Disponível</option>
                                    <option value="false">Indisponível</option>
                                </select>
                            </div>
                            <div class="filter-group">
                                <label>Promoção:</label>
                                <select id="productPromotionFilter"
                                    style="padding: 8px 12px; border: 1px solid var(--black2); border-radius: 5px;">
                                    <option value="">Todos</option>
                                    <option value="true">Em Promoção</option>
                                    <option value="false">Preço Normal</option>
                                </select>
                            </div>

                            <div class="pagination-container filter-group" id="productPagination" style="display: none; text-align: center; padding: 20px ;">
    <div style="display: inline-flex; align-items: center; gap: 0px; background: white;">
        <button id="prevProductPage" class="btn-secondary" onclick="loadPreviousProductPage()" style="padding: 8px 15px;" disabled>
            <ion-icon name="chevron-back-outline"></ion-icon>
            Anterior
        </button>
        
        <div style="display: flex; align-items: center; gap: 10px; padding: 8px 15px;">
            <span>Página</span>
            <span id="currentProductPage" style="font-weight: 600; color: var(--primary-color);">1</span>
            <span>de</span>
            <span id="totalProductPages" style="font-weight: 600;">1</span>
        </div>
        
        <div style="font-size: 0.9rem; color: var(--black2); padding: 8px 15px;">
            <span id="productCount">0</span> produtos • 
            <span id="productRange">0-0</span>
        </div>
        
        <button id="nextProductPage" class="btn-secondary" onclick="loadNextProductPage()" disabled style="padding: 8px 15px;">
            Próxima
            <ion-icon name="chevron-forward-outline"></ion-icon>
        </button>
    </div>
</div>
                            <button class="btn-secondary" onclick="clearProductFilters()" style="padding: 8px 15px;">
                                <ion-icon name="refresh-outline"></ion-icon>
                                Limpar
                            </button>
                        </div>
                    </div>

                    <!-- Paginação melhorada -->


                    <!-- Grid de Produtos -->
                    <div class="product-grid" id="productGrid">
                        <!-- Products will be loaded here -->
                    </div>
                </div>
            </div>

            <div class="content-section" id="tables">
                <div style="padding: 20px;">
                    <div class="cardHeader" style="margin-bottom: 30px;">
                        <h2>Gestão de Mesas</h2>
                        <div style="display: flex; gap: 10px;">
                            <button class="btn" onclick="openModal('table')">
                                <ion-icon name="add-outline" style="margin-right: 8px;"></ion-icon>
                                Nova Mesa
                            </button>
                            <button class="btn-secondary" onclick="openBatchTableModal()">
                                <ion-icon name="copy-outline" style="margin-right: 8px;"></ion-icon>
                                Criar em Lote
                            </button>
                            <button class="btn-secondary" onclick="openQRManagerModal()">
                                <ion-icon name="qr-code-outline" style="margin-right: 8px;"></ion-icon>
                                QR Codes
                            </button>
                        </div>
                    </div>

                    <!-- Filtros -->
                    <div class="filters-bar"
                        style="background: var(--white); padding: 20px; border-radius: 10px; margin-bottom: 20px; box-shadow: 0 2px 10px rgba(0,0,0,0.1);">
                        <div style="display: flex; gap: 15px; align-items: center; flex-wrap: wrap;">
                            <div class="filter-group">
                                <label>Buscar:</label>
                                <input type="text" id="tableSearch" placeholder="Número ou nome..."
                                    style="padding: 8px 12px; border: 1px solid var(--black2); border-radius: 5px;">
                            </div>
                            <div class="filter-group">
                                <label>Restaurante:</label>
                                <select id="tableRestaurantFilter"
                                    style="padding: 8px 12px; border: 1px solid var(--black2); border-radius: 5px;">
                                    <option value="">Todos</option>
                                </select>
                            </div>
                            <div class="filter-group">
                                <label>Status:</label>
                                <select id="tableStatusFilter"
                                    style="padding: 8px 12px; border: 1px solid var(--black2); border-radius: 5px;">
                                    <option value="">Todos</option>
                                    <option value="true">Ativo</option>
                                    <option value="false">Inativo</option>
                                </select>
                            </div>
                            <div class="filter-group">
                                <label>QR Code:</label>
                                <select id="tableQRFilter"
                                    style="padding: 8px 12px; border: 1px solid var(--black2); border-radius: 5px;">
                                    <option value="">Todos</option>
                                    <option value="true">Com QR</option>
                                    <option value="false">Sem QR</option>
                                </select>
                            </div>
                            <button class="btn-secondary" onclick="clearTableFilters()" style="padding: 8px 15px;">
                                <ion-icon name="refresh-outline"></ion-icon>
                                Limpar
                            </button>
                        </div>
                    </div>

                    <!-- Grid de Mesas -->
                    <div class="table-grid" id="tableGrid">
                        <!-- Tables will be loaded here -->
                    </div>
                </div>
            </div>

            <div class="content-section" id="menu">
                <div style="padding: 20px;">
                    <h2 style="color: var(--primary-color); margin-bottom: 20px;">Preview do Menu</h2>
                    <p>Visualização do menu em desenvolvimento...</p>
                </div>
            </div>

            <div class="content-section" id="api">
                <div style="padding: 20px;">
                    <h2 style="color: var(--primary-color); margin-bottom: 20px;">Documentação da API</h2>
                    <div
                        style="background: var(--white); padding: 30px; border-radius: 15px; box-shadow: 0 5px 15px rgba(0,0,0,0.1);">
                        <h3>Endpoints Principais:</h3>
                        <ul style="margin: 20px 0; line-height: 2;">
                            <li><strong>GET</strong> /api/v1/restaurants - Listar restaurantes</li>
                            <li><strong>POST</strong> /api/v1/restaurants - Criar restaurante</li>
                            <li><strong>GET</strong> /api/v1/menu/restaurant/:id - Menu completo</li>
                            <li><strong>GET</strong> /api/v1/restaurants/stats - Estatísticas</li>
                        </ul>
                        <button class="btn-primary" onclick="window.open(apiBaseUrl, '_blank')">
                            Testar API
                        </button>
                    </div>
                </div>
            </div>

            <!-- Adicionar após as outras content-sections -->
            <div class="content-section" id="users">
                <div style="padding: 20px;">
                    <div class="cardHeader" style="margin-bottom: 30px;">
                        <h2>Gestão de Utilizadores</h2>
                        <button class="btn" onclick="openModal('user')">
                            <ion-icon name="add-outline" style="margin-right: 8px;"></ion-icon>
                            Novo Utilizador
                        </button>
                    </div>

                    <!-- Filtros -->
                    <div class="filters-bar"
                        style="background: var(--white); padding: 20px; border-radius: 10px; margin-bottom: 20px; box-shadow: 0 2px 10px rgba(0,0,0,0.1);">
                        <div style="display: flex; gap: 15px; align-items: center; flex-wrap: wrap;">
                            <div class="filter-group">
                                <label>Buscar:</label>
                                <input type="text" id="userSearch" placeholder="Nome ou email..."
                                    style="padding: 8px 12px; border: 1px solid var(--black2); border-radius: 5px;">
                            </div>
                            <div class="filter-group">
                                <label>Restaurante:</label>
                                <select id="userRestaurantFilter"
                                    style="padding: 8px 12px; border: 1px solid var(--black2); border-radius: 5px;">
                                    <option value="">Todos</option>
                                </select>
                            </div>
                            <div class="filter-group">
                                <label>Função:</label>
                                <select id="userRoleFilter"
                                    style="padding: 8px 12px; border: 1px solid var(--black2); border-radius: 5px;">
                                    <option value="">Todas</option>
                                    <option value="super_admin">Super Admin</option>
                                    <option value="restaurant_user">Utilizador</option>
                                </select>
                            </div>
                            <div class="filter-group">
                                <label>Status:</label>
                                <select id="userStatusFilter"
                                    style="padding: 8px 12px; border: 1px solid var(--black2); border-radius: 5px;">
                                    <option value="">Todos</option>
                                    <option value="true">Ativo</option>
                                    <option value="false">Inativo</option>
                                </select>
                            </div>
                            <button class="btn-secondary" onclick="clearUserFilters()" style="padding: 8px 15px;">
                                <ion-icon name="refresh-outline"></ion-icon>
                                Limpar
                            </button>
                        </div>
                    </div>

                    <div class="user-grid" id="userGrid">
                        <!-- Users will be loaded here -->
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- ======================= Modal ================== -->
    <div id="restaurantModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeModal('restaurant')">&times;</span>
            <h2 id="modalTitle">Novo Restaurante</h2>
            <form id="restaurantForm">
                <div class="form-group">
                    <label for="name">Nome do Restaurante *</label>
                    <input type="text" id="name" name="name" required>
                </div>
                <div class="form-group">
                    <label for="address">Endereço</label>
                    <input type="text" id="address" name="address">
                </div>
                <div class="form-group">
                    <label for="city">Cidade</label>
                    <input type="text" id="city" name="city">
                </div>
                <div class="form-group">
                    <label for="phone">Telefone</label>
                    <input type="tel" id="phone" name="phone">
                </div>
                <div class="form-group">
                    <label for="email">Email</label>
                    <input type="email" id="email" name="email">
                </div>
                <div class="form-group">
                    <label for="description">Descrição</label>
                    <textarea id="description" name="description" rows="3"></textarea>
                </div>
                <div style="text-align: right; margin-top: 30px;">
                    <button type="button" class="btn-secondary" onclick="closeModal('restaurant')">Cancelar</button>
                    <button type="submit" class="btn-primary">Salvar</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Category Modal -->
    <div id="categoryModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeModal('category')">&times;</span>
            <h2 id="categoryModalTitle">Nova Categoria</h2>
            <form id="categoryForm">
                <div class="form-group">
                    <label for="categoryRestaurant">Restaurante *</label>
                    <select id="categoryRestaurant" name="restaurant_id" required>
                        <option value="">Selecione um restaurante</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="categoryName">Nome *</label>
                    <input type="text" id="categoryName" name="name" required>
                </div>
                <div class="form-group">
                    <label for="categoryDescription">Descrição</label>
                    <textarea id="categoryDescription" name="description"></textarea>
                </div>
                <div class="form-group">
                    <label for="categoryImage">URL da Imagem</label>
                    <input type="url" id="categoryImage" name="image_url">
                </div>
                <div style="text-align: right; margin-top: 30px;">
                    <button type="button" class="btn-secondary" onclick="closeModal('category')">Cancelar</button>
                    <button type="submit" class="btn-primary">Salvar</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Modal de Produto -->
    <div id="productModal" class="modal">
        <div class="modal-content" style="max-width: 600px;">
            <span class="close" onclick="closeModal('product')">&times;</span>
            <h2 id="productModalTitle">Novo Produto</h2>
            <form id="productForm">
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
                    <div class="form-group">
                        <label for="productCategory">Categoria *</label>
                        <select id="productCategory" name="category_id" required>
                            <option value="">Selecione uma categoria</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="productName">Nome *</label>
                        <input type="text" id="productName" name="name" required>
                    </div>
                </div>

                <div class="form-group">
                    <label for="productDescription">Descrição</label>
                    <textarea id="productDescription" name="description" rows="3"></textarea>
                </div>

                <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 15px;">
                    <div class="form-group">
                        <label for="productRegularPrice">Preço Regular *</label>
                        <input type="number" id="productRegularPrice" name="regular_price" step="0.01" min="0" required>
                    </div>
                    <div class="form-group">
                        <label for="productCurrentPrice">Preço Atual</label>
                        <input type="number" id="productCurrentPrice" name="current_price" step="0.01" min="0">
                    </div>
                    <div class="form-group">
                        <label for="productSortOrder">Ordem</label>
                        <input type="number" id="productSortOrder" name="sort_order" min="0">
                    </div>
                </div>

                <div class="form-group">
                    <label for="productImage">URL da Imagem</label>
                    <input type="url" id="productImage" name="image_url">
                </div>

                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                    <div class="form-group">
                        <label>
                            <input type="checkbox" id="productPromotion" name="is_on_promotion">
                            Em Promoção
                        </label>
                    </div>
                    <div class="form-group">
                        <label>
                            <input type="checkbox" id="productAvailable" name="is_available" checked>
                            Disponível
                        </label>
                    </div>
                </div>

                <div style="text-align: right; margin-top: 30px;">
                    <button type="button" class="btn-secondary" onclick="closeModal('product')">Cancelar</button>
                    <button type="submit" class="btn-primary">Salvar</button>
                </div>
            </form>
        </div>
    </div>

    <!-- 4. MODAIS PARA MESAS -->

    <!-- Modal de Mesa Individual -->
    <div id="tableModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeModal('table')">&times;</span>
            <h2 id="tableModalTitle">Nova Mesa</h2>
            <form id="tableForm">
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
                    <div class="form-group">
                        <label for="tableRestaurant">Restaurante *</label>
                        <select id="tableRestaurant" name="restaurant_id" required>
                            <option value="">Selecione um restaurante</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="tableNumber">Número da Mesa *</label>
                        <input type="number" id="tableNumber" name="table_number" required min="1">
                    </div>
                </div>

                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
                    <div class="form-group">
                        <label for="tableName">Nome/Descrição</label>
                        <input type="text" id="tableName" name="name" placeholder="Ex: Mesa da Janela">
                    </div>
                    <div class="form-group">
                        <label for="tableCapacity">Capacidade</label>
                        <input type="number" id="tableCapacity" name="capacity" min="1" max="20" value="4">
                    </div>
                </div>

                <div class="form-group">
                    <label>
                        <input type="checkbox" id="tableActive" name="is_active" checked>
                        Mesa Ativa
                    </label>
                </div>

                <div style="text-align: right; margin-top: 30px;">
                    <button type="button" class="btn-secondary" onclick="closeModal('table')">Cancelar</button>
                    <button type="submit" class="btn-primary">Salvar</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Modal de Criação em Lote -->
    <div id="batchTableModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeBatchTableModal()">&times;</span>
            <h2>Criar Mesas em Lote</h2>
            <form id="batchTableForm">
                <div class="form-group">
                    <label for="batchRestaurant">Restaurante *</label>
                    <select id="batchRestaurant" name="restaurant_id" required>
                        <option value="">Selecione um restaurante</option>
                    </select>
                </div>

                <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 15px;">
                    <div class="form-group">
                        <label for="startNumber">Número Inicial *</label>
                        <input type="number" id="startNumber" name="start_number" required min="1" value="1">
                    </div>
                    <div class="form-group">
                        <label for="endNumber">Número Final *</label>
                        <input type="number" id="endNumber" name="end_number" required min="1" value="10">
                    </div>
                    <div class="form-group">
                        <label for="batchCapacity">Capacidade Padrão</label>
                        <input type="number" id="batchCapacity" name="capacity" min="1" max="20" value="4">
                    </div>
                </div>

                <div style="background: var(--light-color); padding: 15px; border-radius: 8px; margin: 15px 0;">
                    <p><strong>Exemplo:</strong> Do número 1 ao 10 criará as mesas: 1, 2, 3, 4, 5, 6, 7, 8, 9, 10</p>
                    <p><strong>Máximo:</strong> 100 mesas por vez</p>
                </div>

                <div style="text-align: right; margin-top: 30px;">
                    <button type="button" class="btn-secondary" onclick="closeBatchTableModal()">Cancelar</button>
                    <button type="submit" class="btn-primary">Criar Mesas</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Modal de Gerenciamento de QR Codes -->
    <div id="qrManagerModal" class="modal">
        <div class="modal-content" style="max-width: 800px;">
            <span class="close" onclick="closeQRManagerModal()">&times;</span>
            <h2>Gerenciamento de QR Codes</h2>

            <div style="margin-bottom: 30px;">
                <div class="form-group">
                    <label for="qrRestaurant">Restaurante *</label>
                    <select id="qrRestaurant" name="restaurant_id" required onchange="loadRestaurantTables()">
                        <option value="">Selecione um restaurante</option>
                    </select>
                </div>
            </div>

            <!-- Tabs -->
            <div class="qr-tabs" style="display: flex; border-bottom: 1px solid #e0e0e0; margin-bottom: 20px;">
                <button class="qr-tab active" data-tab="restaurant"
                    onclick="switchQRTab('restaurant')">Restaurante</button>
                <button class="qr-tab" data-tab="individual" onclick="switchQRTab('individual')">QR Individual</button>
                <button class="qr-tab" data-tab="batch" onclick="switchQRTab('batch')">QR em Lote</button>
                <button class="qr-tab" data-tab="print" onclick="switchQRTab('print')">Imprimir</button>
            </div>

            <div class="tab-content-scroll" style="flex: 1; overflow-y: auto; padding: 20px 0;">


                <!-- Tab Restaurante -->
                <div id="qrTabRestaurant" class="qr-tab-content active">
                    <!-- <div class="form-group">
                <label for="qrTableSelect">Mesa:</label>
                <select id="qrTableSelect" style="padding: 10px; border: 1px solid #ddd; border-radius: 5px; width: 100%;">
                    <option value="">Selecione uma mesa</option>
                </select>
            </div> -->

                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin: 20px 0;">
                        <div class="form-group">
                            <label>Formato:</label>
                            <select id="qrFormat"
                                style="padding: 10px; border: 1px solid #ddd; border-radius: 5px; width: 100%;">
                                <option value="png">PNG</option>
                                <option value="svg">SVG</option>
                                <option value="json">JSON</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Tamanho:</label>
                            <select id="qrSize"
                                style="padding: 10px; border: 1px solid #ddd; border-radius: 5px; width: 100%;">
                                <option value="150">150px</option>
                                <option value="200" selected>200px</option>
                                <option value="300">300px</option>
                                <option value="400">400px</option>
                            </select>
                        </div>
                    </div>

                    <div style="text-align: center;">
                        <button class="btn-primary" onclick="generateRestaurantQR()">
                            <ion-icon name="qr-code-outline" style="margin-right: 8px;"></ion-icon>
                            Gerar QR Code
                        </button>
                    </div>

                    <div id="qrPreview" style="text-align: center; margin-top: 20px; display: none;">
                        <!-- QR preview will appear here -->
                    </div>
                </div>

                <!-- Tab Individual -->
                <div id="qrTabIndividual" class="qr-tab-content">
                    <div class="form-group">
                        <label for="qrTableSelect">Mesa:</label>
                        <select id="qrTableSelect"
                            style="padding: 10px; border: 1px solid #ddd; border-radius: 5px; width: 100%;">
                            <option value="">Selecione uma mesa</option>
                        </select>
                    </div>

                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin: 20px 0;">
                        <div class="form-group">
                            <label>Formato:</label>
                            <select id="qrFormat"
                                style="padding: 10px; border: 1px solid #ddd; border-radius: 5px; width: 100%;">
                                <option value="png">PNG</option>
                                <option value="svg">SVG</option>
                                <option value="json">JSON</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Tamanho:</label>
                            <select id="qrSize"
                                style="padding: 10px; border: 1px solid #ddd; border-radius: 5px; width: 100%;">
                                <option value="150">150px</option>
                                <option value="200" selected>200px</option>
                                <option value="300">300px</option>
                                <option value="400">400px</option>
                            </select>
                        </div>
                    </div>

                    <div style="text-align: center;">
                        <button class="btn-primary" onclick="generateSingleQR()">
                            <ion-icon name="qr-code-outline" style="margin-right: 8px;"></ion-icon>
                            Gerar QR Code
                        </button>
                    </div>

                    <div id="qrPreview" style="text-align: center; margin-top: 20px; display: none;">
                        <!-- QR preview will appear here -->
                    </div>
                </div>

                <!-- Tab Lote -->
                <div id="qrTabBatch" class="qr-tab-content">
                    <div class="form-group">
                        <label>Mesas Selecionadas:</label>
                        <div id="tableCheckboxList"
                            style="max-height: 230px; overflow-x: auto; border: 1px solid #ddd; padding: 15px; border-radius: 5px;">
                            <!-- Checkboxes de mesas serão carregadas aqui -->
                        </div>
                    </div>

                    <div style="margin: 20px 0;">
                        <button class="btn-secondary" onclick="selectAllTables()">Selecionar Todas</button>
                        <button class="btn-secondary" onclick="deselectAllTables()">Deselecionar Todas</button>
                    </div>

                    <div style="text-align: center;">
                        <button class="btn-primary" onclick="generateBatchQR()">
                            <ion-icon name="qr-code-outline" style="margin-right: 8px;"></ion-icon>
                            Gerar QR Codes
                        </button>
                    </div>

                    <div id="batchQRResults" style="margin-top: 20px;">
                        <!-- Resultados do lote aparecerão aqui -->
                    </div>
                </div>

                <!-- Tab Imprimir -->
                <!-- Tab Imprimir - Versão Organizada -->
                <div id="qrTabPrint" class="qr-tab-content">
                    <!-- 1. SELEÇÃO DO TIPO DE QR -->
                    <div class="print-section">
                        <h4 class="section-title">
                            <ion-icon name="qr-code-outline"></ion-icon>
                            Tipo de QR Code
                        </h4>
                        <div class="radio-group">
                            <label class="radio-option">
                                <input type="radio" name="printType" value="restaurant" checked
                                    onchange="togglePrintOptions()">
                                <div class="radio-content">
                                    <ion-icon name="storefront-outline"></ion-icon>
                                    <div>
                                        <strong>QR do Restaurante</strong>
                                        <small>Menu geral (sem mesa específica)</small>
                                    </div>
                                </div>
                            </label>

                            <label class="radio-option">
                                <input type="radio" name="printType" value="tables" onchange="togglePrintOptions()">
                                <div class="radio-content">
                                    <ion-icon name="grid-outline"></ion-icon>
                                    <div>
                                        <strong>QR das Mesas</strong>
                                        <small>Para mesas específicas</small>
                                    </div>
                                </div>
                            </label>
                        </div>
                    </div>

                    <!-- 2. OPÇÕES PARA MESAS (visível por padrão) -->
                    <div id="tablesPrintOptions" style="display: none;" class="print-section">
                        <h4 class="section-title">
                            <ion-icon name="options-outline"></ion-icon>
                            Opções de Impressão
                        </h4>
                        <div class="radio-group">
                            <label class="radio-option">
                                <input type="radio" name="printSelection" value="all" checked>
                                <div class="radio-content">
                                    <ion-icon name="checkmark-circle-outline"></ion-icon>
                                    <div>
                                        <strong>Todas as mesas ativas</strong>
                                        <small>Imprimir QR de todas as mesas</small>
                                    </div>
                                </div>
                            </label>

                            <label class="radio-option">
                                <input type="radio" name="printSelection" value="selected">
                                <div class="radio-content">
                                    <ion-icon name="list-outline"></ion-icon>
                                    <div>
                                        <strong>Mesas selecionadas</strong>
                                        <small>Escolher números específicos</small>
                                    </div>
                                </div>
                            </label>
                        </div>

                        <div class="input-group" id="tableNumbersInput">
                            <label for="printTableNumbers">Números das mesas:</label>
                            <input type="text" id="printTableNumbers" placeholder="Ex: 1,2,3,5,8" class="table-input">
                            <small>Separe os números por vírgula</small>
                        </div>
                    </div>

                    <!-- 3. INFORMAÇÕES PARA QR RESTAURANTE (oculta por padrão) -->
                    <div id="restaurantPrintOptions" class="print-section">
                        <div class="info-card">
                            <div class="info-header">
                                <ion-icon name="information-circle"></ion-icon>
                                <strong>QR do Restaurante</strong>
                            </div>
                            <p>Gera um QR code que leva direto ao menu principal, sem especificar mesa. Ideal para:</p>
                            Entrada do estabelecimento
                            , Redes sociais
                            , Materiais promocionais
                            , Cardápios físicos
                        </div>
                    </div>

                    <!-- 4. BOTÃO DE AÇÃO -->
                    <div class="action-section">
                        <button class="btn-primary btn-large" onclick="openPrintPage()">
                            <ion-icon name="print-outline"></ion-icon>
                            Abrir Página de Impressão
                        </button>
                    </div>
                </div>

            </div>


        </div>
    </div>

    <!-- Modal de Utilizador -->
    <div id="userModal" class="modal">
        <div class="modal-content" style="max-width: 600px;">
            <span class="close" onclick="closeModal('user')">&times;</span>
            <h2 id="userModalTitle">Novo Utilizador</h2>
            <form id="userForm">
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
                    <div class="form-group">
                        <label for="userName">Nome *</label>
                        <input type="text" id="userName" name="name" required>
                    </div>
                    <div class="form-group">
                        <label for="userEmail">Email *</label>
                        <input type="email" id="userEmail" name="email" required>
                    </div>
                </div>

                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
                    <div class="form-group">
                        <label for="userRole">Função *</label>
                        <select id="userRole" name="role" required>
                            <option value="">Selecione uma função</option>
                            <option value="super_admin">Super Administrador</option>
                            <option value="restaurant_user">Utilizador do Restaurante</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="userRestaurant">Restaurante</label>
                        <select id="userRestaurant" name="restaurant_id">
                            <option value="">Selecione um restaurante</option>
                        </select>
                    </div>
                </div>

                <div class="form-group">
                    <label for="userPassword">Senha *</label>
                    <input type="password" id="userPassword" name="password" required minlength="6">
                    <small>Mínimo 6 caracteres</small>
                </div>

                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                    <div class="form-group">
                        <label>
                            <input type="checkbox" id="userActive" name="is_active" checked>
                            Utilizador Ativo
                        </label>
                    </div>
                    <div class="form-group">
                        <label>
                            <input type="checkbox" id="userEmailVerified" name="email_verified">
                            Email Verificado
                        </label>
                    </div>
                </div>

                <div style="text-align: right; margin-top: 30px;">
                    <button type="button" class="btn-secondary" onclick="closeModal('user')">Cancelar</button>
                    <button type="submit" class="btn-primary">Salvar</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Modal de Confirmação de Logout -->
    <div id="logoutModal" class="modal">
        <div class="modal-content">
            <div class="logout-confirmation">
                <h3>
                    <ion-icon name="log-out-outline" style="margin-right: 10px;"></ion-icon>
                    Confirmar Logout
                </h3>
                <p>Tem certeza que deseja sair do sistema?</p>
                <div class="logout-buttons">
                    <button class="btn-logout-cancel" onclick="closeLogoutModal()">
                        <ion-icon name="close-outline" style="margin-right: 5px;"></ion-icon>
                        Cancelar
                    </button>
                    <button class="btn-logout-confirm" onclick="confirmLogout()">
                        <ion-icon name="log-out-outline" style="margin-right: 5px;"></ion-icon>
                        Sim, Sair
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal de Perfil do Usuário -->
    <div id="profileModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeProfileModal()">&times;</span>
            <h2>Meu Perfil</h2>
            <form id="profileForm">
                <div class="form-group">
                    <label for="profileName">Nome</label>
                    <input type="text" id="profileName" name="name" readonly>
                </div>
                <div class="form-group">
                    <label for="profileEmail">Email</label>
                    <input type="email" id="profileEmail" name="email" readonly>
                </div>
                <div class="form-group">
                    <label for="profileRole">Função</label>
                    <input type="text" id="profileRole" name="role" readonly>
                </div>
                <div style="text-align: right; margin-top: 30px;">
                    <button type="button" class="btn-secondary" onclick="closeProfileModal()">Fechar</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Modal de Alteração de Senha -->
    <div id="passwordModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closePasswordModal()">&times;</span>
            <h2>Alterar Senha</h2>
            <form id="passwordForm">
                <div class="form-group">
                    <label for="currentPassword">Senha Atual *</label>
                    <input type="password" id="currentPassword" name="current_password" required>
                </div>
                <div class="form-group">
                    <label for="newPassword">Nova Senha *</label>
                    <input type="password" id="newPassword" name="new_password" required minlength="6">
                </div>
                <div class="form-group">
                    <label for="confirmPassword">Confirmar Nova Senha *</label>
                    <input type="password" id="confirmPassword" name="confirm_password" required>
                </div>
                <div style="text-align: right; margin-top: 30px;">
                    <button type="button" class="btn-secondary" onclick="closePasswordModal()">Cancelar</button>
                    <button type="submit" class="btn-primary">Alterar Senha</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Modal de Novo Pedido -->
<!-- Modal de Novo Pedido - VERSÃO MELHORADA -->
<div id="newOrderModal" class="modal">
    <div class="modal-content">
        <!-- Header fixo -->
        <div class="new-order-header">
            <span class="close" onclick="closeNewOrderModal()">&times;</span>
            <h2><ion-icon name="receipt-outline"></ion-icon> Novo Pedido</h2>
        </div>
        
        <!-- Conteúdo scrollável -->
        <div class="new-order-content">
          

            <!-- Grid de Produtos e Carrinho -->
            <div class="products-cart-grid">
                <!-- Seção de Produtos -->
                <div class="products-section">
                    <div class="products-header">
                        <ion-icon name="fast-food-outline"></ion-icon>
                        Produtos Disponíveis
                    </div>
                    <div class="products-filter">
                        <div style="display: flex; gap: 10px; align-items: center;">
                            <div style="flex: 1;">
                                <input 
                                    type="text" 
                                    id="newOrderSearchInput" 
                                    placeholder="🔍 Buscar produto..." 
                                    style="width: 100%; padding: 8px 12px; border: 1px solid #ddd; border-radius: 8px; font-size: 0.9rem;"
                                    oninput="filterOrderProducts()"
                                >
                            </div>
                            <div style="flex: 1;">
                                <select id="newOrderCategoryFilter" onchange="filterOrderProducts()" style="width: 100%;">
                                    <option value="">📋 Todas as categorias</option>
                                </select>
                            </div>
                        </div>
                    </div>
                    <div class="products-list" id="newOrderProductsList">
                        <!-- Produtos serão carregados aqui -->
                    </div>
                </div>

                <!-- Seção do Carrinho -->
                <div class="cart-section">
                    <div class="cart-header">
                        <ion-icon name="bag-outline"></ion-icon>
                        Carrinho de Compras
                    </div>
                    <div class="cart-content">
                        <div class="cart-items" id="newOrderCartItems">
                            <div class="empty-state">
                                <ion-icon name="bag-outline"></ion-icon>
                                <p>Carrinho vazio</p>
                                <small>Adicione produtos da lista ao lado</small>
                            </div>
                        </div>
                        <div class="cart-summary" id="newOrderCartSummary" style="display: none;">
                            <div class="cart-summary-content">
                                <div class="cart-summary-row">
                                    <span>Total de itens:</span>
                                    <span id="newOrderTotalItems">0</span>
                                </div>
                                <div class="cart-summary-row total">
                                    <span>💰 Total Geral:</span>
                                    <span id="newOrderTotalAmount">0,00 MT</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

              <!-- Informações do Cliente -->
            <div class="customer-section">
                <h3><ion-icon name="person-outline"></ion-icon> Dados do Cliente</h3>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 15px;">
                    <div class="form-group">
                        <label for="newOrderCustomerName">Nome Completo *</label>
                        <input type="text" id="newOrderCustomerName" required placeholder="Nome do cliente">
                    </div>
                    <div class="form-group">
                        <label for="newOrderCustomerPhone">Telefone *</label>
                        <input type="tel" id="newOrderCustomerPhone" required placeholder="(00) 00000-0000">
                    </div>
                </div>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 15px;">
                    <div class="form-group">
                        <label for="newOrderCustomerEmail">Email (opcional)</label>
                        <input type="email" id="newOrderCustomerEmail" placeholder="email@exemplo.com">
                    </div>
                    <div class="form-group">
                        <label for="newOrderTable">Mesa (opcional)</label>
                        <select id="newOrderTable">
                            <option value="">Selecione uma mesa</option>
                        </select>
                    </div>
                </div>
                <div class="form-group">
                    <label for="newOrderNotes">Observações</label>
                    <textarea id="newOrderNotes" placeholder="Observações do pedido..." rows="2"></textarea>
                </div>
            </div>
        </div>

        <!-- Footer fixo com botões -->
        <div class="new-order-footer">
            <div style="display: flex; justify-content: space-between; align-items: center;">
                <div style="color: var(--black2); font-size: 0.9rem;">
                    <ion-icon name="information-circle-outline"></ion-icon>
                    Preencha os dados e adicione produtos ao carrinho
                </div>
                <div style="display: flex; gap: 15px;">
                    <button type="button" class="btn-secondary" onclick="closeNewOrderModal()">
                        <ion-icon name="close-outline"></ion-icon> Cancelar
                    </button>
                    <button type="button" class="btn-primary" onclick="submitNewOrder()" id="submitNewOrderBtn" disabled>
                        <ion-icon name="checkmark-outline"></ion-icon> Criar Pedido
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>
    <!-- =========== Scripts =========  -->
    <script>
        // Global variables
        const apiBaseUrl = window.location.origin + '/api/v1';
        let currentEditId = null;
        let restaurantsData = [];
        let allProductsData = [];
        let allCategoriesForProducts = [];
        let currentUser = null;
        let userMenuTimeout = null;
        let allUsersData = [];
        let currentUserEditId = null;
        let allTablesData = [];
        let currentTableEditId = null;
        let currentProductPage = 1;
        let totalProductPages = 1;
        let productPagination = null;
        let allOrdersData = [];
        let orderStats = {};
        let newOrderCart = {};
        let newOrderProducts = [];
        let newOrderCategories = [];
        let newOrderTables = [];

        // Cache simples para evitar requests desnecessários
        const statsCache = {
            data: {},
            timestamp: {},
            ttl: 2 * 60 * 1000 // 2 minutos
        };

        function isCacheValid(key) {
            return statsCache.timestamp[key] &&
                (Date.now() - statsCache.timestamp[key]) < statsCache.ttl;
        }

        function setCacheData(key, data) {
            statsCache.data[key] = data;
            statsCache.timestamp[key] = Date.now();
        }

        function getCacheData(key) {
            return isCacheValid(key) ? statsCache.data[key] : null;
        }



        // Toggle do menu de usuário
        function toggleUserMenu() {
            const userMenu = document.querySelector('.user-menu');
            const isActive = userMenu.classList.contains('active');

            if (isActive) {
                closeUserMenu();
            } else {
                openUserMenu();
            }
        }

        // Controlar loading screen inicial
        function showInitialLoading(show) {
            const loadingScreen = document.getElementById('initialLoading');
            const mainContent = document.querySelector('.main');

            if (show) {
                if (loadingScreen) loadingScreen.style.display = 'flex';
                if (mainContent) mainContent.classList.add('loading');
            } else {
                if (loadingScreen) {
                    loadingScreen.style.opacity = '0';
                    setTimeout(() => {
                        loadingScreen.style.display = 'none';
                    }, 300);
                }
                if (mainContent) {
                    mainContent.classList.remove('loading');
                    mainContent.style.visibility = 'visible';
                }
            }
        }

        function openUserMenu() {
            const userMenu = document.querySelector('.user-menu');
            userMenu.classList.add('active');

            // Fechar menu ao clicar fora
            setTimeout(() => {
                document.addEventListener('click', closeUserMenuOnOutsideClick);
            }, 100);
        }

        function closeUserMenu() {
            const userMenu = document.querySelector('.user-menu');
            userMenu.classList.remove('active');
            document.removeEventListener('click', closeUserMenuOnOutsideClick);
        }

        function closeUserMenuOnOutsideClick(event) {
            const userMenu = document.querySelector('.user-menu');
            if (!userMenu.contains(event.target)) {
                closeUserMenu();
            }
        }

        // Carregar informações do usuário
        async function loadUserInfo() {
            try {
                const response = await fetch(`${apiBaseUrl}/auth/me`, {
                    headers: {
                        credentials: 'include',
                    }
                });

                if (response.ok) {
                    const data = await response.json();
                    if (data.success) {
                        currentUser = data.data;
                        updateUserDisplay();
                        return true;
                    }
                } else if (response.status === 401) {
                    // Token inválido, redirecionar para login
                    redirectToLogin();
                    return false;
                }
            } catch (error) {
                console.error('Erro ao carregar informações do usuário:', error);
                redirectToLogin();
                return false;
            }
            return false;
        }

        function updateUserDisplay() {
            if (currentUser) {
                // Atualizar nome do usuário na topbar
                const userNameElements = document.querySelectorAll('#userName, #userNameDropdown');
                userNameElements.forEach(element => {
                    if (element) element.textContent = currentUser.name;
                });

                // Atualizar role do usuário
                const userRoleElement = document.getElementById('userRole');
                if (userRoleElement) {
                    const roleText = currentUser.role === 'super_admin' ? 'Super Admin' : 'Usuário do Restaurante';
                    userRoleElement.textContent = roleText;
                }
            }
        }

        // Função para controlar visibilidade baseada no role
        function controlRoleBasedAccess() {
            if (!currentUser) {
                console.warn('Usuário não carregado ainda');
                return;
            }

            const isRestaurantUser = currentUser.role === 'restaurant_user';

            document.body.setAttribute('data-user-role', currentUser.role);
            if (isRestaurantUser) {
                // 1. Ocultar cards do dashboard
                const restaurantCard = document.getElementById('restaurantCount')?.closest('.card');
                const userCard = document.getElementById('userCount')?.closest('.card');

                if (restaurantCard) restaurantCard.style.display = 'none';
                if (userCard) userCard.style.display = 'none';

                // 2. Ocultar seção de restaurantes recentes
                const recentRestaurantsSection = document.querySelector('.details .recentOrders');
                if (recentRestaurantsSection) {
                    recentRestaurantsSection.style.display = 'none';
                }

                // 3. Ocultar botão "Novo Restaurante" na sidebar de ações rápidas
                const newRestaurantBtn = document.querySelector('button[onclick="openModal(\'restaurant\')"]');
                if (newRestaurantBtn) {
                    newRestaurantBtn.style.display = 'none';
                }

                // 4. Ocultar itens de navegação
                const menuItems = [
                    document.querySelector('[data-section="users"]'), // Utilizadores
                    document.querySelector('[data-section="restaurants"]'), // Restaurantes  
                    document.querySelector('[data-section="menu"]'), // Menu Preview
                    document.querySelector('[data-section="api"]'), // API Docs
                ];

                menuItems.forEach(item => {
                    if (item) item.style.display = 'none';
                });

                // 5. Ocultar Health Check
                const healthCheckItem = document.querySelector('a[onclick*="health"]')?.closest('li');
                if (healthCheckItem) {
                    healthCheckItem.style.display = 'none';
                }

                // 6. Ajustar layout da seção details (remover grid com 2 colunas)
                const detailsSection = document.querySelector('.details');
                if (detailsSection) {
                    detailsSection.style.gridTemplateColumns = '1fr';
                }

                // 7. Filtrar dados apenas do restaurante do usuário
                if (currentUser.restaurant_id) {
                    window.userRestaurantId = currentUser.restaurant_id;
                }

                // 8. Atualizar título da sidebar de ações rápidas
                const quickActionsTitle = document.querySelector('.recentCustomers .cardHeader h2');
                if (quickActionsTitle) {
                    quickActionsTitle.textContent = 'Ações Rápidas - Meu Restaurante';
                }

                const cardBox = document.querySelector('.cardBox');
                if (cardBox) {
                    cardBox.style.gridTemplateColumns = 'repeat(2, 1fr)';
                }
            }

            if (isRestaurantUser && currentUser.restaurant_id) {
                loadUserRestaurantInfo();
            }
        }



        // Função para carregar e exibir informações do restaurante do usuário
        async function loadUserRestaurantInfo() {
            try {
                const response = await fetch(`${apiBaseUrl}/restaurants/${currentUser.restaurant_id}`);
                const data = await response.json();

                if (data.success) {
                    const restaurant = data.data;

                    // Atualizar título da página para incluir nome do restaurante
                    const recentCustomersSection = document.querySelector('.recentCustomers');
                    if (recentCustomersSection) {
                        const header = recentCustomersSection.querySelector('.cardHeader h2');
                        if (header) {
                            header.innerHTML = `
                        <div style="text-align: left;">
                            <div style="font-size: 1.2rem; color: var(--primary-color);">Meu Restaurante</div>
                            <div style="font-size: 0.9rem; color: var(--black2); font-weight: normal;">${restaurant.name}</div>
                            <div style="font-size: 0.8rem; color: var(--black2); font-weight: normal;">${restaurant.city || 'Cidade não informada'}</div>
                        </div>
                    `;
                        }
                    }
                }
            } catch (error) {
                console.error('Erro ao carregar informações do restaurante:', error);
            }
        }


        // Carregar mesas
        async function loadTables() {
            try {
                showLoading(true);
                let url = `${apiBaseUrl}/tables?limit=100`;

                // Filtrar por restaurante se for restaurant_user
                // if (currentUser?.role === 'restaurant_user' && currentUser.restaurant_id) {
                //     url = `${apiBaseUrl}/restaurants/${currentUser.restaurant_id}/tables`;
                // }
                if (currentUser?.role === 'restaurant_user' && currentUser.restaurant_id) {
                    url += `&restaurant_id=${currentUser.restaurant_id}`;
                }

                const response = await fetch(url, {
                    headers: { credentials: 'include' }
                });
                const data = await response.json();

                if (data.success && data.data) {
                    allTablesData = Array.isArray(data.data) ? data.data : data.data.data || [];
                    populateTableFilters();
                    applyTableFilters();
                } else {
                    allTablesData = [];
                    displayTables([]);
                }
            } catch (error) {
                showError('Erro ao carregar mesas: ' + error.message);
                allTablesData = [];
                displayTables([]);
            } finally {
                showLoading(false);
            }
        }

        // Exibir mesas
        function displayTables(tables) {
            const grid = document.getElementById('tableGrid');

            if (!tables || tables.length === 0) {
                grid.innerHTML = `
            <div style="grid-column: 1 / -1; text-align: center; padding: 60px 20px;">
                <ion-icon name="grid-outline" style="font-size: 4rem; color: var(--black2); margin-bottom: 20px;"></ion-icon>
                <h3 style="color: var(--black2); margin-bottom: 10px;">Nenhuma mesa encontrada</h3>
                <p style="color: var(--black2); margin-bottom: 30px;">Comece criando suas primeiras mesas</p>
                <button class="btn-primary" onclick="openModal('table')">
                    <ion-icon name="add-outline" style="margin-right: 8px;"></ion-icon>
                    Criar Mesa
                </button>
            </div>
        `;
                return;
            }

            grid.innerHTML = tables.map(table => {
                const restaurant = table.restaurant || {};
                const hasQR = table.qr_code_generated;

                return `
            <div class="table-card">
                <div class="table-header">
                    <div>
                        <div class="table-number">Mesa ${table.table_number}</div>
                        ${table.name ? `<div class="table-name">${table.name}</div>` : ''}
                    </div>
                    <div class="table-status">
                        <span class="status ${table.is_active ? 'active' : 'inactive'}">
                            ${table.is_active ? 'Ativa' : 'Inativa'}
                        </span>
                        <span class="qr-indicator ${hasQR ? 'has-qr' : 'no-qr'}">
                            <ion-icon name="qr-code${hasQR ? '' : '-outline'}"></ion-icon>
                            ${hasQR ? 'Com QR' : 'Sem QR'}
                        </span>
                    </div>
                </div>
                
                <div class="table-info">
                    <p><ion-icon name="storefront-outline"></ion-icon> ${restaurant.name || 'Restaurante não encontrado'}</p>
                    <p><ion-icon name="people-outline"></ion-icon> Capacidade: ${table.capacity || 4} pessoas</p>
                    <p><ion-icon name="calendar-outline"></ion-icon> Criada em ${formatDate(table.created_at)}</p>
                    ${table.last_qr_generated_at ? `<p><ion-icon name="time-outline"></ion-icon> QR gerado em ${formatDate(table.last_qr_generated_at)}</p>` : ''}
                </div>
                
                <div class="table-actions">
                    <button class="btn-sm btn-edit" onclick="editTable(${table.id})" title="Editar">
                        <ion-icon name="create-outline"></ion-icon>
                    </button>
                    <button class="btn-sm btn-success" onclick="generateTableQR(${table.id})" title="Gerar QR">
                        <ion-icon name="qr-code-outline"></ion-icon>
                    </button>
                    <button class="btn-sm btn-view" onclick="previewTableMenu(${table.restaurant_id}, ${table.table_number})" title="Ver Menu">
                        <ion-icon name="restaurant-outline"></ion-icon>
                    </button>
                    <button class="btn-sm ${table.is_active ? 'btn-warning' : 'btn-success'}" 
                            onclick="toggleTableStatus(${table.id}, ${table.is_active})" 
                            title="${table.is_active ? 'Inativar' : 'Ativar'}">
                        <ion-icon name="${table.is_active ? 'pause-outline' : 'play-outline'}"></ion-icon>
                    </button>
                    <button class="btn-sm btn-delete" onclick="deleteTable(${table.id})" title="Deletar">
                        <ion-icon name="trash-outline"></ion-icon>
                    </button>
                </div>
            </div>
        `;
            }).join('');
        }

        // Popular filtros de mesas
        function populateTableFilters() {
            const restaurantFilter = document.getElementById('tableRestaurantFilter');
            restaurantFilter.innerHTML = '<option value="">Todos</option>';

            const uniqueRestaurants = [...new Set(allTablesData
                .filter(table => table.restaurant)
                .map(table => JSON.stringify({ id: table.restaurant.id, name: table.restaurant.name }))
            )].map(str => JSON.parse(str));

            uniqueRestaurants.forEach(restaurant => {
                const option = document.createElement('option');
                option.value = restaurant.id;
                option.textContent = restaurant.name;
                restaurantFilter.appendChild(option);
            });
        }

        // Aplicar filtros de mesas
        function applyTableFilters() {
            const searchTerm = document.getElementById('tableSearch')?.value.toLowerCase() || '';
            const restaurantFilter = document.getElementById('tableRestaurantFilter')?.value || '';
            const statusFilter = document.getElementById('tableStatusFilter')?.value || '';
            const qrFilter = document.getElementById('tableQRFilter')?.value || '';

            let filteredTables = [...allTablesData];

            // Filtro de busca
            if (searchTerm) {
                filteredTables = filteredTables.filter(table =>
                    table.table_number.toString().includes(searchTerm) ||
                    (table.name && table.name.toLowerCase().includes(searchTerm)) ||
                    (table.restaurant && table.restaurant.name.toLowerCase().includes(searchTerm))
                );
            }

            // Filtro de restaurante
            if (restaurantFilter) {
                filteredTables = filteredTables.filter(table =>
                    table.restaurant_id.toString() === restaurantFilter
                );
            }

            // Filtro de status
            if (statusFilter !== '') {
                const isActive = statusFilter === 'true';
                filteredTables = filteredTables.filter(table => table.is_active === isActive);
            }

            // Filtro de QR Code
            if (qrFilter !== '') {
                const hasQR = qrFilter === 'true';
                filteredTables = filteredTables.filter(table => !!table.qr_code_generated === hasQR);
            }

            displayTables(filteredTables);
        }

        // Limpar filtros
        function clearTableFilters() {
            document.getElementById('tableSearch').value = '';
            document.getElementById('tableRestaurantFilter').value = '';
            document.getElementById('tableStatusFilter').value = '';
            document.getElementById('tableQRFilter').value = '';
            applyTableFilters();
        }

        // Configurar filtros
        function setupTableFilters() {
            const searchInput = document.getElementById('tableSearch');
            const restaurantFilter = document.getElementById('tableRestaurantFilter');
            const statusFilter = document.getElementById('tableStatusFilter');
            const qrFilter = document.getElementById('tableQRFilter');

            if (searchInput) {
                let searchTimeout;
                searchInput.addEventListener('input', () => {
                    clearTimeout(searchTimeout);
                    searchTimeout = setTimeout(applyTableFilters, 300);
                });
            }

            [restaurantFilter, statusFilter, qrFilter].forEach(filter => {
                if (filter) {
                    filter.addEventListener('change', applyTableFilters);
                }
            });
        }
        // Função para obter token de autenticação
        function getAuthToken() {
            const stored = localStorage.getItem('access_token');
            if (stored) return stored;

            // Tentar pegar dos cookies
            const cookies = document.cookie.split(';');
            for (let cookie of cookies) {
                const [name, value] = cookie.trim().split('=');
                if (name === 'access_token') {
                    return value;
                }
            }

            // Verificar se há informações do usuário nos cookies
            const userInfo = getCookie('user_info');
            if (userInfo) {
                try {
                    const user = JSON.parse(decodeURIComponent(userInfo));
                    console.log('User from cookie:', user);
                } catch (e) {
                    console.error('Error parsing user info:', e);
                }
            }

            console.warn('No auth token found');
            return null;
        }

        function clearLocalAuth() {
            // Limpar localStorage
            localStorage.removeItem('auth_token');
            localStorage.removeItem('user_info');
            localStorage.removeItem('refresh_token');
            localStorage.removeItem('access_token');
            localStorage.removeItem('user');


            // Limpar cookies (definindo data passada)
            const expiredDate = new Date(0).toUTCString();
            document.cookie = `access_token=; expires=${expiredDate}; path=/`;
            document.cookie = `refresh_token=; expires=${expiredDate}; path=/`;
            document.cookie = `user_info=; expires=${expiredDate}; path=/`;
        }

        // Verificar se usuário está autenticado
        function checkAuthentication() {
            const token = getAuthToken();
            if (!token) {
                redirectToLogin();
                return false;
            }
            return true;
        }

        // Redirecionar para login
        function redirectToLogin() {
            // Limpar dados de autenticação
            localStorage.removeItem('access_token');
            localStorage.removeItem('refresh_token');
            sessionStorage.removeItem('access_token');
            sessionStorage.removeItem('refresh_token');

            // Redirecionar
            window.location.href = '/login';
        }

        // Função principal de logout
        async function performLogout() {
            // closeUserMenu(); // Fechar menu primeiro
            openLogoutModal(); // Abrir modal de confirmação
        }

        function openLogoutModal() {
            document.getElementById('logoutModal').style.display = 'block';
        }

        function closeLogoutModal() {
            document.getElementById('logoutModal').style.display = 'none';
        }

        async function confirmLogout() {
            try {
                // Buscar token do localStorage, cookie ou header
                const token = getAuthToken();

                const headers = {
                    'Content-Type': 'application/json'
                };

                // Adicionar token ao header se existir
                if (token) {
                    headers['Authorization'] = `Bearer ${token}`;
                }

                const response = await fetch(`${apiBaseUrl}/auth/logout`, {
                    method: 'POST',
                    headers: headers,
                    credentials: 'include' // Incluir cookies na requisição
                });

                const data = await response.json();

                // Limpar dados locais independentemente da resposta
                clearLocalAuth();

                if (data.success || response.status === 200) {
                    showSuccess('Logout realizado com sucesso!');

                    // Redirecionar após um breve delay
                    setTimeout(() => {
                        window.location.href = '/login';
                    }, 1500);
                } else {
                    // Mesmo se a API retornar erro, fazer logout local
                    console.warn('Erro na API de logout, mas fazendo logout local:', data.message);
                    showInfo('Sessão finalizada localmente');

                    setTimeout(() => {
                        window.location.href = '/login';
                    }, 1500);
                }

            } catch (error) {
                console.error('Erro durante logout:', error);

                // Em caso de erro de rede, fazer logout local
                clearLocalAuth();
                showInfo('Sessão finalizada localmente');

                setTimeout(() => {
                    window.location.href = '/login';
                }, 1500);

            } finally {
                showLoading(false);
                closeLogoutModal();
            }
        }

        async function clearAllUserData() {
            // Limpar localStorage
            localStorage.removeItem('access_token');
            localStorage.removeItem('refresh_token');
            localStorage.removeItem('user_info');

            // Limpar sessionStorage
            sessionStorage.clear();

            // Tentar limpar cookies manualmente (JavaScript)
            // await deleteCookie('access_token');
            newDeleteCokkies();
            // await deleteCookie('refresh_token');
            // await deleteCookie('user_info');
        }

        function newDeleteCokkies() {
            const cookies = document.cookie.split(";");
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i];
                const eqPos = cookie.indexOf("=");
                const name = eqPos > -1 ? cookie.substr(0, eqPos) : cookie;
                document.cookie = name + "=;expires=Thu, 01 Jan 1970 00:00:00 GMT";
            }
        }

        async function deleteCookie(name) {
            // Deletar com diferentes paths e domains para garantir
            const domains = ['', '.localhost', '.vercel.app/', 'https://foodway-api.vercel.app', '.yourdomain.com']; // Adicione seus domínios
            const paths = ['/', '/api', '/dashboard'];

            domains.forEach(domain => {
                paths.forEach(path => {
                    document.cookie = `${name}=; expires=Thu, 01 Jan 1970 00:00:00 UTC; path=${path}; domain=${domain};`;
                    document.cookie = `${name}=; expires=Thu, 01 Jan 1970 00:00:00 UTC; path=${path}; domain=${domain}; secure;`;
                    document.cookie = `${name}=; expires=Thu, 01 Jan 1970 00:00:00 UTC; path=${path}; domain=${domain}; httpOnly; secure;`;
                });
            });
        }

        // Logout em todos os dispositivos
        async function logoutAllDevices() {
            if (!confirm('Tem certeza que deseja sair de todos os dispositivos? Você precisará fazer login novamente em todos eles.')) {
                return;
            }

            try {
                showLoading(true);

                const token = getAuthToken();
                if (token) {
                    const response = await fetch(`${apiBaseUrl}/auth/logout-all`, {
                        method: 'POST',
                        headers: {
                            'Authorization': `Bearer ${token}`,
                            'Content-Type': 'application/json'
                        }
                    });

                    if (response.ok) {
                        showSuccess('Logout realizado em todos os dispositivos!');
                    }
                }

                // Limpar dados locais
                redirectToLogin();

            } catch (error) {
                console.error('Erro durante logout geral:', error);
                redirectToLogin();
            } finally {
                showLoading(false);
            }
        }

        // Funções para modais de perfil e senha
        function showProfile() {
            // closeUserMenu();
            if (currentUser) {
                document.getElementById('profileName').value = currentUser.name || '';
                document.getElementById('profileEmail').value = currentUser.email || '';
                document.getElementById('profileRole').value = currentUser.role === 'super_admin' ? 'Super Administrador' : 'Usuário do Restaurante';
                document.getElementById('profileModal').style.display = 'block';
            }
        }

        function closeProfileModal() {
            document.getElementById('profileModal').style.display = 'none';
        }

        function showChangePassword() {
            closeUserMenu();
            document.getElementById('passwordForm').reset();
            document.getElementById('passwordModal').style.display = 'block';
        }

        function closePasswordModal() {
            document.getElementById('passwordModal').style.display = 'none';
            document.getElementById('passwordForm').reset();
        }

        // Alterar senha
        async function changeUserPassword(formData) {
            try {
                showLoading(true);

                // Verificar se as senhas coincidem
                if (formData.new_password !== formData.confirm_password) {
                    showError('As senhas não coincidem');
                    return;
                }

                const response = await fetch(`${apiBaseUrl}/auth/change-password`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${getAuthToken()}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        current_password: formData.current_password,
                        new_password: formData.new_password
                    })
                });

                const data = await response.json();

                if (data.success) {
                    showSuccess('Senha alterada com sucesso! Você será redirecionado para fazer login novamente.');
                    closePasswordModal();

                    // Redirecionar para login após trocar a senha
                    setTimeout(() => {
                        redirectToLogin();
                    }, 2000);
                } else {
                    throw new Error(data.message || 'Erro ao alterar senha');
                }

            } catch (error) {
                showError('Erro ao alterar senha: ' + error.message);
            } finally {
                showLoading(false);
            }
        }

        // Auto-logout em caso de inatividade (opcional)
        let inactivityTimer = null;
        const INACTIVITY_TIME = 30 * 60 * 1000; // 30 minutos

        function resetInactivityTimer() {
            if (inactivityTimer) {
                clearTimeout(inactivityTimer);
            }

            inactivityTimer = setTimeout(() => {
                if (confirm('Sua sessão expirará devido à inatividade. Deseja continuar?')) {
                    resetInactivityTimer();
                } else {
                    performLogout();
                }
            }, INACTIVITY_TIME);
        }

        // Monitorar atividade do usuário
        function initInactivityMonitor() {
            const events = ['mousedown', 'mousemove', 'keypress', 'scroll', 'touchstart', 'click'];

            events.forEach(event => {
                document.addEventListener(event, resetInactivityTimer, { passive: true });
            });

            resetInactivityTimer();
        }

        // Setup de formulário de senha
        function setupPasswordForm() {
            const form = document.getElementById('passwordForm');
            if (form) {
                form.addEventListener('submit', async (e) => {
                    e.preventDefault();

                    const formData = {
                        current_password: document.getElementById('currentPassword').value,
                        new_password: document.getElementById('newPassword').value,
                        confirm_password: document.getElementById('confirmPassword').value
                    };

                    await changeUserPassword(formData);
                });
            }
        }

        // Carregar utilizadores
        async function loadUsers() {
            try {
                showLoading(true);
                const response = await fetch(`${apiBaseUrl}/users`, {
                    headers: {
                        // 'Authorization': `Bearer ${getAuthToken()}`
                        credentials: 'include'
                    }
                });
                const data = await response.json();

                if (data.success && data.data && data.data.data) {
                    allUsersData = data.data.data;
                    populateUserFilters();
                    applyUserFilters();
                } else {
                    allUsersData = [];
                    displayUsers([]);
                }
            } catch (error) {
                showError('Erro ao carregar utilizadores: ' + error.message);
                allUsersData = [];
                displayUsers([]);
            } finally {
                showLoading(false);
            }
        }

        // Exibir utilizadores
        function displayUsers(users) {
            const grid = document.getElementById('userGrid');

            if (!users || users.length === 0) {
                grid.innerHTML = `
            <div style="grid-column: 1 / -1; text-align: center; padding: 60px 20px;">
                <ion-icon name="people-outline" style="font-size: 4rem; color: var(--black2); margin-bottom: 20px;"></ion-icon>
                <h3 style="color: var(--black2); margin-bottom: 10px;">Nenhum utilizador encontrado</h3>
                <p style="color: var(--black2); margin-bottom: 30px;">Tente ajustar os filtros ou criar um novo utilizador</p>
                <button class="btn-primary" onclick="openModal('user')">
                    <ion-icon name="add-outline" style="margin-right: 8px;"></ion-icon>
                    Criar Utilizador
                </button>
            </div>
        `;
                return;
            }

            grid.innerHTML = users.map(user => `
        <div class="user-card">
            <div class="user-header">
                <div class="user-title">
                    <h3>${user.name}</h3>
                    <div class="user-email">
                        <ion-icon name="mail-outline"></ion-icon>
                        ${user.email}
                    </div>
                </div>
                <span class="status ${user.is_active ? 'active' : 'inactive'}">
                    ${user.is_active ? 'Ativo' : 'Inativo'}
                </span>
            </div>
            
            <div class="user-info">
                <div class="user-role ${user.role.replace('_', '-')}">
                    ${user.role === 'super_admin' ? 'Super Admin' : 'Utilizador'}
                </div>
                
                ${user.restaurant_name ? `
                    <p><ion-icon name="storefront-outline"></ion-icon> ${user.restaurant_name}</p>
                ` : '<p><ion-icon name="business-outline"></ion-icon> Administrador Geral</p>'}
                
                <p><ion-icon name="calendar-outline"></ion-icon> Criado em ${formatDate(user.created_at)}</p>
                
                ${user.last_login ? `
                    <p class="last-login">Último acesso: ${formatDate(user.last_login)}</p>
                ` : '<p class="last-login">Nunca fez login</p>'}
            </div>
            
            <div class="user-actions">
                <button class="btn-sm btn-edit" onclick="editUser(${user.id})" title="Editar">
                    <ion-icon name="create-outline"></ion-icon>
                </button>
                <button class="btn-sm ${user.is_active ? 'btn-warning' : 'btn-success'}" 
                        onclick="toggleUserStatus(${user.id}, ${user.is_active})" 
                        title="${user.is_active ? 'Inativar' : 'Ativar'}">
                    <ion-icon name="${user.is_active ? 'pause-outline' : 'play-outline'}"></ion-icon>
                </button>
                <button class="btn-sm btn-delete" onclick="deleteUser(${user.id})" title="Deletar">
                    <ion-icon name="trash-outline"></ion-icon>
                </button>
            </div>
        </div>
    `).join('');
        }

        // Popular filtros de utilizadores
        function populateUserFilters() {
            const restaurantFilter = document.getElementById('userRestaurantFilter');
            restaurantFilter.innerHTML = '<option value="">Todos</option>';

            // Adicionar opção para administradores
            restaurantFilter.innerHTML += '<option value="null">Administradores</option>';

            // Adicionar restaurantes
            const uniqueRestaurants = [...new Set(allUsersData
                .filter(user => user.restaurant_name)
                .map(user => JSON.stringify({ id: user.restaurant_id, name: user.restaurant_name }))
            )].map(str => JSON.parse(str));

            uniqueRestaurants.forEach(restaurant => {
                const option = document.createElement('option');
                option.value = restaurant.id;
                option.textContent = restaurant.name;
                restaurantFilter.appendChild(option);
            });
        }

        // Aplicar filtros de utilizadores
        function applyUserFilters() {
            const searchTerm = document.getElementById('userSearch')?.value.toLowerCase() || '';
            const restaurantFilter = document.getElementById('userRestaurantFilter')?.value || '';
            const roleFilter = document.getElementById('userRoleFilter')?.value || '';
            const statusFilter = document.getElementById('userStatusFilter')?.value || '';

            let filteredUsers = [...allUsersData];

            // Aplicar filtro de busca
            if (searchTerm) {
                filteredUsers = filteredUsers.filter(user =>
                    user.name.toLowerCase().includes(searchTerm) ||
                    user.email.toLowerCase().includes(searchTerm) ||
                    (user.restaurant_name && user.restaurant_name.toLowerCase().includes(searchTerm))
                );
            }

            // Aplicar filtro de restaurante
            if (restaurantFilter) {
                if (restaurantFilter === 'null') {
                    filteredUsers = filteredUsers.filter(user => !user.restaurant_id);
                } else {
                    filteredUsers = filteredUsers.filter(user =>
                        user.restaurant_id && user.restaurant_id.toString() === restaurantFilter
                    );
                }
            }

            // Aplicar filtro de função
            if (roleFilter) {
                filteredUsers = filteredUsers.filter(user => user.role === roleFilter);
            }

            // Aplicar filtro de status
            if (statusFilter !== '') {
                const isActive = statusFilter === 'true';
                filteredUsers = filteredUsers.filter(user => user.is_active === isActive);
            }

            displayUsers(filteredUsers);
        }

        // Abrir modal de utilizador
        function openUserModal(data = null) {
            const modal = document.getElementById('userModal');
            const title = document.getElementById('userModalTitle');
            const form = document.getElementById('userForm');

            currentUserEditId = data ? data.id : null;
            title.textContent = data ? 'Editar Utilizador' : 'Novo Utilizador';

            const userRolesData = [
                { value: 'super_admin', text: 'Super Administrador' },
                { value: 'restaurant_user', text: 'Utilizador do Restaurante' }
            ];

            // Popular select de FUNÇÕES - MESMA LÓGICA DOS RESTAURANTES
            const roleSelect = document.getElementById('userRole');
            roleSelect.innerHTML = '<option value="">Selecione uma função</option>';
            if (userRolesData && userRolesData.length > 0) {
                userRolesData.forEach(role => {
                    const option = document.createElement('option');
                    option.value = role.value;
                    option.textContent = role.text;
                    roleSelect.appendChild(option);
                });
            }

            // Popular select de restaurantes
            const restaurantSelect = document.getElementById('userRestaurant');
            restaurantSelect.innerHTML = '<option value="">Selecione um restaurante</option>';
            restaurantsData.forEach(restaurant => {
                const option = document.createElement('option');
                option.value = restaurant.id;
                option.textContent = restaurant.name;
                restaurantSelect.appendChild(option);
            });

            if (data) {
                document.getElementById('userName').value = data.name || '';
                document.getElementById('userEmail').value = data.email || '';
                document.getElementById('userRole').value = data.role || '';
                document.getElementById('userRestaurant').value = data.restaurant_id || '';
                document.getElementById('userPassword').required = false;
                document.getElementById('userActive').checked = data.is_active !== false;
                document.getElementById('userEmailVerified').checked = data.email_verified === true;

                // Esconder campo de senha para edição
                document.querySelector('label[for="userPassword"]').style.display = 'none';
                document.getElementById('userPassword').style.display = 'none';
            } else {
                form.reset();
                document.getElementById('userActive').checked = true;
                document.getElementById('userPassword').required = true;

                // Mostrar campo de senha para criação
                document.querySelector('label[for="userPassword"]').style.display = 'block';
                document.getElementById('userPassword').style.display = 'block';
            }

            modal.style.display = 'block';
        }

        // Configurar formulário de utilizadores
        function setupUserForm() {
            const form = document.getElementById('userForm');

            form.addEventListener('submit', async (e) => {
                e.preventDefault();

                const formData = {
                    name: document.getElementById('userName').value.trim(),
                    email: document.getElementById('userEmail').value.trim(),
                    role: document.getElementById('userRole').value,
                    restaurant_id: document.getElementById('userRestaurant').value || null,
                    is_active: document.getElementById('userActive').checked,
                    email_verified: document.getElementById('userEmailVerified').checked
                };

                // Adicionar senha apenas se estiver criando
                if (!currentUserEditId) {
                    formData.password = document.getElementById('userPassword').value;
                }

                await saveUser(formData);
            });

            // Controlar exibição do restaurante baseado na função
            const roleSelect = document.getElementById('userRole');
            const restaurantSelect = document.getElementById('userRestaurant');

            roleSelect.addEventListener('change', () => {
                const isRestaurantUser = roleSelect.value === 'restaurant_user';
                restaurantSelect.disabled = !isRestaurantUser;
                restaurantSelect.required = isRestaurantUser;

                if (!isRestaurantUser) {
                    restaurantSelect.value = '';
                }
            });
        }

        // Salvar utilizador
        async function saveUser(formData) {
            try {
                showLoading(true);
                // if (!token) {
                //     showError('Você precisa estar logado para realizar esta ação.');
                //     return;
                // }
                const method = currentUserEditId ? 'PUT' : 'POST';
                const url = currentUserEditId
                    ? `${apiBaseUrl}/users/${currentUserEditId}`
                    : `${apiBaseUrl}/users`;

                const response = await fetch(url, {
                    method: method,
                    headers: {
                        'Content-Type': 'application/json',
                        // 'Authorization': `Bearer ${getAuthToken()}`
                    },
                    body: JSON.stringify(formData)
                });

                const data = await response.json();

                if (data.success) {
                    showSuccess(currentUserEditId ? 'Utilizador atualizado com sucesso!' : 'Utilizador criado com sucesso!');
                    closeModal('user');
                    await loadUsers();
                    await loadStats(); // Atualizar estatísticas
                } else {
                    throw new Error(data.message || 'Erro ao salvar utilizador');
                }
            } catch (error) {
                showError('Erro ao salvar: ' + error.message);
            } finally {
                showLoading(false);
            }
        }

        // Editar utilizador
        async function editUser(id) {
            try {
                const response = await fetch(`${apiBaseUrl}/users/${id}`, {
                    headers: {
                        'Authorization': `Bearer ${getAuthToken()}`
                    }
                });
                const data = await response.json();

                if (data.success) {
                    openUserModal(data.data);
                } else {
                    throw new Error('Utilizador não encontrado');
                }
            } catch (error) {
                showError('Erro ao carregar utilizador: ' + error.message);
            }
        }

        // Alternar status do utilizador
        async function toggleUserStatus(id, currentStatus) {
            try {
                showLoading(true);

                const endpoint = currentStatus
                    ? `${apiBaseUrl}/users/${id}` // DELETE para inativar
                    : `${apiBaseUrl}/users/${id}/reactivate`; // PATCH para reativar

                const method = currentStatus ? 'DELETE' : 'PATCH';

                const response = await fetch(endpoint, {
                    method,
                    headers: {
                        'Authorization': `Bearer ${getAuthToken()}`
                    }
                });
                const data = await response.json();

                if (data.success) {
                    showSuccess(`Utilizador ${currentStatus ? 'inativado' : 'reativado'} com sucesso!`);
                    await loadUsers();
                } else {
                    throw new Error(data.message);
                }
            } catch (error) {
                showError('Erro: ' + error.message);
            } finally {
                showLoading(false);
            }
        }

        // Deletar utilizador
        async function deleteUser(id) {
            const user = allUsersData.find(u => u.id === id);
            if (!user) return;

            const confirmMsg = `Tem certeza que deseja inativar o utilizador "${user.name}"?\n\nEsta ação pode ser revertida posteriormente.`;

            if (!confirm(confirmMsg)) return;

            await toggleUserStatus(id, true);
        }

        // Limpar filtros de utilizadores
        function clearUserFilters() {
            document.getElementById('userSearch').value = '';
            document.getElementById('userRestaurantFilter').value = '';
            document.getElementById('userRoleFilter').value = '';
            document.getElementById('userStatusFilter').value = '';
            applyUserFilters();
        }

        // Configurar filtros de utilizadores
        function setupUserFilters() {
            const searchInput = document.getElementById('userSearch');
            const restaurantFilter = document.getElementById('userRestaurantFilter');
            const roleFilter = document.getElementById('userRoleFilter');
            const statusFilter = document.getElementById('userStatusFilter');

            if (searchInput) {
                let searchTimeout;
                searchInput.addEventListener('input', () => {
                    clearTimeout(searchTimeout);
                    searchTimeout = setTimeout(applyUserFilters, 300);
                });
            }

            [restaurantFilter, roleFilter, statusFilter].forEach(filter => {
                if (filter) {
                    filter.addEventListener('change', applyUserFilters);
                }
            });
        }


        // Navigation functionality
        function initNavigation() {
            // Add hovered class to selected list item
            let list = document.querySelectorAll(".navigation li.nav-item");

            function activeLink() {
                list.forEach((item) => {
                    item.classList.remove("hovered");
                });
                this.classList.add("hovered");

                // Show corresponding section
                const section = this.getAttribute('data-section');
                console.log("Section ", section);
                showSection(section);
            }

            list.forEach((item) => item.addEventListener("click", activeLink));

            // Menu Toggle
            let toggle = document.querySelector(".toggle");
            let navigation = document.querySelector(".navigation");
            let main = document.querySelector(".main");

            toggle.onclick = function () {
                navigation.classList.toggle("active");
                main.classList.toggle("active");
            };
        }

        // Section management
        function showSection(sectionName) {
            // Hide all sections
            document.querySelectorAll('.content-section').forEach(section => {
                section.classList.remove('active');
            });

            // Show selected section
            document.getElementById(sectionName).classList.add('active');

            // Load data for specific sections
            if (sectionName === 'restaurants') {
                loadRestaurants();
            } else if (sectionName === 'categories') {
                loadCategories();
            } else if (sectionName === 'products') {
                loadProducts();
            } else if (sectionName === 'orders') {
                loadOrders();
            }
             else if (sectionName === 'tables') {
                loadTables();
            } 
        }

        // API Functions
        // Funções específicas para cada stat
        async function loadRestaurantStats() {
            try {
                const response = await fetch(`${apiBaseUrl}/restaurants/stats`);
                const data = await response.json();

                if (data.success) {
                    document.getElementById('restaurantCount').textContent = data.data?.active || 0;
                }
            } catch (error) {
                console.error('Erro ao carregar stats de restaurantes:', error);
                document.getElementById('restaurantCount').textContent = '--';
            }
        }

        async function loadCategoryStats() {
            try {
                let url = `${apiBaseUrl}/categories/stats`;

                // Filtrar por restaurante se for restaurant_user
                if (currentUser?.role === 'restaurant_user' && currentUser.restaurant_id) {
                    url += `?restaurant_id=${currentUser.restaurant_id}`;
                }

                const response = await fetch(url);
                const data = await response.json();

                if (data.success) {
                    document.getElementById('categoryCount').textContent = data.data?.active || 0;
                }
            } catch (error) {
                console.error('Erro ao carregar stats de categorias:', error);
                document.getElementById('categoryCount').textContent = '--';
            }
        }

        async function loadProductStats() {
            try {
                let url = `${apiBaseUrl}/products/stats`;

                // Filtrar por restaurante se for restaurant_user
                if (currentUser?.role === 'restaurant_user' && currentUser.restaurant_id) {
                    url += `?restaurant_id=${currentUser.restaurant_id}`;
                }

                const response = await fetch(url);
                const data = await response.json();

                if (data.success) {
                    document.getElementById('productCount').textContent = data.data?.available || 0;
                }
            } catch (error) {
                console.error('Erro ao carregar stats de produtos:', error);
                document.getElementById('productCount').textContent = '--';
            }
        }

        async function loadPromotionStats() {
            try {
                let url = `${apiBaseUrl}/products/stats`;

                // Filtrar por restaurante se for restaurant_user  
                if (currentUser?.role === 'restaurant_user' && currentUser.restaurant_id) {
                    url += `?restaurant_id=${currentUser.restaurant_id}`;
                }

                const response = await fetch(url);
                const data = await response.json();

                if (data.success) {
                    document.getElementById('promotionCount').textContent = data.data?.on_promotion || 0;
                }
            } catch (error) {
                console.error('Erro ao carregar stats de promoções:', error);
                document.getElementById('promotionCount').textContent = '--';
            }
        }

        async function loadUserStats() {
            try {
                const response = await fetch(`${apiBaseUrl}/users/stats`, {
                    headers: {
                        credentials: 'include'
                    }
                });
                const data = await response.json();

                if (data.success) {
                    document.getElementById('userCount').textContent = data.data?.active_users || 0;
                }
            } catch (error) {
                console.error('Erro ao carregar stats de usuários:', error);
                document.getElementById('userCount').textContent = '--';
            }
        }

        // Mostrar/ocultar loading nos cards de stats
        function showStatsLoading(show) {
            const statElements = [
                'restaurantCount',
                'categoryCount',
                'productCount',
                'promotionCount',
                'userCount'
            ];

            statElements.forEach(id => {
                const element = document.getElementById(id);
                if (element) {
                    if (show) {
                        element.innerHTML = '<div class="stat-loading">...</div>';
                        element.style.opacity = '0.6';
                    } else {
                        element.style.opacity = '1';
                    }
                }
            });
        }
        // Carregar stats sem bloquear a UI

        // Carregar dados apenas quando necessário
        async function loadDataConditionally() {
            // Restaurant users não precisam carregar lista de restaurantes
            if (currentUser?.role === 'super_admin') {
                await loadRestaurants();
            }

            // Sempre carregar categorias (filtrado por role)
            await loadCategories();
            await loadCategoriesForProducts();
        }
        async function loadStatsInBackground() {
            try {
                // Mostrar indicadores de carregamento nos cards
                showStatsLoading(true);

                // Carregar stats de forma assíncrona e independente
                const statsPromises = [
                    loadRestaurantStats(),
                    loadCategoryStats(),
                    loadProductStats(),
                    loadPromotionStats(),
                    loadTableStats(), // Carregar stats de mesas
                    loadOrderStats()// Carregar estatísticas de pedidos
                ];

                // Se for super admin, carregar stats de usuários
                if (currentUser?.role === 'super_admin') {
                    statsPromises.push(loadUserStats());
                }

                // Executar todas em paralelo
                await Promise.allSettled(statsPromises);

            } catch (error) {
                console.error('Erro ao carregar estatísticas:', error);
            } finally {
                showStatsLoading(false);
            }
        }

        async function loadStats() {
            try {
                showLoading(true);
                const token = getAuthToken();

                const response = await fetch(`${apiBaseUrl}/restaurants/stats`);
                const data = await response.json();

                const responseCategories = await fetch(`${apiBaseUrl}/categories/stats`);
                const dataCategories = await responseCategories.json();

                // Carregar estatísticas de produtos
                const responseProducts = await fetch(`${apiBaseUrl}/products/stats`);
                const dataProducts = await responseProducts.json();

                // Carregar produtos em promoção
                const responsePromotions = await fetch(`${apiBaseUrl}/products/promotions`);
                const dataPromotions = await responsePromotions.json();

                

                if (currentUser?.role === 'super_admin') {
                    const responseUsers = await fetch(`${apiBaseUrl}/users/stats`, {
                        headers: {
                            credentials: 'include'
                            // 'Authorization': `Bearer ${token}`,
                            // 'Content-Type': 'application/json'
                        }
                    });
                    const dataUsers = await responseUsers.json();

                    if (dataUsers.success) {
                        document.getElementById('userCount').textContent = dataUsers.data?.active_users || 0;
                    }
                }


                if (data.success) {
                    document.getElementById('restaurantCount').textContent = data.data?.active || 0;
                    // You can load other stats here

                }

                if (dataCategories.success) {
                    document.getElementById('categoryCount').textContent = dataCategories.data?.active || 0;
                }

                if (dataProducts.success) {
                    document.getElementById('productCount').textContent = dataProducts.data?.available || 0;
                }

                if (dataPromotions.success) {
                    document.getElementById('promotionCount').textContent = dataPromotions.data?.pagination?.total || 0;
                }


            } catch (error) {
                showError('Erro ao carregar estatísticas: ' + error.message);
            } finally {
                showLoading(false);
            }
        }

        // Carregar estatísticas de mesas
        async function loadTableStats() {
            try {
                let url = `${apiBaseUrl}/tables/stats`;

                // Filtrar por restaurante se for restaurant_user
                if (currentUser?.role === 'restaurant_user' && currentUser.restaurant_id) {
                    url += `?restaurant_id=${currentUser.restaurant_id}`;
                }

                const response = await fetch(url, {
                    headers: { credentials: 'include' }
                });
                const data = await response.json();

                if (data.success) {
                    document.getElementById('tableCount').textContent = data.data?.active || 0;
                }
            } catch (error) {
                console.error('Erro ao carregar stats de mesas:', error);
                document.getElementById('tableCount').textContent = '--';
            }
        }

        // Função para adicionar ao inicializador principal
        function initTablesSection() {
            // Configurar filtros
            setupTableFilters();

            // Configurar formulários
            if (document.getElementById('tableForm')) {
                setupTableForm();
            }

            if (document.getElementById('batchTableForm')) {
                setupBatchTableForm();
            }

            // Carregar dados se a seção de mesas estiver ativa
            if (document.getElementById('tables').classList.contains('active')) {
                loadTables();
            }

            startOrderAutoRefresh();
        }

        async function loadRestaurants() {
            try {
                showLoading(true);
                const response = await fetch(`${apiBaseUrl}/restaurants`);
                const data = await response.json();

                if (data.success && data.data && data.data.data) {
                    restaurantsData = data.data.data;
                    displayRestaurants(restaurantsData);
                    displayRecentRestaurants(restaurantsData.slice(0, 5));
                } else {
                    restaurantsData = [];
                    displayRestaurants([]);
                    displayRecentRestaurants([]);
                }
            } catch (error) {
                showError('Erro ao carregar restaurantes: ' + error.message);
                restaurantsData = [];
                displayRestaurants([]);
                displayRecentRestaurants([]);
            } finally {
                showLoading(false);
            }
        }

        function displayRestaurants(restaurants) {
            const grid = document.getElementById('restaurantGrid');

            if (!restaurants || restaurants.length === 0) {
                grid.innerHTML = `
                    <div style="grid-column: 1 / -1; text-align: center; padding: 60px 20px;">
                        <ion-icon name="storefront-outline" style="font-size: 4rem; color: var(--black2); margin-bottom: 20px;"></ion-icon>
                        <h3 style="color: var(--black2); margin-bottom: 10px;">Nenhum restaurante encontrado</h3>
                        <p style="color: var(--black2); margin-bottom: 30px;">Comece criando seu primeiro restaurante</p>
                        <button class="btn-primary" onclick="openModal('restaurant')">
                            <ion-icon name="add-outline" style="margin-right: 8px;"></ion-icon>
                            Criar Restaurante
                        </button>
                    </div>
                `;
                return;
            }

            grid.innerHTML = restaurants.map(restaurant => `
                <div class="restaurant-card">
                    <h3>${restaurant.name}</h3>
                    <div class="info">
                        <p><ion-icon name="location-outline"></ion-icon> ${restaurant.city || 'Cidade não informada'}</p>
                        <p><ion-icon name="call-outline"></ion-icon> ${restaurant.phone || 'Telefone não informado'}</p>
                        <p><ion-icon name="mail-outline"></ion-icon> ${restaurant.email || 'Email não informado'}</p>
                        <p><span class="status ${restaurant.is_active ? 'active' : 'inactive'}">${restaurant.is_active ? 'Ativo' : 'Inativo'}</span></p>
                    </div>
                    <div class="actions">
                        <button class="btn-sm btn-edit" onclick="editRestaurant(${restaurant.id})">
                            <ion-icon name="create-outline"></ion-icon>
                        </button>
                        <button class="btn-sm btn-view" onclick="viewMenu(${restaurant.id})">
                            <ion-icon name="list-outline"></ion-icon>
                        </button>
                        <button class="btn-sm btn-delete" onclick="deleteRestaurant(${restaurant.id})">
                            <ion-icon name="trash-outline"></ion-icon>
                        </button>
                    </div>
                </div>
            `).join('');
        }

        function displayRecentRestaurants(restaurants) {
            const tbody = document.getElementById('recentRestaurants');

            if (!restaurants || restaurants.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="4" style="text-align: center; padding: 20px; color: var(--black2);">
                            Nenhum restaurante encontrado
                        </td>
                    </tr>
                `;
                return;
            }

            tbody.innerHTML = restaurants.map(restaurant => `
                <tr>
                    <td>${restaurant.name}</td>
                    <td>${restaurant.city || 'N/A'}</td>
                    <td><span class="status ${restaurant.is_active ? 'active' : 'inactive'}">${restaurant.is_active ? 'Ativo' : 'Inativo'}</span></td>
                    <td>
                        <button class="btn-sm btn-edit" onclick="editRestaurant(${restaurant.id})" title="Editar">
                            <ion-icon name="create-outline"></ion-icon>
                        </button>
                        <button class="btn-sm btn-view" onclick="viewMenu(${restaurant.id})" title="Ver Menu">
                            <ion-icon name="list-outline"></ion-icon>
                        </button>
                    </td>
                </tr>
            `).join('');
        }

        // Modal Functions
        function openModal(type, data = null) {


            if (type === 'restaurant' && currentUser?.role === 'super_admin') {
                const modal = document.getElementById('restaurantModal');
                const title = document.getElementById('modalTitle');
                const form = document.getElementById('restaurantForm');

                currentEditId = data ? data.id : null;
                title.textContent = data ? 'Editar Restaurante' : 'Novo Restaurante';

                if (data) {
                    document.getElementById('name').value = data.name || '';
                    document.getElementById('address').value = data.address || '';
                    document.getElementById('city').value = data.city || '';
                    document.getElementById('phone').value = data.phone || '';
                    document.getElementById('email').value = data.email || '';
                    document.getElementById('description').value = data.description || '';
                } else {
                    form.reset();
                }

                modal.style.display = 'block';
            } else if (type === 'category') {
                const modal = document.getElementById('categoryModal');
                const title = document.getElementById('categoryModalTitle');
                const form = document.getElementById('categoryForm');

                currentEditId = data ? data.id : null;
                title.textContent = data ? 'Editar Categoria' : 'Nova Categoria';

                // Populate restaurant select
                const restaurantSelect = document.getElementById('categoryRestaurant');
                restaurantSelect.innerHTML = '<option value="">Selecione um restaurante</option>';
                restaurantsData.forEach(restaurant => {
                    const option = document.createElement('option');
                    option.value = restaurant.id;
                    option.textContent = restaurant.name;
                    restaurantSelect.appendChild(option);
                });

                if (data) {
                    document.getElementById('categoryRestaurant').value = data.restaurant_id;
                    document.getElementById('categoryName').value = data.name || '';
                    document.getElementById('categoryDescription').value = data.description || '';
                    document.getElementById('categoryImage').value = data.image_url || '';
                } else {
                    form.reset();
                }

                if (currentUser?.role === 'restaurant_user' && currentUser.restaurant_id) {
                    document.getElementById('categoryRestaurant').value = currentUser.restaurant_id;
                    document.getElementById('categoryRestaurant').disabled = true;
                }
                modal.style.display = 'block';
            } else if (type === 'product') {
                openProductModal(data);
                return;
            } else if (type === 'user') {
                openUserModal(data);
                return;
            } else if (type === 'table') {
                openTableModal(data);
            }
            else {
                form.reset();
            }

            modal.style.display = 'block';
        }

        function closeModal(type) {
            if (type === 'restaurant') {
                document.getElementById('restaurantModal').style.display = 'none';
            } else if (type === 'category') {
                document.getElementById('categoryModal').style.display = 'none';
            }
            else if (type === 'product') {
                document.getElementById('productModal').style.display = 'none';
            } else if (type === 'user') {
                document.getElementById('userModal').style.display = 'none';
            } else if (type === 'table') {
                document.getElementById('tableModal').style.display = 'none';
                currentTableEditId = null;
            }
            currentEditId = null;
        }

        // CRUD Operations
        async function saveRestaurant(formData) {
            try {
                showLoading(true);

                const method = currentEditId ? 'PUT' : 'POST';
                const url = currentEditId
                    ? `${apiBaseUrl}/restaurants/${currentEditId}`
                    : `${apiBaseUrl}/restaurants`;

                const response = await fetch(url, {
                    method: method,
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(formData)
                });

                const data = await response.json();

                if (data.success) {
                    showSuccess(currentEditId ? 'Restaurante atualizado com sucesso!' : 'Restaurante criado com sucesso!');
                    closeModal('restaurant');
                    await loadRestaurants();
                    await loadStats();
                } else {
                    throw new Error(data.message || 'Erro ao salvar restaurante');
                }
            } catch (error) {
                showError('Erro ao salvar: ' + error.message);
            } finally {
                showLoading(false);
            }
        }

        function editRestaurant(id) {
            const restaurant = restaurantsData.find(r => r.id === id);
            if (restaurant) {
                openModal('restaurant', restaurant);
            }
        }

        async function deleteRestaurant(id) {
            const restaurant = restaurantsData.find(r => r.id === id);
            if (!restaurant) return;

            if (!confirm(`Tem certeza que deseja deletar o restaurante "${restaurant.name}"?`)) {
                return;
            }

            try {
                showLoading(true);
                const response = await fetch(`${apiBaseUrl}/restaurants/${id}`, {
                    method: 'DELETE'
                });

                const data = await response.json();

                if (data.success) {
                    showSuccess('Restaurante deletado com sucesso!');
                    await loadRestaurants();
                    await loadStats();
                } else {
                    throw new Error(data.message || 'Erro ao deletar restaurante');
                }
            } catch (error) {
                showError('Erro ao deletar: ' + error.message);
            } finally {
                showLoading(false);
            }
        }

        function viewMenu(id) {
            const url = `${apiBaseUrl}/menu/restaurant/${id}`;
            window.open(url, '_blank');
        }

        // Função para alternar opções de impressão baseado no tipo selecionado
        function togglePrintOptions() {
            const printType = document.querySelector('input[name="printType"]:checked').value;
            const tablesPrintOptions = document.getElementById('tablesPrintOptions');
            const restaurantPrintOptions = document.getElementById('restaurantPrintOptions');

            if (printType === 'restaurant') {
                tablesPrintOptions.style.display = 'none';
                restaurantPrintOptions.style.display = 'block';
            } else {
                tablesPrintOptions.style.display = 'block';
                restaurantPrintOptions.style.display = 'none';
            }
        }

        // Abrir página de impressão (função atualizada)
        function openPrintPage() {
            const restaurantId = document.getElementById('qrRestaurant').value;
            if (!restaurantId) {
                showError('Selecione um restaurante');
                return;
            }

            const printType = document.querySelector('input[name="printType"]:checked').value;
            let url = `${apiBaseUrl}/qr/restaurant/${restaurantId}/print?type=${printType}`;

            if (printType === 'tables') {
                const printSelection = document.querySelector('input[name="printSelection"]:checked').value;

                if (printSelection === 'selected') {
                    const tableNumbers = document.getElementById('printTableNumbers').value.trim();
                    if (!tableNumbers) {
                        showError('Digite os números das mesas para impressão');
                        return;
                    }
                    url += `&table_numbers=${encodeURIComponent(tableNumbers)}`;
                }
            }

            window.open(url, '_blank');
        }

        // Função para gerar QR do restaurante (ação rápida) - nova função
        async function generateRestaurantQR(restaurantId) {
            try {
                showLoading(true);

                const response = await fetch(`${apiBaseUrl}/qr/restaurant/${restaurantId}?format=json`, {
                    headers: { credentials: 'include' }
                });

                const data = await response.json();

                if (data.success) {
                    showSuccess('QR Code do restaurante gerado!');

                    // Opção de download
                    if (confirm('QR Code do restaurante gerado! Deseja fazer download?')) {
                        const link = document.createElement('a');
                        link.href = data.data.qr_code.data_url;
                        link.download = `qr-restaurante-${restaurantId}.png`;
                        document.body.appendChild(link);
                        link.click();
                        document.body.removeChild(link);
                    }
                } else {
                    throw new Error(data.message);
                }

            } catch (error) {
                showError('Erro ao gerar QR: ' + error.message);
            } finally {
                showLoading(false);
            }
        }

        // Função para mostrar informações detalhadas do QR do restaurante
        function showRestaurantQRInfo(restaurantId) {
            const restaurant = restaurantsData.find(r => r.id === restaurantId);
            if (!restaurant) {
                showError('Restaurante não encontrado');
                return;
            }

            const baseUrl = process.env.WEBAPP_URL || "https://euler-js.github.io/foodway";
            const menuUrl = `${baseUrl}/?restaurant=${restaurant.uuid}`;

            const infoHtml = `
        <div style="background: white; padding: 30px; border-radius: 15px; max-width: 500px; margin: 20px auto;">
            <h3 style="color: var(--primary-color); margin-bottom: 20px; text-align: center;">
                <ion-icon name="qr-code-outline"></ion-icon>
                QR Code do Restaurante
            </h3>
            
            <div style="background: #f8f9fa; padding: 15px; border-radius: 8px; margin-bottom: 20px;">
                <h4 style="margin-bottom: 10px;">${restaurant.name}</h4>
                <p style="margin: 5px 0;"><strong>Cidade:</strong> ${restaurant.city || 'Não informada'}</p>
                <p style="margin: 5px 0;"><strong>URL do Menu:</strong></p>
                <p style="font-size: 0.9rem; word-break: break-all; color: #666;">${menuUrl}</p>
            </div>
            
            <div style="text-align: center;">
                <button class="btn-primary" onclick="generateRestaurantQR(${restaurantId}); this.closest('.modal').style.display='none'">
                    <ion-icon name="download-outline"></ion-icon>
                    Gerar & Download QR
                </button>
                <button class="btn-secondary" onclick="copyToClipboard('${menuUrl}'); this.closest('.modal').style.display='none'">
                    <ion-icon name="copy-outline"></ion-icon>
                    Copiar URL
                </button>
            </div>
        </div>
    `;

            // Criar modal temporário para mostrar info
            const modal = document.createElement('div');
            modal.className = 'modal';
            modal.style.display = 'block';
            modal.innerHTML = `
        <div style="display: flex; align-items: center; justify-content: center; min-height: 100vh;">
            ${infoHtml}
            <span class="close" onclick="this.closest('.modal').remove()" style="position: absolute; top: 20px; right: 30px; font-size: 2rem;">&times;</span>
        </div>
    `;

            document.body.appendChild(modal);

            // Remover modal ao clicar fora
            modal.addEventListener('click', (e) => {
                if (e.target === modal) {
                    modal.remove();
                }
            });
        }

        // Utility Functions
        function showLoading(show) {
            document.getElementById('loading').style.display = show ? 'block' : 'none';
        }

        function showSuccess(message) {
            const alert = document.getElementById('successAlert');
            alert.textContent = message;
            alert.style.display = 'block';
            setTimeout(() => {
                alert.style.display = 'none';
            }, 5000);
        }

        function showError(message) {
            const alert = document.getElementById('errorAlert');
            alert.textContent = message;
            alert.style.display = 'block';
            setTimeout(() => {
                alert.style.display = 'none';
            }, 5000);
        }

        async function refreshData() {
            await loadStats();
            await loadRestaurants();
            showSuccess('Dados atualizados com sucesso!');
        }

        // Search functionality
        function setupSearch() {
            const searchInput = document.getElementById('searchInput');
            searchInput.addEventListener('input', (e) => {
                const term = e.target.value.toLowerCase();
                const filtered = restaurantsData.filter(restaurant =>
                    restaurant.name.toLowerCase().includes(term) ||
                    (restaurant.city && restaurant.city.toLowerCase().includes(term)) ||
                    (restaurant.email && restaurant.email.toLowerCase().includes(term))
                );
                displayRestaurants(filtered);
            });
        }

        // Form handling
        function setupForms() {
            document.getElementById('restaurantForm').addEventListener('submit', async (e) => {
                e.preventDefault();

                const formData = {
                    name: document.getElementById('name').value,
                    address: document.getElementById('address').value,
                    city: document.getElementById('city').value,
                    phone: document.getElementById('phone').value,
                    email: document.getElementById('email').value,
                    description: document.getElementById('description').value
                };

                await saveRestaurant(formData);
            });
        }

        // Close modal when clicking outside
        window.onclick = function (event) {
            const restaurantModal = document.getElementById('restaurantModal');
            const categoryModal = document.getElementById('categoryModal');
            const productModal = document.getElementById('productModal');
            const logoutModal = document.getElementById('logoutModal');
            const profileModal = document.getElementById('profileModal');
            const passwordModal = document.getElementById('passwordModal');
            const batchTableModal = document.getElementById('batchTableModal');
            const qrManagerModal = document.getElementById('qrManagerModal');
            const tableModal = document.getElementById('tableModal');
            const newOrderModal = document.getElementById('newOrderModal');

            if (event.target === restaurantModal) {
                closeModal('restaurant');
            } else if (event.target === categoryModal) {
                closeModal('category');
            } else if (event.target === productModal) {
                closeModal('product');
            } else if (event.target === logoutModal) {
                closeLogoutModal();
            } else if (event.target === profileModal) {
                closeProfileModal();
            } else if (event.target === passwordModal) {
                closePasswordModal();
            } else if (event.target === batchTableModal) {
                closeBatchTableModal();
            } else if (event.target === qrManagerModal) {
                closeQRManagerModal();
            } else if (event.target === tableModal) {
                closeModal('table');
            } else if (event.target === newOrderModal) { // ADICIONAR ESTA LINHA
                closeNewOrderModal(); // ADICIONAR ESTA LINHA
            }
        }

        // Initialize everything
        // Initialize everything

        document.addEventListener('DOMContentLoaded', async () => {
            try {
                // Mostrar loading
                showInitialLoading(true);

                // Configurar componentes básicos
                initNavigation();
                setupSearch();
                setupForms();

                // PRIMEIRO: Carregar usuário e mostrar interface básica
                await loadUserInfo();
                controlRoleBasedAccess();

                // MOSTRAR DASHBOARD RAPIDAMENTE (sem aguardar stats)
                setTimeout(() => {
                    showInitialLoading(false);
                }, 500);

                // SEGUNDO: Carregar stats em background (sem bloquear UI)
                loadStatsInBackground();

                // TERCEIRO: Carregar dados essenciais
                await Promise.allSettled([
                    loadRestaurants(),
                    loadCategories(),
                    loadCategoriesForProducts()
                ]);

                // Configurar componentes avançados
                setTimeout(() => {
                    setupCategoryFilters();
                    if (document.getElementById('productForm')) {
                        setupProductForm();
                    }
                    if (document.getElementById('productSearch')) {
                        setupProductFilters();
                    }
                    if (document.getElementById('userGrid') && currentUser?.role === 'super_admin') {
                        loadUsers();
                        setupUserFilters();
                        setupUserForm();
                    }
                }, 100);

                // Auto-refresh otimizado
                setInterval(() => {
                    loadStatsInBackground();
                }, 5 * 60 * 1000);

                setTimeout(() => {
                    initTablesSection();
                }, 200);

            } catch (error) {
                console.error('Erro ao inicializar dashboard:', error);
                showError('Erro ao carregar dashboard. Recarregue a página.');
                showInitialLoading(false);
            }

            initInactivityMonitor();
            setupPasswordForm();
        });

        //Categorias

        // Categories functions
        async function loadCategories() {
            try {
                showLoading(true);
                let url = `${apiBaseUrl}/categories?limit=100`;

                // Filtrar por restaurante se for restaurant_user
                if (currentUser?.role === 'restaurant_user' && currentUser.restaurant_id) {
                    url += `&restaurant_id=${currentUser.restaurant_id}`;
                }

                const response = await fetch(url);
                const data = await response.json();

                console.log("Dados de Categorias:", data);

                if (data.success && data.data && data.data.data) {
                    allCategoriesData = data.data.data;
                    populateCategoryFilters();
                    applyCategoryFilters();
                } else {
                    allCategoriesData = [];
                    displayCategories([]);
                }
            } catch (error) {
                showError('Erro ao carregar categorias');
                allCategoriesData = [];
                displayCategories([]);
            } finally {
                showLoading(false);
            }
        }

        function displayCategories(categories) {
            const grid = document.getElementById('categoryGrid');

            if (!categories || categories.length === 0) {
                grid.innerHTML = `
            <div style="grid-column: 1 / -1; text-align: center; padding: 40px;">
                <ion-icon name="pricetags-outline" style="font-size: 3rem; color: var(--black2); margin-bottom: 15px;"></ion-icon>
                <h3 style="color: var(--black2); margin-bottom: 10px;">Nenhuma categoria encontrada</h3>
                <p style="color: var(--black2); margin-bottom: 20px;">Tente ajustar os filtros ou criar uma nova categoria</p>
                <button class="btn-primary" onclick="openModal('category')">
                    <ion-icon name="add-outline" style="margin-right: 8px;"></ion-icon>
                    Criar Categoria
                </button>
            </div>
        `;
                return;
            }

            grid.innerHTML = categories.map(category => `
        <div class="category-card">
            <div class="category-header">
                <div>
                    <h3>${category.name}</h3>
                    <div class="category-meta">
                        <span class="sort-order">Ordem: ${category.sort_order || 0}</span>
                    </div>
                </div>
                <span class="status ${category.is_active ? 'active' : 'inactive'}">
                    ${category.is_active ? 'Ativo' : 'Inativo'}
                </span>
            </div>
            
            <div class="category-info">
                <p class="restaurant-info">
                    <ion-icon name="storefront-outline"></ion-icon> 
                    ${category.restaurant?.name || 'Restaurante não encontrado'}
                </p>
                
                ${category.description ? `
                    <p class="description">${category.description.length > 100
                        ? category.description.substring(0, 100) + '...'
                        : category.description}</p>
                ` : '<p class="no-description">Sem descrição</p>'}
                
                <div class="category-stats">
                    <span><ion-icon name="calendar-outline"></ion-icon> ${formatDate(category.created_at)}</span>
                    <span class="products-count" data-category-id="${category.id}">
                        <ion-icon name="fast-food-outline"></ion-icon> 
                        <span class="count">...</span> produtos
                    </span>
                </div>
            </div>
            
            <div class="category-actions">
                <button class="btn-sm btn-edit" onclick="editCategory(${category.id})" title="Editar">
                    <ion-icon name="create-outline"></ion-icon>
                </button>
                <button class="btn-sm btn-success" onclick="viewCategoryProducts(${category.id})" title="Ver Produtos">
                    <ion-icon name="list-outline"></ion-icon>
                </button>
                <button class="btn-sm btn-secondary" onclick="duplicateCategory(${category.id})" title="Duplicar">
                    <ion-icon name="copy-outline"></ion-icon>
                </button>
                <button class="btn-sm ${category.is_active ? 'btn-warning' : 'btn-success'}" 
                        onclick="toggleCategoryStatus(${category.id}, ${category.is_active})" 
                        title="${category.is_active ? 'Inativar' : 'Ativar'}">
                    <ion-icon name="${category.is_active ? 'pause-outline' : 'play-outline'}"></ion-icon>
                </button>
                <button class="btn-sm btn-delete" onclick="deleteCategory(${category.id})" title="Deletar">
                    <ion-icon name="trash-outline"></ion-icon>
                </button>
            </div>
        </div>
    `).join('');

            // Load product counts
            loadCategoryProductCounts();
        }

        // Function to load product counts for each category
        async function loadCategoryProductCounts() {
            const countElements = document.querySelectorAll('.products-count');

            countElements.forEach(async (element) => {
                const categoryId = element.dataset.categoryId;
                try {
                    const response = await fetch(`${apiBaseUrl}/categories/${categoryId}/products/stats`);
                    const data = await response.json();

                    if (data.success && data.data) {
                        const countSpan = element.querySelector('.count');
                        countSpan.textContent = data.data.total || 0;
                    }
                } catch (error) {
                    console.error(`Error loading product count for category ${categoryId}:`, error);
                    const countSpan = element.querySelector('.count');
                    countSpan.textContent = '0';
                }
            });
        }

        // Adicione esta função no final do JavaScript
        document.getElementById('categoryForm').addEventListener('submit', async (e) => {
            e.preventDefault();

            const formData = {
                restaurant_id: parseInt(document.getElementById('categoryRestaurant').value),
                name: document.getElementById('categoryName').value,
                description: document.getElementById('categoryDescription').value,
                image_url: document.getElementById('categoryImage').value
            };

            await saveCategory(formData);
        });

        async function saveCategory(formData) {
            try {
                showLoading(true);

                const method = currentEditId ? 'PUT' : 'POST';
                const url = currentEditId
                    ? `${apiBaseUrl}/categories/${currentEditId}`
                    : `${apiBaseUrl}/categories`;

                const response = await fetch(url, {
                    method: method,
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(formData)
                });

                const data = await response.json();

                if (data.success) {
                    showSuccess(currentEditId ? 'Categoria atualizada!' : 'Categoria criada!');
                    closeModal('category');
                    await loadCategories();
                } else {
                    throw new Error(data.message || 'Erro ao salvar categoria');
                }
            } catch (error) {
                showError('Erro: ' + error.message);
            } finally {
                showLoading(false);
            }
        }

        // Category CRUD functions
        async function editCategory(id) {
            try {
                const response = await fetch(`${apiBaseUrl}/categories/${id}`);
                const data = await response.json();

                if (data.success) {
                    openModal('category', data.data);
                } else {
                    throw new Error('Categoria não encontrada');
                }
            } catch (error) {
                showError('Erro ao carregar categoria: ' + error.message);
            }
        }

        async function deleteCategory(id) {
            // Buscar dados da categoria para confirmação
            try {
                const response = await fetch(`${apiBaseUrl}/categories/${id}`);
                const data = await response.json();

                if (!data.success) {
                    throw new Error('Categoria não encontrada');
                }

                const category = data.data;
                const confirmMsg = `Tem certeza que deseja deletar a categoria "${category.name}"?\n\nEsta ação não pode ser desfeita.`;

                if (!confirm(confirmMsg)) return;

                showLoading(true);

                const deleteResponse = await fetch(`${apiBaseUrl}/categories/${id}`, {
                    method: 'DELETE'
                });

                const deleteData = await deleteResponse.json();

                if (deleteData.success) {
                    showSuccess('Categoria deletada com sucesso!');
                    await loadCategories();
                } else {
                    throw new Error(deleteData.message || 'Erro ao deletar categoria');
                }
            } catch (error) {
                showError('Erro ao deletar: ' + error.message);
            } finally {
                showLoading(false);
            }
        }

        async function toggleCategoryStatus(id, currentStatus) {
            try {
                showLoading(true);

                const endpoint = currentStatus
                    ? `${apiBaseUrl}/categories/${id}` // DELETE para inativar
                    : `${apiBaseUrl}/categories/${id}/reactivate`; // PATCH para reativar

                const method = currentStatus ? 'DELETE' : 'PATCH';

                const response = await fetch(endpoint, { method });
                const data = await response.json();

                if (data.success) {
                    showSuccess(`Categoria ${currentStatus ? 'inativada' : 'reativada'} com sucesso!`);
                    await loadCategories();
                } else {
                    throw new Error(data.message);
                }
            } catch (error) {
                showError('Erro: ' + error.message);
            } finally {
                showLoading(false);
            }
        }

        function displayCategories(categories) {
            const grid = document.getElementById('categoryGrid');

            if (!categories || categories.length === 0) {
                grid.innerHTML = `
            <div style="grid-column: 1 / -1; text-align: center; padding: 40px;">
                <ion-icon name="pricetags-outline" style="font-size: 3rem; color: var(--black2);"></ion-icon>
                <h3 style="color: var(--black2); margin: 15px 0;">Nenhuma categoria encontrada</h3>
                <button class="btn-primary" onclick="openModal('category')">
                    <ion-icon name="add-outline" style="margin-right: 8px;"></ion-icon>
                    Criar Primeira Categoria
                </button>
            </div>
        `;
                return;
            }

            grid.innerHTML = categories.map(category => `
        <div class="category-card">
            <div class="category-header">
                <h3>${category.name}</h3>
                <span class="status ${category.is_active ? 'active' : 'inactive'}">
                    ${category.is_active ? 'Ativo' : 'Inativo'}
                </span>
            </div>
            <div class="category-info">
                <p><ion-icon name="storefront-outline"></ion-icon> ${category.restaurant?.name || 'Restaurante não encontrado'}</p>
                ${category.description ? `<p class="description">${category.description}</p>` : ''}
                <p class="created-date">Criado em ${formatDate(category.created_at)}</p>
            </div>
            <div class="category-actions">
                <button class="btn-sm btn-edit" onclick="editCategory(${category.id})" title="Editar">
                    <ion-icon name="create-outline"></ion-icon>
                </button>
                <button class="btn-sm btn-view" onclick="viewCategoryProducts(${category.id})" title="Ver Produtos">
                    <ion-icon name="list-outline"></ion-icon>
                </button>
                <button class="btn-sm ${category.is_active ? 'btn-warning' : 'btn-success'}" 
                        onclick="toggleCategoryStatus(${category.id}, ${category.is_active})" 
                        title="${category.is_active ? 'Inativar' : 'Ativar'}">
                    <ion-icon name="${category.is_active ? 'pause-outline' : 'play-outline'}"></ion-icon>
                </button>
                <button class="btn-sm btn-delete" onclick="deleteCategory(${category.id})" title="Deletar">
                    <ion-icon name="trash-outline"></ion-icon>
                </button>
            </div>
        </div>
    `).join('');
        }

        // Função auxiliar para formatar data
        function formatDate(dateString) {
            const date = new Date(dateString);
            return date.toLocaleDateString('pt-BR');
        }

        // Função para ver produtos da categoria
        function viewCategoryProducts(categoryId) {
            // Por enquanto, abre uma nova aba com a API
            window.open(`${apiBaseUrl}/categories/${categoryId}/products`, '_blank');
        }

        // Category filtering system
        let allCategoriesData = []; // Store all categories for filtering

        function populateCategoryFilters() {
            const restaurantFilter = document.getElementById('categoryRestaurantFilter');
            restaurantFilter.innerHTML = '<option value="">Todos</option>';

            // Get unique restaurants from categories
            const uniqueRestaurants = [...new Set(allCategoriesData
                .filter(cat => cat.restaurant)
                .map(cat => JSON.stringify({ id: cat.restaurant.id, name: cat.restaurant.name }))
            )].map(str => JSON.parse(str));

            uniqueRestaurants.forEach(restaurant => {
                const option = document.createElement('option');
                option.value = restaurant.id;
                option.textContent = restaurant.name;
                restaurantFilter.appendChild(option);
            });
        }

        function applyCategoryFilters() {
            const searchTerm = document.getElementById('categorySearch')?.value.toLowerCase() || '';
            const restaurantFilter = document.getElementById('categoryRestaurantFilter')?.value || '';
            const statusFilter = document.getElementById('categoryStatusFilter')?.value || '';

            let filteredCategories = [...allCategoriesData];

            // Apply search filter
            if (searchTerm) {
                filteredCategories = filteredCategories.filter(category =>
                    category.name.toLowerCase().includes(searchTerm) ||
                    (category.description && category.description.toLowerCase().includes(searchTerm)) ||
                    (category.restaurant && category.restaurant.name.toLowerCase().includes(searchTerm))
                );
            }

            // Apply restaurant filter
            if (restaurantFilter) {
                filteredCategories = filteredCategories.filter(category =>
                    category.restaurant_id.toString() === restaurantFilter
                );
            }

            // Apply status filter
            if (statusFilter !== '') {
                const isActive = statusFilter === 'true';
                filteredCategories = filteredCategories.filter(category =>
                    category.is_active === isActive
                );
            }

            displayCategories(filteredCategories);
        }

        function clearCategoryFilters() {
            document.getElementById('categorySearch').value = '';
            document.getElementById('categoryRestaurantFilter').value = '';
            document.getElementById('categoryStatusFilter').value = '';
            applyCategoryFilters();
        }

        // Setup filter event listeners
        function setupCategoryFilters() {
            const searchInput = document.getElementById('categorySearch');
            const restaurantFilter = document.getElementById('categoryRestaurantFilter');
            const statusFilter = document.getElementById('categoryStatusFilter');

            if (searchInput) {
                let searchTimeout;
                searchInput.addEventListener('input', () => {
                    clearTimeout(searchTimeout);
                    searchTimeout = setTimeout(applyCategoryFilters, 300);
                });
            }

            if (restaurantFilter) {
                restaurantFilter.addEventListener('change', applyCategoryFilters);
            }

            if (statusFilter) {
                statusFilter.addEventListener('change', applyCategoryFilters);
            }
        }

        async function duplicateCategory(id) {
            try {
                const response = await fetch(`${apiBaseUrl}/categories/${id}`);
                const data = await response.json();

                if (!data.success) {
                    throw new Error('Categoria não encontrada');
                }

                const category = data.data;
                const newName = prompt(`Duplicar categoria "${category.name}"\n\nNovo nome:`, `${category.name} (Cópia)`);

                if (!newName || newName.trim() === '') return;

                showLoading(true);

                const duplicateResponse = await fetch(`${apiBaseUrl}/categories/${id}/duplicate`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ name: newName.trim() })
                });

                const duplicateData = await duplicateResponse.json();

                if (duplicateData.success) {
                    showSuccess('Categoria duplicada com sucesso!');
                    await loadCategories();
                } else {
                    throw new Error(duplicateData.message || 'Erro ao duplicar categoria');
                }
            } catch (error) {
                showError('Erro ao duplicar: ' + error.message);
            } finally {
                showLoading(false);
            }
        }


        /**
         * Carregar todos os produtos
         */
       async function loadProducts(page = 1) {
    try {
        showLoading(true);

        // Construir URL com paginação adequada
        let url = `${apiBaseUrl}/products?limit=20&page=${page}`;

        // Filtrar por restaurante se for restaurant_user
        if (currentUser?.role === 'restaurant_user' && currentUser.restaurant_id) {
            url += `&restaurant_id=${currentUser.restaurant_id}`;
        }

        // Aplicar filtros ativos
        const filters = getCurrentProductFilters();
        if (currentUser?.role === 'restaurant_user' && currentUser.restaurant_id) {
            delete filters.restaurant_id;
        }
        
        Object.keys(filters).forEach(key => {
            if (filters[key] !== null && filters[key] !== '') {
                url += `&${key}=${encodeURIComponent(filters[key])}`;
            }
        });

        console.log('🔍 Carregando produtos - URL:', url);
        console.log('📄 Página atual:', page);

        const response = await fetch(url, {
            headers: { credentials: 'include' }
        });
        
        if (!response.ok) {
            throw new Error(`HTTP ${response.status}: ${response.statusText}`);
        }
        
        const data = await response.json();

        console.log('📦 Dados retornados:', data);
        console.log('📊 Paginação recebida:', data.data?.pagination);

        if (data.success && data.data) {
            if (data.data.data && Array.isArray(data.data.data)) {
                allProductsData = data.data.data;
                await loadCategoriesForProducts();
                populateProductFilters();
                displayProducts(allProductsData);

                // Atualizar informações de paginação
                if (data.data.pagination) {
                    updateProductPagination(data.data.pagination);
                } else {
                    console.warn('⚠️ Paginação não encontrada na resposta');
                    updateProductPagination({
                        page: 1,
                        totalPages: 1,
                        total: allProductsData.length,
                        limit: 20
                    });
                }
            } else {
                console.warn('⚠️ Formato de dados inesperado:', data.data);
                allProductsData = [];
                displayProducts([]);
                updateProductPagination({ page: 1, totalPages: 1, total: 0, limit: 20 });
            }
        } else {
            console.error('❌ Erro na resposta da API:', data);
            allProductsData = [];
            displayProducts([]);
            updateProductPagination({ page: 1, totalPages: 1, total: 0, limit: 20 });
        }
    } catch (error) {
        console.error('❌ Erro ao carregar produtos:', error);
        showError('Erro ao carregar produtos: ' + error.message);
        allProductsData = [];
        displayProducts([]);
        updateProductPagination({ page: 1, totalPages: 1, total: 0, limit: 20 });
    } finally {
        showLoading(false);
    }
}
        // Função para capturar filtros atuais
      function getCurrentProductFilters() {
    const restaurantId = document.getElementById('productRestaurantFilter')?.value;
    const categoryId = document.getElementById('productCategoryFilter')?.value;

    console.log('🔍 Capturando filtros de produtos:', restaurantId, categoryId);
    
    return {
        search: document.getElementById('productSearch')?.value.trim() || null,
        category_id: categoryId && categoryId !== '' ? parseInt(categoryId) : null,
        restaurant_id: restaurantId && restaurantId !== '' ? parseInt(restaurantId) : null,
        is_available: document.getElementById('productStatusFilter')?.value || null,
        is_on_promotion: document.getElementById('productPromotionFilter')?.value || null
    };
}



        /**
         * Carregar categorias para os filtros e formulários
         */
        async function loadCategoriesForProducts() {
            try {
                let url = `${apiBaseUrl}/categories?limit=100`;

                // Filtrar por restaurante se for restaurant_user
                if (currentUser?.role === 'restaurant_user' && currentUser.restaurant_id) {
                    url += `&restaurant_id=${currentUser.restaurant_id}`;
                }

                const response = await fetch(url);
                const data = await response.json();

                if (data.success && data.data && data.data.data) {
                    allCategoriesForProducts = data.data.data;
                }
            } catch (error) {
                console.error('Erro ao carregar categorias:', error);
                allCategoriesForProducts = [];
            }
        }

        /**
         * Exibir produtos na interface
         */
        function displayProducts(products) {
            const grid = document.getElementById('productGrid');

            if (!products || products.length === 0) {
                grid.innerHTML = `
            <div style="grid-column: 1 / -1; text-align: center; padding: 60px 20px;">
                <ion-icon name="fast-food-outline" style="font-size: 4rem; color: var(--black2); margin-bottom: 20px;"></ion-icon>
                <h3 style="color: var(--black2); margin-bottom: 10px;">Nenhum produto encontrado</h3>
                <p style="color: var(--black2); margin-bottom: 30px;">Tente ajustar os filtros ou criar um novo produto</p>
                <button class="btn-primary" onclick="openModal('product')">
                    <ion-icon name="add-outline" style="margin-right: 8px;"></ion-icon>
                    Criar Produto
                </button>
            </div>
        `;
                return;
            }

            grid.innerHTML = products.map(product => {
                const category = product.category || {};
                const restaurant = category.restaurant || {};

                // Calcular desconto se em promoção
                let discountPercent = 0;
                if (product.is_on_promotion && product.current_price < product.regular_price) {
                    discountPercent = Math.round(((product.regular_price - product.current_price) / product.regular_price) * 100);
                }

                return `
            <div class="product-card">
                <div class="product-header">
                    <div class="product-title">
                        <h3>${product.name}</h3>
                        <div class="product-category">
                            <ion-icon name="pricetags-outline"></ion-icon>
                            ${category.name || 'Categoria não encontrada'}
                        </div>
                        <div class="product-category">
                            <ion-icon name="storefront-outline"></ion-icon>
                            ${restaurant.name || 'Restaurante não encontrado'}
                        </div>
                    </div>
                    <div class="product-status-badges">
                        <span class="status ${product.is_available ? 'available' : 'unavailable'}">
                            ${product.is_available ? 'Disponível' : 'Indisponível'}
                        </span>
                        ${product.is_on_promotion ? '<span class="status promotion">Promoção</span>' : ''}
                    </div>
                </div>
                
                <div class="product-price">
                    ${product.is_on_promotion ? `
                        <div class="price-promotion">
                            <span class="price-current">${formatPrice(product.current_price)} MT</span>
                            <span class="price-old">${formatPrice(product.regular_price)} MT</span>
                            ${discountPercent > 0 ? `<span class="discount-badge">-${discountPercent}%</span>` : ''}
                        </div>
                    ` : `
                        <div class="price-regular">${formatPrice(product.current_price)} MT</div>
                    `}
                </div>
                
                ${product.description ? `
                    <div class="product-description">
                        ${product.description.length > 100
                            ? product.description.substring(0, 100) + '...'
                            : product.description}
                    </div>
                ` : ''}
                
                <div class="product-meta">
                    <p><ion-icon name="calendar-outline"></ion-icon> ${formatDate(product.created_at)}</p>
                    <p><ion-icon name="list-outline"></ion-icon> Ordem: ${product.sort_order || 0}</p>
                </div>
                
                <div class="product-actions">
                    <button class="btn-sm btn-edit" onclick="editProduct(${product.id})" title="Editar">
                        <ion-icon name="create-outline"></ion-icon>
                    </button>
                    <button class="btn-sm btn-secondary" onclick="duplicateProduct(${product.id})" title="Duplicar">
                        <ion-icon name="copy-outline"></ion-icon>
                    </button>
                    <button class="btn-sm ${product.is_on_promotion ? 'btn-warning' : 'btn-success'}" 
                            onclick="toggleProductPromotion(${product.id}, ${product.is_on_promotion})" 
                            title="${product.is_on_promotion ? 'Remover Promoção' : 'Aplicar Promoção'}">
                        <ion-icon name="${product.is_on_promotion ? 'pricetag' : 'pricetag-outline'}"></ion-icon>
                    </button>
                    <button class="btn-sm ${product.is_available ? 'btn-warning' : 'btn-success'}" 
                            onclick="toggleProductStatus(${product.id}, ${product.is_available})" 
                            title="${product.is_available ? 'Indisponibilizar' : 'Disponibilizar'}">
                        <ion-icon name="${product.is_available ? 'pause-outline' : 'play-outline'}"></ion-icon>
                    </button>
                    <button class="btn-sm btn-delete" onclick="deleteProduct(${product.id})" title="Deletar">
                        <ion-icon name="trash-outline"></ion-icon>
                    </button>
                </div>
            </div>
        `;
            }).join('');
        }
function updateProductPagination(pagination) {
    if (!pagination) {
        console.warn('⚠️ Paginação não fornecida');
        document.getElementById('productPagination').style.display = 'none';
        return;
    }

    productPagination = pagination;
    currentProductPage = parseInt(pagination.page) || 1;
    totalProductPages = parseInt(pagination.totalPages) || 1;

    console.log('📊 Atualizando paginação:');
    console.log('   - Página atual:', currentProductPage);
    console.log('   - Total de páginas:', totalProductPages);
    console.log('   - Total de itens:', pagination.total);

    // Atualizar elementos da interface
    const currentPageElement = document.getElementById('currentProductPage');
    const totalPagesElement = document.getElementById('totalProductPages');
    const productCountElement = document.getElementById('productCount');
    const productRangeElement = document.getElementById('productRange');

    if (currentPageElement) {
        currentPageElement.textContent = currentProductPage;
        console.log('✅ Página atual atualizada:', currentProductPage);
    }
    
    if (totalPagesElement) {
        totalPagesElement.textContent = totalProductPages;
        console.log('✅ Total de páginas atualizado:', totalProductPages);
    }
    
    if (productCountElement) {
        productCountElement.textContent = pagination.total || 0;
        console.log('✅ Total de produtos atualizado:', pagination.total);
    }

    // Calcular range de produtos exibidos
    const limit = parseInt(pagination.limit) || 20;
    const total = parseInt(pagination.total) || 0;
    const start = Math.max(1, ((currentProductPage - 1) * limit) + 1);
    const end = Math.min(currentProductPage * limit, total);
    
    if (productRangeElement) {
        productRangeElement.textContent = total > 0 ? `${start}-${end}` : '0-0';
        console.log('✅ Range atualizado:', `${start}-${end}`);
    }

    // Controlar botões
    const prevBtn = document.getElementById('prevProductPage');
    const nextBtn = document.getElementById('nextProductPage');

    if (prevBtn) {
        const canGoPrev = currentProductPage > 1;
        prevBtn.disabled = !canGoPrev;
        prevBtn.style.opacity = canGoPrev ? '1' : '0.5';
        prevBtn.style.cursor = canGoPrev ? 'pointer' : 'not-allowed';
        console.log('✅ Botão anterior:', canGoPrev ? 'habilitado' : 'desabilitado');
    }
    
    if (nextBtn) {
        const canGoNext = currentProductPage < totalProductPages;
        nextBtn.disabled = !canGoNext;
        nextBtn.style.opacity = canGoNext ? '1' : '0.5';
        nextBtn.style.cursor = canGoNext ? 'pointer' : 'not-allowed';
        console.log('✅ Botão próximo:', canGoNext ? 'habilitado' : 'desabilitado');
    }

    // Mostrar/ocultar paginação
    const paginationContainer = document.getElementById('productPagination');
    if (paginationContainer) {
        const shouldShow = totalProductPages > 1 || total > 0;
        paginationContainer.style.display = shouldShow ? 'block' : 'none';
        console.log('✅ Container de paginação:', shouldShow ? 'visível' : 'oculto');
    }
}
        /**
         * Abrir modal de produto (criar/editar)
         */
        function openProductModal(data = null) {
            const modal = document.getElementById('productModal');
            const title = document.getElementById('productModalTitle');
            const form = document.getElementById('productForm');

            currentEditId = data ? data.id : null;
            title.textContent = data ? 'Editar Produto' : 'Novo Produto';

            // Popular select de categorias
            const categorySelect = document.getElementById('productCategory');
            categorySelect.innerHTML = '<option value="">Selecione uma categoria</option>';
            allCategoriesForProducts.forEach(category => {
                const option = document.createElement('option');
                option.value = category.id;
                option.textContent = `${category.name} (${category.restaurant?.name || 'Sem restaurante'})`;
                categorySelect.appendChild(option);
            });

            if (data) {
                document.getElementById('productCategory').value = data.category_id;
                document.getElementById('productName').value = data.name || '';
                document.getElementById('productDescription').value = data.description || '';
                document.getElementById('productRegularPrice').value = data.regular_price || '';
                document.getElementById('productCurrentPrice').value = data.current_price || '';
                document.getElementById('productSortOrder').value = data.sort_order || '';
                document.getElementById('productImage').value = data.image_url || '';
                document.getElementById('productPromotion').checked = data.is_on_promotion || false;
                document.getElementById('productAvailable').checked = data.is_available !== false;
            } else {
                form.reset();
                document.getElementById('productAvailable').checked = true;
            }
            // if (currentUser?.role === 'restaurant_user' && currentUser.restaurant_id) {
            //     allCategoriesForProducts = allCategoriesForProducts.filter(cat => 
            //         cat.restaurant_id === currentUser.restaurant_id
            //     );
            // }
            modal.style.display = 'block';
        }


        // Modal de mesa individual
        function openTableModal(data = null) {
            const modal = document.getElementById('tableModal');
            const title = document.getElementById('tableModalTitle');
            const form = document.getElementById('tableForm');

            currentTableEditId = data ? data.id : null;
            title.textContent = data ? 'Editar Mesa' : 'Nova Mesa';

            // Popular select de restaurantes
            const restaurantSelect = document.getElementById('tableRestaurant');
            restaurantSelect.innerHTML = '<option value="">Selecione um restaurante</option>';
            restaurantsData.forEach(restaurant => {
                const option = document.createElement('option');
                option.value = restaurant.id;
                option.textContent = restaurant.name;
                restaurantSelect.appendChild(option);
            });

            if (data) {
                document.getElementById('tableRestaurant').value = data.restaurant_id || '';
                document.getElementById('tableNumber').value = data.table_number || '';
                document.getElementById('tableName').value = data.name || '';
                document.getElementById('tableCapacity').value = data.capacity || 4;
                document.getElementById('tableActive').checked = data.is_active !== false;
            } else {
                form.reset();
                document.getElementById('tableCapacity').value = 4;
                document.getElementById('tableActive').checked = true;
            }

            // Se for restaurant_user, pré-selecionar restaurante
            if (currentUser?.role === 'restaurant_user' && currentUser.restaurant_id) {
                document.getElementById('tableRestaurant').value = currentUser.restaurant_id;
                document.getElementById('tableRestaurant').disabled = true;
            }

            modal.style.display = 'block';
        }

        /**
         * Salvar produto (criar/editar)
         */
        async function saveProduct(formData) {
            try {
                showLoading(true);

                const method = currentEditId ? 'PUT' : 'POST';
                const url = currentEditId
                    ? `${apiBaseUrl}/products/${currentEditId}`
                    : `${apiBaseUrl}/products`;

                const response = await fetch(url, {
                    method: method,
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(formData)
                });

                const data = await response.json();

                if (data.success) {
                    showSuccess(currentEditId ? 'Produto atualizado com sucesso!' : 'Produto criado com sucesso!');
                    closeModal('product');
                    await loadProducts();
                    await loadStats(); // Atualizar estatísticas
                } else {
                    throw new Error(data.message || 'Erro ao salvar produto');
                }
            } catch (error) {
                showError('Erro ao salvar: ' + error.message);
            } finally {
                showLoading(false);
            }
        }

        /**
         * Editar produto
         */
        async function editProduct(id) {
            try {
                const response = await fetch(`${apiBaseUrl}/products/${id}`);
                const data = await response.json();

                if (data.success) {
                    openProductModal(data.data);
                } else {
                    throw new Error('Produto não encontrado');
                }
            } catch (error) {
                showError('Erro ao carregar produto: ' + error.message);
            }
        }

        /**
         * Deletar produto
         */
        async function deleteProduct(id) {
            const product = allProductsData.find(p => p.id === id);
            if (!product) return;

            const confirmMsg = `Tem certeza que deseja deletar o produto "${product.name}"?\n\nEsta ação não pode ser desfeita.`;

            if (!confirm(confirmMsg)) return;

            try {
                showLoading(true);

                const response = await fetch(`${apiBaseUrl}/products/${id}`, {
                    method: 'DELETE'
                });

                const data = await response.json();

                if (data.success) {
                    showSuccess('Produto deletado com sucesso!');
                    await loadProducts();
                    await loadStats();
                } else {
                    throw new Error(data.message || 'Erro ao deletar produto');
                }
            } catch (error) {
                showError('Erro ao deletar: ' + error.message);
            } finally {
                showLoading(false);
            }
        }

        /**
         * Duplicar produto
         */
        async function duplicateProduct(id) {
            try {
                const response = await fetch(`${apiBaseUrl}/products/${id}`);
                const data = await response.json();

                if (!data.success) {
                    throw new Error('Produto não encontrado');
                }

                const product = data.data;
                const newName = prompt(`Duplicar produto "${product.name}"\n\nNovo nome:`, `${product.name} (Cópia)`);

                if (!newName || newName.trim() === '') return;

                showLoading(true);

                const duplicateResponse = await fetch(`${apiBaseUrl}/products/${id}/duplicate`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ name: newName.trim() })
                });

                const duplicateData = await duplicateResponse.json();

                if (duplicateData.success) {
                    showSuccess('Produto duplicado com sucesso!');
                    await loadProducts();
                } else {
                    throw new Error(duplicateData.message || 'Erro ao duplicar produto');
                }
            } catch (error) {
                showError('Erro ao duplicar: ' + error.message);
            } finally {
                showLoading(false);
            }
        }


        /**
         * Alternar status de disponibilidade do produto
         */
        async function toggleProductStatus(id, currentStatus) {
            try {
                showLoading(true);

                const endpoint = currentStatus
                    ? `${apiBaseUrl}/products/${id}` // DELETE para indisponibilizar
                    : `${apiBaseUrl}/products/${id}/reactivate`; // PATCH para reativar

                const method = currentStatus ? 'DELETE' : 'PATCH';

                const response = await fetch(endpoint, { method });
                const data = await response.json();

                if (data.success) {
                    showSuccess(`Produto ${currentStatus ? 'indisponibilizado' : 'disponibilizado'} com sucesso!`);
                    await loadProducts();
                } else {
                    throw new Error(data.message);
                }
            } catch (error) {
                showError('Erro: ' + error.message);
            } finally {
                showLoading(false);
            }
        }


        /**
         * Alternar promoção do produto
         */
        async function toggleProductPromotion(id, isOnPromotion) {
            try {
                let promotionPrice = null;

                if (!isOnPromotion) {
                    // Aplicar promoção - pedir preço promocional
                    const product = allProductsData.find(p => p.id === id);
                    const priceInput = prompt(
                        `Aplicar promoção ao produto "${product.name}"\n\nPreço regular: ${product.regular_price} MT\nDigite o novo preço promocional:`,
                        (product.regular_price * 0.8).toFixed(2) // Sugerir 20% de desconto
                    );

                    if (!priceInput) return;

                    promotionPrice = parseFloat(priceInput);

                    if (isNaN(promotionPrice) || promotionPrice <= 0 || promotionPrice >= product.regular_price) {
                        showError('Preço promocional deve ser um número válido e menor que o preço regular');
                        return;
                    }
                }

                showLoading(true);

                const response = await fetch(`${apiBaseUrl}/products/${id}/promotion`, {
                    method: 'PATCH',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ promotion_price: promotionPrice })
                });

                const data = await response.json();

                if (data.success) {
                    showSuccess(`Promoção ${isOnPromotion ? 'removida' : 'aplicada'} com sucesso!`);
                    await loadProducts();
                } else {
                    throw new Error(data.message);
                }
            } catch (error) {
                showError('Erro: ' + error.message);
            } finally {
                showLoading(false);
            }
        }


        /**
         * Popular filtros de produtos
         */
        // function populateProductFilters() {
        //     // Popular filtro de categorias
        //     const categoryFilter = document.getElementById('productCategoryFilter');
        //     categoryFilter.innerHTML = '<option value="">Todas</option>';

        //     const uniqueCategories = [...new Set(allProductsData
        //         .filter(product => product.category)
        //         .map(product => JSON.stringify({
        //             id: product.category.id, 
        //             name: product.category.name,
        //             restaurant: product.category.restaurant?.name || 'Sem restaurante'
        //         }))
        //     )].map(str => JSON.parse(str));

        //     uniqueCategories.forEach(category => {
        //         const option = document.createElement('option');
        //         option.value = category.id;
        //         option.textContent = `${category.name} (${category.restaurant})`;
        //         categoryFilter.appendChild(option);
        //     });

        //     // Popular filtro de restaurantes
        //     const restaurantFilter = document.getElementById('productRestaurantFilter');
        //     restaurantFilter.innerHTML = '<option value="">Todos</option>';

        //     const uniqueRestaurants = [...new Set(allProductsData
        //         .filter(product => product.category?.restaurant)
        //         .map(product => JSON.stringify({
        //             id: product.category.restaurant.id,
        //             name: product.category.restaurant.name
        //         }))
        //     )].map(str => JSON.parse(str));

        //     uniqueRestaurants.forEach(restaurant => {
        //         const option = document.createElement('option');
        //         option.value = restaurant.id;
        //         option.textContent = restaurant.name;
        //         restaurantFilter.appendChild(option);
        //     });
        // }
        let productFiltersPopulated = false;

        function populateProductFilters() {
            // Só popular uma vez para evitar recriar filtros constantemente
            if (productFiltersPopulated) return;

            // Popular filtro de categorias (usar dados carregados anteriormente)
            const categoryFilter = document.getElementById('productCategoryFilter');
            categoryFilter.innerHTML = '<option value="">Todas</option>';

            allCategoriesForProducts.forEach(category => {
                const option = document.createElement('option');
                option.value = category.id;
                option.textContent = `${category.name} (${category.restaurant?.name || 'Sem restaurante'})`;
                categoryFilter.appendChild(option);
            });

            // Popular filtro de restaurantes (usar dados dos restaurantes carregados)
            const restaurantFilter = document.getElementById('productRestaurantFilter');
            restaurantFilter.innerHTML = '<option value="">Todos</option>';

            restaurantsData.forEach(restaurant => {
                const option = document.createElement('option');
                option.value = restaurant.id;
                option.textContent = restaurant.name;
                restaurantFilter.appendChild(option);
            });

            // Se for restaurant_user, pré-selecionar e desabilitar filtro de restaurante
            if (currentUser?.role === 'restaurant_user' && currentUser.restaurant_id) {
                restaurantFilter.value = currentUser.restaurant_id;
                restaurantFilter.disabled = true;
            }

            productFiltersPopulated = true;
        }
        /**
         * Aplicar filtros de produtos
         */
        // function applyProductFilters() {
        //     const searchTerm = document.getElementById('productSearch')?.value.toLowerCase() || '';
        //     const categoryFilter = document.getElementById('productCategoryFilter')?.value || '';
        //     const restaurantFilter = document.getElementById('productRestaurantFilter')?.value || '';
        //     const statusFilter = document.getElementById('productStatusFilter')?.value || '';
        //     const promotionFilter = document.getElementById('productPromotionFilter')?.value || '';

        //     let filteredProducts = [...allProductsData];

        //     // Aplicar filtro de busca
        //     if (searchTerm) {
        //         filteredProducts = filteredProducts.filter(product =>
        //             product.name.toLowerCase().includes(searchTerm) ||
        //             (product.description && product.description.toLowerCase().includes(searchTerm)) ||
        //             (product.category && product.category.name.toLowerCase().includes(searchTerm))
        //         );
        //     }

        //     // Aplicar filtro de categoria
        //     if (categoryFilter) {
        //         filteredProducts = filteredProducts.filter(product =>
        //             product.category_id.toString() === categoryFilter
        //         );
        //     }

        //     // Aplicar filtro de restaurante
        //     if (restaurantFilter) {
        //         filteredProducts = filteredProducts.filter(product =>
        //             product.category?.restaurant_id?.toString() === restaurantFilter
        //         );
        //     }

        //     // Aplicar filtro de status
        //     if (statusFilter !== '') {
        //         const isAvailable = statusFilter === 'true';
        //         filteredProducts = filteredProducts.filter(product =>
        //             product.is_available === isAvailable
        //         );
        //     }

        //     // Aplicar filtro de promoção
        //     if (promotionFilter !== '') {
        //         const isOnPromotion = promotionFilter === 'true';
        //         filteredProducts = filteredProducts.filter(product =>
        //             product.is_on_promotion === isOnPromotion
        //         );
        //     }

        //     displayProducts(filteredProducts);
        // }

        function applyProductFilters() {
            // Resetar para página 1 ao aplicar filtros
            currentProductPage = 1;
            loadProducts(1);
        }

        /**
         * Limpar filtros de produtos
         */
        // function clearProductFilters() {
        //     document.getElementById('productSearch').value = '';
        //     document.getElementById('productCategoryFilter').value = '';
        //     document.getElementById('productRestaurantFilter').value = '';
        //     document.getElementById('productStatusFilter').value = '';
        //     document.getElementById('productPromotionFilter').value = '';
        //     applyProductFilters();
        // }

        function clearProductFilters() {
            document.getElementById('productSearch').value = '';
            document.getElementById('productCategoryFilter').value = '';
            document.getElementById('productRestaurantFilter').value = '';
            document.getElementById('productStatusFilter').value = '';
            document.getElementById('productPromotionFilter').value = '';

            // Recarregar primeira página sem filtros
            currentProductPage = 1;
            loadProducts(1);
        }
        /**
         * Configurar event listeners dos filtros
         */
        // function setupProductFilters() {
        //     const searchInput = document.getElementById('productSearch');
        //     const categoryFilter = document.getElementById('productCategoryFilter');
        //     const restaurantFilter = document.getElementById('productRestaurantFilter');
        //     const statusFilter = document.getElementById('productStatusFilter');
        //     const promotionFilter = document.getElementById('productPromotionFilter');

        //     if (searchInput) {
        //         let searchTimeout;
        //         searchInput.addEventListener('input', () => {
        //             clearTimeout(searchTimeout);
        //             searchTimeout = setTimeout(applyProductFilters, 300);
        //         });
        //     }

        //     [categoryFilter, restaurantFilter, statusFilter, promotionFilter].forEach(filter => {
        //         if (filter) {
        //             filter.addEventListener('change', applyProductFilters);
        //         }
        //     });
        // }
        function setupProductFilters() {
            const searchInput = document.getElementById('productSearch');
            const categoryFilter = document.getElementById('productCategoryFilter');
            const restaurantFilter = document.getElementById('productRestaurantFilter');
            const statusFilter = document.getElementById('productStatusFilter');
            const promotionFilter = document.getElementById('productPromotionFilter');

            if (searchInput) {
                let searchTimeout;
                searchInput.addEventListener('input', () => {
                    clearTimeout(searchTimeout);
                    searchTimeout = setTimeout(() => {
                        applyProductFilters();
                    }, 500); // 500ms de delay para não fazer muitas requisições
                });
            }

            [categoryFilter, restaurantFilter, statusFilter, promotionFilter].forEach(filter => {
                if (filter) {
                    filter.addEventListener('change', applyProductFilters);
                }
            });
        }

        function validateProductForm() {
            const categoryId = document.getElementById('productCategory').value;
            const name = document.getElementById('productName').value.trim();
            const regularPrice = parseFloat(document.getElementById('productRegularPrice').value);
            const currentPrice = parseFloat(document.getElementById('productCurrentPrice').value);
            const isOnPromotion = document.getElementById('productPromotion').checked;

            if (!categoryId) {
                showError('Selecione uma categoria');
                return false;
            }

            if (!name) {
                showError('Nome do produto é obrigatório');
                return false;
            }

            if (!regularPrice || regularPrice <= 0) {
                showError('Preço regular deve ser maior que zero');
                return false;
            }

            if (currentPrice && currentPrice <= 0) {
                showError('Preço atual deve ser maior que zero');
                return false;
            }

            if (isOnPromotion && currentPrice && currentPrice >= regularPrice) {
                showError('Preço promocional deve ser menor que o preço regular');
                return false;
            }

            return true;
        }

        // 8. Melhorar o formulário de produtos com validação em tempo real
        function setupProductFormValidation() {
            const regularPriceInput = document.getElementById('productRegularPrice');
            const currentPriceInput = document.getElementById('productCurrentPrice');
            const promotionCheckbox = document.getElementById('productPromotion');

            // Auto-preencher preço atual quando preço regular for alterado
            regularPriceInput.addEventListener('input', () => {
                const regularPrice = parseFloat(regularPriceInput.value);
                if (regularPrice && !currentPriceInput.value) {
                    currentPriceInput.value = regularPrice.toFixed(2);
                }
            });

            // Validar preços quando preço atual for alterado
            currentPriceInput.addEventListener('input', () => {
                const regularPrice = parseFloat(regularPriceInput.value);
                const currentPrice = parseFloat(currentPriceInput.value);

                if (regularPrice && currentPrice && currentPrice < regularPrice) {
                    promotionCheckbox.checked = true;
                } else if (regularPrice && currentPrice && currentPrice >= regularPrice) {
                    promotionCheckbox.checked = false;
                }
            });

            // Ajustar preço atual quando promoção for marcada/desmarcada
            promotionCheckbox.addEventListener('change', () => {
                const regularPrice = parseFloat(regularPriceInput.value);

                if (promotionCheckbox.checked && regularPrice) {
                    // Sugerir 20% de desconto
                    const suggestedPrice = (regularPrice * 0.8).toFixed(2);
                    if (!currentPriceInput.value || parseFloat(currentPriceInput.value) >= regularPrice) {
                        currentPriceInput.value = suggestedPrice;
                    }
                } else if (!promotionCheckbox.checked && regularPrice) {
                    currentPriceInput.value = regularPrice.toFixed(2);
                }
            });
        }

        /**
         * Configurar formulário de produtos
         */
        function setupProductForm() {
            const form = document.getElementById('productForm');

            form.addEventListener('submit', async (e) => {
                e.preventDefault();

                // Validar formulário
                if (!validateProductForm()) {
                    return;
                }

                const formData = {
                    category_id: parseInt(document.getElementById('productCategory').value),
                    name: document.getElementById('productName').value.trim(),
                    description: document.getElementById('productDescription').value.trim(),
                    regular_price: parseFloat(document.getElementById('productRegularPrice').value),
                    current_price: parseFloat(document.getElementById('productCurrentPrice').value) ||
                        parseFloat(document.getElementById('productRegularPrice').value),
                    sort_order: parseInt(document.getElementById('productSortOrder').value) || 0,
                    image_url: document.getElementById('productImage').value.trim(),
                    is_on_promotion: document.getElementById('productPromotion').checked,
                    is_available: document.getElementById('productAvailable').checked
                };

                await saveProduct(formData);
            });

            // Configurar validação em tempo real
            setupProductFormValidation();
        }


        /**
         * Formatar preço
         */
        function formatPrice(price) {
            return parseFloat(price).toFixed(2);
        }


        async function getProductsByCategory(categoryId) {
            try {
                const response = await fetch(`${apiBaseUrl}/categories/${categoryId}/products`);
                const data = await response.json();

                if (data.success) {
                    return data.data || [];
                }
                return [];
            } catch (error) {
                console.error('Erro ao buscar produtos da categoria:', error);
                return [];
            }
        }

        // 13. Função para buscar produtos por restaurante
        async function getProductsByRestaurant(restaurantId) {
            try {
                const response = await fetch(`${apiBaseUrl}/restaurants/${restaurantId}/products`);
                const data = await response.json();

                if (data.success) {
                    return data.data || [];
                }
                return [];
            } catch (error) {
                console.error('Erro ao buscar produtos do restaurante:', error);
                return [];
            }
        }

        // 14. Função para mover produto para outra categoria
        async function moveProductToCategory(productId, newCategoryId) {
            try {
                showLoading(true);

                const response = await fetch(`${apiBaseUrl}/products/${productId}/move`, {
                    method: 'PATCH',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ category_id: newCategoryId })
                });

                const data = await response.json();

                if (data.success) {
                    showSuccess('Produto movido com sucesso!');
                    await loadProducts();
                    return true;
                } else {
                    throw new Error(data.message || 'Erro ao mover produto');
                }
            } catch (error) {
                showError('Erro ao mover produto: ' + error.message);
                return false;
            } finally {
                showLoading(false);
            }
        }


        // Salvar mesa
        async function saveTable(formData) {
            try {
                showLoading(true);

                const method = currentTableEditId ? 'PUT' : 'POST';
                const url = currentTableEditId
                    ? `${apiBaseUrl}/tables/${currentTableEditId}`
                    : `${apiBaseUrl}/tables`;

                const response = await fetch(url, {
                    method: method,
                    headers: {
                        'Content-Type': 'application/json',
                        credentials: 'include'
                    },
                    body: JSON.stringify(formData)
                });

                const data = await response.json();

                if (data.success) {
                    showSuccess(currentTableEditId ? 'Mesa atualizada com sucesso!' : 'Mesa criada com sucesso!');
                    closeModal('table');
                    await loadTables();
                    await loadTableStats();
                } else {
                    throw new Error(data.message || 'Erro ao salvar mesa');
                }
            } catch (error) {
                showError('Erro ao salvar: ' + error.message);
            } finally {
                showLoading(false);
            }
        }

        // Configurar formulário de mesa
        function setupTableForm() {
            const form = document.getElementById('tableForm');

            form.addEventListener('submit', async (e) => {
                e.preventDefault();

                const formData = {
                    restaurant_id: parseInt(document.getElementById('tableRestaurant').value),
                    table_number: parseInt(document.getElementById('tableNumber').value),
                    name: document.getElementById('tableName').value.trim() || null,
                    capacity: parseInt(document.getElementById('tableCapacity').value),
                    is_active: document.getElementById('tableActive').checked
                };

                await saveTable(formData);
            });
        }

        // Editar mesa
        async function editTable(id) {
            try {
                const response = await fetch(`${apiBaseUrl}/tables/${id}`, {
                    headers: { credentials: 'include' }
                });
                const data = await response.json();

                if (data.success) {
                    openTableModal(data.data);
                } else {
                    throw new Error('Mesa não encontrada');
                }
            } catch (error) {
                showError('Erro ao carregar mesa: ' + error.message);
            }
        }

        // Deletar mesa
        async function deleteTable(id) {
            const table = allTablesData.find(t => t.id === id);
            if (!table) return;

            const confirmMsg = `Tem certeza que deseja deletar a Mesa ${table.table_number}?\n\nEsta ação não pode ser desfeita.`;

            if (!confirm(confirmMsg)) return;

            try {
                showLoading(true);

                const response = await fetch(`${apiBaseUrl}/tables/${id}`, {
                    method: 'DELETE',
                    headers: { credentials: 'include' }
                });

                const data = await response.json();

                if (data.success) {
                    showSuccess('Mesa deletada com sucesso!');
                    await loadTables();
                    await loadTableStats();
                } else {
                    throw new Error(data.message || 'Erro ao deletar mesa');
                }
            } catch (error) {
                showError('Erro ao deletar: ' + error.message);
            } finally {
                showLoading(false);
            }
        }

        // Alternar status da mesa
        async function toggleTableStatus(id, currentStatus) {
            try {
                showLoading(true);

                const endpoint = currentStatus
                    ? `${apiBaseUrl}/tables/${id}`
                    : `${apiBaseUrl}/tables/${id}/reactivate`;

                const method = currentStatus ? 'DELETE' : 'PATCH';

                const response = await fetch(endpoint, {
                    method,
                    headers: { credentials: 'include' }
                });
                const data = await response.json();

                if (data.success) {
                    showSuccess(`Mesa ${currentStatus ? 'inativada' : 'reativada'} com sucesso!`);
                    await loadTables();
                } else {
                    throw new Error(data.message);
                }
            } catch (error) {
                showError('Erro: ' + error.message);
            } finally {
                showLoading(false);
            }
        }

        /**
         * FUNÇÕES DE LOTE
         */

        // Modal de criação em lote
        function openBatchTableModal() {
            const modal = document.getElementById('batchTableModal');
            const restaurantSelect = document.getElementById('batchRestaurant');

            // Popular restaurantes
            restaurantSelect.innerHTML = '<option value="">Selecione um restaurante</option>';
            restaurantsData.forEach(restaurant => {
                const option = document.createElement('option');
                option.value = restaurant.id;
                option.textContent = restaurant.name;
                restaurantSelect.appendChild(option);
            });

            // Pré-selecionar se for restaurant_user
            if (currentUser?.role === 'restaurant_user' && currentUser.restaurant_id) {
                restaurantSelect.value = currentUser.restaurant_id;
                restaurantSelect.disabled = true;
            }

            modal.style.display = 'block';
        }

        function closeBatchTableModal() {
            document.getElementById('batchTableModal').style.display = 'none';
            document.getElementById('batchTableForm').reset();
        }

        // Configurar formulário de lote
        function setupBatchTableForm() {
            const form = document.getElementById('batchTableForm');

            form.addEventListener('submit', async (e) => {
                e.preventDefault();

                const startNumber = parseInt(document.getElementById('startNumber').value);
                const endNumber = parseInt(document.getElementById('endNumber').value);
                const restaurantId = parseInt(document.getElementById('batchRestaurant').value);

                if (startNumber > endNumber) {
                    showError('Número inicial deve ser menor que o final');
                    return;
                }

                if (endNumber - startNumber > 100) {
                    showError('Máximo de 100 mesas por vez');
                    return;
                }

                try {
                    showLoading(true);

                    const response = await fetch(`${apiBaseUrl}/restaurants/${restaurantId}/tables/generate`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            credentials: 'include'
                        },
                        body: JSON.stringify({
                            start_number: startNumber,
                            end_number: endNumber,
                            capacity: parseInt(document.getElementById('batchCapacity').value) || 4
                        })
                    });

                    const data = await response.json();

                    if (data.success) {
                        showSuccess(`${data.data.total_created} mesas criadas com sucesso!`);
                        closeBatchTableModal();
                        await loadTables();
                        await loadTableStats();
                    } else {
                        throw new Error(data.message || 'Erro ao criar mesas');
                    }
                } catch (error) {
                    showError('Erro: ' + error.message);
                } finally {
                    showLoading(false);
                }
            });
        }

        /**
         * FUNÇÕES DE QR CODE
         */

        // Modal de gerenciamento de QR
        function openQRManagerModal() {
            const modal = document.getElementById('qrManagerModal');
            const restaurantSelect = document.getElementById('qrRestaurant');

            // Popular restaurantes
            restaurantSelect.innerHTML = '<option value="">Selecione um restaurante</option>';
            restaurantsData.forEach(restaurant => {
                const option = document.createElement('option');
                option.value = restaurant.id;
                option.textContent = restaurant.name;
                restaurantSelect.appendChild(option);
            });

            // Pré-selecionar se for restaurant_user
            if (currentUser?.role === 'restaurant_user' && currentUser.restaurant_id) {
                restaurantSelect.value = currentUser.restaurant_id;
                restaurantSelect.disabled = true;
                loadRestaurantTables();
            }

            modal.style.display = 'block';
        }

        function closeQRManagerModal() {
            document.getElementById('qrManagerModal').style.display = 'none';
            clearQRPreview();
        }

        // Carregar mesas do restaurante para QR
        async function loadRestaurantTables() {
            const restaurantId = document.getElementById('qrRestaurant').value;
            if (!restaurantId) return;

            try {
                const response = await fetch(`${apiBaseUrl}/restaurants/${restaurantId}/tables`, {
                    headers: { credentials: 'include' }
                });
                const data = await response.json();

                if (data.success) {
                    const tables = data.data || [];

                    // Popular select individual
                    const tableSelect = document.getElementById('qrTableSelect');
                    tableSelect.innerHTML = '<option value="">Selecione uma mesa</option>';
                    tables.forEach(table => {
                        const option = document.createElement('option');
                        option.value = table.table_number;
                        option.textContent = `Mesa ${table.table_number}${table.name ? ` - ${table.name}` : ''}`;
                        tableSelect.appendChild(option);
                    });

                    // Popular checkboxes para lote
                    const checkboxList = document.getElementById('tableCheckboxList');
                    checkboxList.innerHTML = tables.map(table => `
                <div class="table-checkbox-item">
                    <input type="checkbox" id="table_${table.table_number}" value="${table.table_number}">
                    <label for="table_${table.table_number}">
                        Mesa ${table.table_number}${table.name ? ` - ${table.name}` : ''} 
                        ${table.qr_code_generated ? '(tem QR)' : ''}
                    </label>
                </div>
            `).join('');
                }
            } catch (error) {
                showError('Erro ao carregar mesas: ' + error.message);
            }
        }

        // Alternar tabs do QR
        function switchQRTab(tabName) {
            // Remover active de todas as tabs e conteúdos
            document.querySelectorAll('.qr-tab').forEach(tab => tab.classList.remove('active'));
            document.querySelectorAll('.qr-tab-content').forEach(content => content.classList.remove('active'));

            // Adicionar active na tab e conteúdo selecionados
            document.querySelector(`[data-tab="${tabName}"]`).classList.add('active');
            document.getElementById(`qrTab${tabName.charAt(0).toUpperCase() + tabName.slice(1)}`).classList.add('active');

            clearQRPreview();
        }
        // Gerar QR Restaurante
        async function generateRestaurantQR() {
            const restaurantId = document.getElementById('qrRestaurant').value;
            const tableNumber = "000"
            const format = document.getElementById('qrFormat').value;
            const size = document.getElementById('qrSize').value;


            try {
                showLoading(true);

                const url = `${apiBaseUrl}/qr/restaurant/${restaurantId}?format=${format}&size=${size}`;

                const response = await fetch(url, {
                    headers: { credentials: 'include' }
                });

                if (format === 'json') {
                    const data = await response.json();
                    if (data.success) {
                        showQRPreview(data.data.qr_code.data_url, 'Restaurante', data.data.qr_code.url);
                        showSuccess('QR Code gerado com sucesso!');
                    } else {
                        throw new Error(data.message);
                    }
                } else {
                    const blob = await response.blob();
                    const url_blob = URL.createObjectURL(blob);
                    showQRPreview(url_blob, 'Restaurante', url);
                    showSuccess('QR Code gerado com sucesso!');
                }

                // Atualizar dados das mesas
                await loadTables();

            } catch (error) {
                showError('Erro ao gerar QR: ' + error.message);
            } finally {
                showLoading(false);
            }
        }

        // Gerar QR individual
        async function generateSingleQR() {
            const restaurantId = document.getElementById('qrRestaurant').value;
            const tableNumber = document.getElementById('qrTableSelect').value;
            const format = document.getElementById('qrFormat').value;
            const size = document.getElementById('qrSize').value;

            if (!restaurantId || !tableNumber) {
                showError('Selecione restaurante e mesa');
                return;
            }

            try {
                showLoading(true);

                const url = `${apiBaseUrl}/qr/restaurant/${restaurantId}/table/${tableNumber}?format=${format}&size=${size}`;

                const response = await fetch(url, {
                    headers: { credentials: 'include' }
                });

                if (format === 'json') {
                    const data = await response.json();
                    if (data.success) {
                        showQRPreview(data.data.qr_code.data_url, `Mesa ${tableNumber}`, data.data.qr_code.url);
                        showSuccess('QR Code gerado com sucesso!');
                    } else {
                        throw new Error(data.message);
                    }
                } else {
                    const blob = await response.blob();
                    const url_blob = URL.createObjectURL(blob);
                    showQRPreview(url_blob, `Mesa ${tableNumber}`, url);
                    showSuccess('QR Code gerado com sucesso!');
                }

                // Atualizar dados das mesas
                await loadTables();

            } catch (error) {
                showError('Erro ao gerar QR: ' + error.message);
            } finally {
                showLoading(false);
            }
        }

        // Mostrar preview do QR
        function showQRPreview(imageUrl, tableName, menuUrl) {
            const preview = document.getElementById('qrPreview');
            preview.innerHTML = `
        <div class="qr-preview-container">
            <h3>${tableName}</h3>
            <img src="${imageUrl}" alt="QR Code ${tableName}" style="max-width: 300px;">
            <p style="margin-top: 15px; word-break: break-all; font-size: 0.9rem; color: var(--black2);">
                URL: ${menuUrl}
            </p>
            <div style="margin-top: 20px;">
                <button class="btn-secondary" onclick="downloadQR('${imageUrl}', '${tableName}')">
                    <ion-icon name="download-outline"></ion-icon> Download
                </button>
                <button class="btn-secondary" onclick="shareQR('${menuUrl}')">
                    <ion-icon name="share-outline"></ion-icon> Compartilhar
                </button>
            </div>
        </div>
    `;
            preview.style.display = 'block';
        }

        function clearQRPreview() {
            const preview = document.getElementById('qrPreview');
            preview.style.display = 'none';
            preview.innerHTML = '';
        }

        // Download do QR
        function downloadQR(imageUrl, tableName) {
            const link = document.createElement('a');
            link.href = imageUrl;
            link.download = `qr-${tableName.toLowerCase().replace(/\s+/g, '-')}.png`;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        // Compartilhar QR
        async function shareQR(url) {
            if (navigator.share) {
                try {
                    await navigator.share({
                        title: 'Menu Digital',
                        text: 'Acesse nosso menu digital',
                        url: url
                    });
                } catch (error) {
                    console.log('Erro ao compartilhar:', error);
                    copyToClipboard(url);
                }
            } else {
                copyToClipboard(url);
            }
        }

        // Copiar para clipboard
        function copyToClipboard(text) {
            navigator.clipboard.writeText(text).then(() => {
                showSuccess('URL copiada para a área de transferência!');
            }).catch(() => {
                showError('Erro ao copiar URL');
            });
        }

        // Selecionar/deselecionar todas as mesas
        function selectAllTables() {
            document.querySelectorAll('#tableCheckboxList input[type="checkbox"]').forEach(checkbox => {
                checkbox.checked = true;
            });
        }

        function deselectAllTables() {
            document.querySelectorAll('#tableCheckboxList input[type="checkbox"]').forEach(checkbox => {
                checkbox.checked = false;
            });
        }

        // Gerar QR em lote
        async function generateBatchQR() {
            const restaurantId = document.getElementById('qrRestaurant').value;
            const checkedBoxes = document.querySelectorAll('#tableCheckboxList input[type="checkbox"]:checked');

            if (!restaurantId) {
                showError('Selecione um restaurante');
                return;
            }

            if (checkedBoxes.length === 0) {
                showError('Selecione pelo menos uma mesa');
                return;
            }

            const tableNumbers = Array.from(checkedBoxes).map(cb => parseInt(cb.value));

            try {
                showLoading(true);

                const response = await fetch(`${apiBaseUrl}/qr/restaurant/${restaurantId}/tables/batch`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        credentials: 'include'
                    },
                    body: JSON.stringify({
                        table_numbers: tableNumbers,
                        format: 'json'
                    })
                });

                const data = await response.json();

                if (data.success) {
                    showBatchQRResults(data.data);
                    showSuccess(`${data.data.summary.successful} QR Codes gerados com sucesso!`);
                    await loadTables();
                } else {
                    throw new Error(data.message);
                }

            } catch (error) {
                showError('Erro ao gerar QR Codes: ' + error.message);
            } finally {
                showLoading(false);
            }
        }

        // Mostrar resultados do lote
        function showBatchQRResults(data) {
            const resultsDiv = document.getElementById('batchQRResults');
            const results = data.results || [];

            resultsDiv.innerHTML = `
        <h4>Resultados:</h4>
        <p><strong>Total:</strong> ${data.summary.total_requested} | 
           <strong>Sucesso:</strong> ${data.summary.successful} | 
           <strong>Falha:</strong> ${data.summary.failed}</p>
        
        <div style="max-height: 300px; overflow-y: auto; margin-top: 15px;">
            ${results.map(result => `
                <div class="qr-batch-result ${result.success ? 'qr-batch-success' : 'qr-batch-error'}">
                    ${result.success ? `
                        <strong>Mesa ${result.table.number}</strong> - QR gerado com sucesso
                        <br><small>${result.qr_code.url}</small>
                    ` : `
                        <strong>Mesa ${result.table_number}</strong> - Erro: ${result.error}
                    `}
                </div>
            `).join('')}
        </div>
    `;
        }

        // Abrir página de impressão
        // function openPrintPage() {
        //     const restaurantId = document.getElementById('qrRestaurant').value;
        //     if (!restaurantId) {
        //         showError('Selecione um restaurante');
        //         return;
        //     }

        //     const printSelection = document.querySelector('input[name="printSelection"]:checked').value;
        //     let url = `${apiBaseUrl}/qr/restaurant/${restaurantId}/print`;

        //     if (printSelection === 'selected') {
        //         const tableNumbers = document.getElementById('printTableNumbers').value.trim();
        //         if (!tableNumbers) {
        //             showError('Digite os números das mesas para impressão');
        //             return;
        //         }
        //         url += `?table_numbers=${encodeURIComponent(tableNumbers)}`;
        //     }

        //     window.open(url, '_blank');
        // }

        // Gerar QR para mesa específica (ação rápida)
        async function generateTableQR(tableId) {
            const table = allTablesData.find(t => t.id === tableId);
            if (!table) return;

            try {
                showLoading(true);

                const response = await fetch(`${apiBaseUrl}/qr/restaurant/${table.restaurant_id}/table/${table.table_number}?format=json`, {
                    headers: { credentials: 'include' }
                });

                const data = await response.json();

                if (data.success) {
                    showSuccess(`QR Code gerado para Mesa ${table.table_number}!`);
                    await loadTables();

                    // Opção de download
                    if (confirm('QR Code gerado! Deseja fazer download?')) {
                        const link = document.createElement('a');
                        link.href = data.data.qr_code.data_url;
                        link.download = `qr-mesa-${table.table_number}.png`;
                        document.body.appendChild(link);
                        link.click();
                        document.body.removeChild(link);
                    }
                } else {
                    throw new Error(data.message);
                }

            } catch (error) {
                showError('Erro ao gerar QR: ' + error.message);
            } finally {
                showLoading(false);
            }
        }

        // Visualizar menu da mesa
        function previewTableMenu(restaurantId, tableNumber) {
            // Buscar dados do restaurante
            const restaurant = restaurantsData.find(r => r.id === restaurantId);
            if (!restaurant) {
                showError('Restaurante não encontrado');
                return;
            }

            const menuUrl = `${apiBaseUrl}/menu/restaurant/${restaurant.uuid}/table/${tableNumber}`;
            window.open(menuUrl, '_blank');
        }

        // Funções de navegação da paginação (ADICIONAR)
function loadPreviousProductPage() {
    if (currentProductPage > 1) {
        currentProductPage--;
        loadProducts(currentProductPage);
    }
}

function loadNextProductPage() {
    if (currentProductPage < totalProductPages) {
        currentProductPage++;
        loadProducts(currentProductPage);
    }
}

// Carregar pedidos
async function loadOrders() {
    try {
        showLoading(true);
        let url = `${apiBaseUrl}/orders?limit=50`;

        // Filtrar por restaurante se for restaurant_user
        if (currentUser?.role === 'restaurant_user' && currentUser.restaurant_id) {
            url += `&restaurant_id=${currentUser.restaurant_id}`;
        }

        // Aplicar filtros
        const filters = getCurrentOrderFilters();
        Object.keys(filters).forEach(key => {
            if (filters[key] !== null && filters[key] !== '') {
                url += `&${key}=${encodeURIComponent(filters[key])}`;
            }
        });

        const response = await fetch(url, {
            headers: { credentials: 'include' }
        });
        const data = await response.json();

        if (data.success && data.data) {
            allOrdersData = data.data.data || [];
            displayOrders(allOrdersData);
            await loadOrderStats();
        }
    } catch (error) {
        showError('Erro ao carregar pedidos: ' + error.message);
    } finally {
        showLoading(false);
    }
}

// Exibir pedidos
function displayOrders(orders) {
    const container = document.getElementById('ordersContainer');

    if (!orders || orders.length === 0) {
        container.innerHTML = `
            <div style="text-align: center; padding: 60px 20px;">
                <ion-icon name="receipt-outline" style="font-size: 4rem; color: var(--black2); margin-bottom: 20px;"></ion-icon>
                <h3 style="color: var(--black2); margin-bottom: 10px;">Nenhum pedido encontrado</h3>
                <p style="color: var(--black2);">Os pedidos aparecerão aqui quando criados</p>
            </div>
        `;
        return;
    }

    container.innerHTML = `
        <div class="orders-grid">
            ${orders.map(order => createOrderCard(order)).join('')}
        </div>
    `;
}

// Criar card de pedido
function createOrderCard(order) {
    const statusColors = {
        pending: '#FF9800',
        confirmed: '#2196F3', 
        preparing: '#FF5722',
        ready: '#4CAF50',
        delivered: '#9C27B0',
        cancelled: '#f44336'
    };

    const statusLabels = {
        pending: 'Pendente',
        confirmed: 'Confirmado',
        preparing: 'Preparando', 
        ready: 'Pronto',
        delivered: 'Entregue',
        cancelled: 'Cancelado'
    };

    const canProgress = {
        pending: 'confirmed',
        confirmed: 'preparing',
        preparing: 'ready',
        ready: 'delivered'
    };

    return `
        <div class="order-card" style="background: white; border-radius: 15px; padding: 20px; box-shadow: 0 5px 15px rgba(0,0,0,0.1); margin-bottom: 20px;">
            <div class="order-header" style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                <div>
                    <h3 style="color: var(--primary-color); margin: 0;">#${order.order_number}</h3>
                    <p style="margin: 5px 0; color: var(--black2);">
                        <ion-icon name="time-outline"></ion-icon> 
                        ${formatDateTime(order.created_at)}
                    </p>
                    ${order.table ? `<p style="margin: 5px 0; color: var(--black2);"><ion-icon name="grid-outline"></ion-icon> Mesa ${order.table.table_number}</p>` : ''}
                </div>
                <div style="text-align: right;">
                    <div class="order-status" style="background: ${statusColors[order.status]}; color: white; padding: 5px 12px; border-radius: 15px; font-size: 0.9rem; font-weight: 600; margin-bottom: 10px;">
                        ${statusLabels[order.status]}
                    </div>
                    <div style="font-size: 1.2rem; font-weight: 700; color: var(--primary-color);">
                        ${formatPrice(order.total_amount)} MT
                    </div>
                </div>
            </div>

            <div class="order-customer" style="margin-bottom: 15px; padding: 10px; background: #f8f9fa; border-radius: 8px;">
                ${order.customer_name ? `<p><strong>Cliente:</strong> ${order.customer_name}</p>` : ''}
                ${order.customer_phone ? `<p><strong>Telefone:</strong> ${order.customer_phone}</p>` : ''}
                ${order.notes ? `<p><strong>Observações:</strong> ${order.notes}</p>` : ''}
            </div>

            <div class="order-items" style="margin-bottom: 15px;">
                <h4 style="margin-bottom: 10px; color: var(--dark-color);">Itens (${order.items?.length || 0}):</h4>
                ${order.items?.map(item => `
                    <div style="display: flex; justify-content: space-between; align-items: center; padding: 5px 0; border-bottom: 1px solid #eee;">
                        <div>
                            <strong>${item.product?.name || 'Produto não encontrado'}</strong>
                            ${item.notes ? `<br><small style="color: var(--black2);">${item.notes}</small>` : ''}
                        </div>
                        <div style="text-align: right;">
                            <span>${item.quantity}x</span>
                            <span style="margin-left: 10px; font-weight: 600;">${formatPrice(item.total_price)} MT</span>
                        </div>
                    </div>
                `).join('') || '<p>Nenhum item encontrado</p>'}
            </div>

            <div class="order-actions" style="display: flex; gap: 8px; justify-content: flex-end;">
                <button class="btn-sm btn-secondary" onclick="viewOrderDetails(${order.id})" title="Ver Detalhes">
                    <ion-icon name="eye-outline"></ion-icon>
                </button>
                
                ${canProgress[order.status] ? `
                    <button class="btn-sm btn-success" onclick="updateOrderStatus(${order.id}, '${canProgress[order.status]}')" title="Avançar Status">
                        <ion-icon name="arrow-forward-outline"></ion-icon>
                    </button>
                ` : ''}
                
                ${order.status !== 'cancelled' && order.status !== 'delivered' ? `
                    <button class="btn-sm btn-delete" onclick="cancelOrder(${order.id})" title="Cancelar">
                        <ion-icon name="close-outline"></ion-icon>
                    </button>
                ` : ''}
            </div>
        </div>
    `;
}

// Carregar estatísticas de pedidos
async function loadOrderStats() {
    try {
        let url = `${apiBaseUrl}/orders/stats?period=today`;
        
        if (currentUser?.role === 'restaurant_user' && currentUser.restaurant_id) {
            url += `&restaurant_id=${currentUser.restaurant_id}`;
        }

        const response = await fetch(url, {
            headers: { credentials: 'include' }
        });
        const data = await response.json();

        if (data.success) {
            orderStats = data.data;
            updateOrderStatsDisplay();
        }
    } catch (error) {
        console.error('Erro ao carregar stats de pedidos:', error);
    }
}

// Atualizar exibição das estatísticas
function updateOrderStatsDisplay() {
    document.getElementById('orderCount').textContent = orderStats.total_orders || 0;
    document.getElementById('pendingCount').textContent = orderStats.pending || 0;
    document.getElementById('confirmedCount').textContent = orderStats.confirmed || 0;
    document.getElementById('preparingCount').textContent = orderStats.preparing || 0;
    document.getElementById('readyCount').textContent = orderStats.ready || 0;
}

// Atualizar status do pedido
async function updateOrderStatus(orderId, newStatus) {
    try {
        showLoading(true);

        const response = await fetch(`${apiBaseUrl}/orders/${orderId}/status`, {
            method: 'PATCH',
            headers: {
                'Content-Type': 'application/json',
                credentials: 'include'
            },
            body: JSON.stringify({ status: newStatus })
        });

        const data = await response.json();

        if (data.success) {
            showSuccess('Status atualizado com sucesso!');
            await loadOrders();
        } else {
            throw new Error(data.message);
        }
    } catch (error) {
        showError('Erro ao atualizar status: ' + error.message);
    } finally {
        showLoading(false);
    }
}

// Cancelar pedido
async function cancelOrder(orderId) {
    if (!confirm('Tem certeza que deseja cancelar este pedido?')) return;
    
    await updateOrderStatus(orderId, 'cancelled');
}

// Ver detalhes do pedido
function viewOrderDetails(orderId) {
    // Implementar modal de detalhes
    alert(`Ver detalhes do pedido ${orderId} - Implementar modal`);
}

// Visão da cozinha
async function showKitchenView() {
    try {
        let url = `${apiBaseUrl}/orders/kitchen`;
        
        const response = await fetch(url, {
            headers: { credentials: 'include' }
        });
        const data = await response.json();

        if (data.success) {
            // Mostrar apenas pedidos confirmados e em preparo
            displayOrders(data.data);
            showSuccess('Visão da cozinha carregada');
        }
    } catch (error) {
        showError('Erro ao carregar visão da cozinha: ' + error.message);
    }
}

// Atualizar automaticamente
function startOrderAutoRefresh() {
    // setInterval(async () => {
    //     if (document.getElementById('orders').classList.contains('active')) {
    //         await loadOrders();
    //     }
    // }, 30000); // 30 segundos
}

// Filtros e utilitários
function getCurrentOrderFilters() {
    return {
        status: document.getElementById('orderStatusFilter')?.value || null,
        table_id: document.getElementById('orderTableFilter')?.value || null,
        period: document.getElementById('orderPeriodFilter')?.value || 'today'
    };
}

function clearOrderFilters() {
    document.getElementById('orderStatusFilter').value = '';
    document.getElementById('orderTableFilter').value = '';
    document.getElementById('orderPeriodFilter').value = 'today';
    loadOrders();
}

function formatDateTime(dateString) {
    const date = new Date(dateString);
    return date.toLocaleString('pt-BR');
}

function refreshOrders() {
    loadOrders();
}

// ======================= NOVO PEDIDO =======================

// Abrir modal de novo pedido
async function openNewOrderModal() {
    // Resetar dados
    newOrderCart = {};
    newOrderProducts = [];
    newOrderCategories = [];
    newOrderTables = [];
    
    try {
        showLoading(true);
        
        // Carregar dados necessários
        await Promise.all([
            loadNewOrderCategories(),
            loadNewOrderProducts(),
            loadNewOrderTables()
        ]);
        
        // Resetar formulário
        document.getElementById('newOrderCustomerName').value = '';
        document.getElementById('newOrderCustomerPhone').value = '';
        document.getElementById('newOrderCustomerEmail').value = '';
        document.getElementById('newOrderTable').value = '';
        document.getElementById('newOrderNotes').value = '';
        document.getElementById('newOrderSearchInput').value = '';
        
        // Mostrar modal
        document.getElementById('newOrderModal').style.display = 'block';
        
        // Renderizar produtos
        displayNewOrderProducts();
        updateNewOrderCart();
        
    } catch (error) {
        showError('Erro ao carregar dados: ' + error.message);
    } finally {
        showLoading(false);
    }
}

// Fechar modal
function closeNewOrderModal() {
    document.getElementById('newOrderModal').style.display = 'none';
    newOrderCart = {};
}

// Carregar categorias para o novo pedido
async function loadNewOrderCategories() {
    try {
        let url = `${apiBaseUrl}/categories?limit=100`;
        
        if (currentUser?.role === 'restaurant_user' && currentUser.restaurant_id) {
            url += `&restaurant_id=${currentUser.restaurant_id}`;
        }
        
        const response = await fetch(url, {
            headers: { credentials: 'include' }
        });
        const data = await response.json();
        
        if (data.success && data.data?.data) {
            newOrderCategories = data.data.data.filter(cat => cat.is_active);
            
            // Popular select de categorias
            const categorySelect = document.getElementById('newOrderCategoryFilter');
            categorySelect.innerHTML = '<option value="">Todas as categorias</option>';
            
            newOrderCategories.forEach(category => {
                const option = document.createElement('option');
                option.value = category.id;
                option.textContent = category.name;
                categorySelect.appendChild(option);
            });
        }
    } catch (error) {
        console.error('Erro ao carregar categorias:', error);
    }
}

// Carregar produtos para o novo pedido
async function loadNewOrderProducts() {
    try {
        let url = `${apiBaseUrl}/products?limit=100&is_available=true`;
        
        if (currentUser?.role === 'restaurant_user' && currentUser.restaurant_id) {
            url += `&restaurant_id=${currentUser.restaurant_id}`;
        }
        
        const response = await fetch(url, {
            headers: { credentials: 'include' }
        });
        const data = await response.json();
        
        if (data.success && data.data?.data) {
            newOrderProducts = data.data.data;
        }
    } catch (error) {
        console.error('Erro ao carregar produtos:', error);
    }
}

// Carregar mesas para o novo pedido
async function loadNewOrderTables() {
    try {
        let url = `${apiBaseUrl}/tables?limit=100&is_active=true`;
        
        if (currentUser?.role === 'restaurant_user' && currentUser.restaurant_id) {
            url += `&restaurant_id=${currentUser.restaurant_id}`;
        }
        
        const response = await fetch(url, {
            headers: { credentials: 'include' }
        });
        const data = await response.json();
        
        if (data.success && data.data) {
            newOrderTables = Array.isArray(data.data) ? data.data : data.data.data || [];
            
            // Popular select de mesas
            const tableSelect = document.getElementById('newOrderTable');
            tableSelect.innerHTML = '<option value="">Selecione uma mesa</option>';
            
            newOrderTables.forEach(table => {
                const option = document.createElement('option');
                option.value = table.table_number;
                option.textContent = `Mesa ${table.table_number}${table.name ? ` - ${table.name}` : ''}`;
                tableSelect.appendChild(option);
            });
        }
    } catch (error) {
        console.error('Erro ao carregar mesas:', error);
    }
}

// Filtrar produtos por categoria e busca
function filterOrderProducts() {
    displayNewOrderProducts();
}

// Exibir produtos no modal
function displayNewOrderProducts() {
    const container = document.getElementById('newOrderProductsList');
    const categoryFilter = document.getElementById('newOrderCategoryFilter').value;
    const searchTerm = document.getElementById('newOrderSearchInput')?.value.toLowerCase() || '';
    
    let filteredProducts = newOrderProducts;
    
    // Filtro por categoria
    if (categoryFilter) {
        filteredProducts = filteredProducts.filter(product => 
            product.category_id.toString() === categoryFilter
        );
    }
    
    // Filtro por busca de texto
    if (searchTerm) {
        filteredProducts = filteredProducts.filter(product => 
            product.name.toLowerCase().includes(searchTerm) ||
            (product.description && product.description.toLowerCase().includes(searchTerm))
        );
    }
    
    if (filteredProducts.length === 0) {
        const emptyMessage = searchTerm 
            ? `Nenhum produto encontrado para "${searchTerm}"` 
            : 'Nenhum produto encontrado';
            
        container.innerHTML = `
            <div class="empty-state">
                <ion-icon name="search-outline"></ion-icon>
                <p>${emptyMessage}</p>
                <small>Tente ajustar os filtros</small>
            </div>
        `;
        return;
    }
    
    container.innerHTML = filteredProducts.map(product => `
        <div class="order-product-item" onclick="addToNewOrderCart(${product.id})">
            <div class="product-item-header">
                <span class="product-item-name">${product.name}</span>
                <span class="product-item-price">${formatPrice(product.current_price)} MT</span>
            </div>
            ${product.description ? `<div class="product-item-description">${product.description}</div>` : ''}
            <button class="add-product-btn" onclick="event.stopPropagation(); addToNewOrderCart(${product.id})">
                <ion-icon name="add-outline"></ion-icon> Adicionar
            </button>
        </div>
    `).join('');
}
// Adicionar produto ao carrinho
function addToNewOrderCart(productId) {
    const product = newOrderProducts.find(p => p.id === productId);
    if (!product) return;
    
    if (!newOrderCart[productId]) {
        newOrderCart[productId] = {
            id: productId,
            name: product.name,
            price: parseFloat(product.current_price),
            quantity: 0
        };
    }
    
    newOrderCart[productId].quantity++;
    updateNewOrderCart();
}

// Remover produto do carrinho
function removeFromNewOrderCart(productId) {
    if (newOrderCart[productId]) {
        newOrderCart[productId].quantity--;
        
        if (newOrderCart[productId].quantity <= 0) {
            delete newOrderCart[productId];
        }
    }
    
    updateNewOrderCart();
}

// Atualizar exibição do carrinho
function updateNewOrderCart() {
    const cartItemsContainer = document.getElementById('newOrderCartItems');
    const cartSummary = document.getElementById('newOrderCartSummary');
    const submitBtn = document.getElementById('submitNewOrderBtn');
    
    const cartItems = Object.values(newOrderCart);
    
    if (cartItems.length === 0) {
        cartItemsContainer.innerHTML = '<p style="text-align: center; color: #666; margin-top: 50px;">Carrinho vazio</p>';
        cartSummary.style.display = 'none';
        submitBtn.disabled = true;
        return;
    }
    
    // Exibir itens do carrinho
    cartItemsContainer.innerHTML = cartItems.map(item => `
        <div class="cart-item">
            <div class="cart-item-info">
                <div class="cart-item-name">${item.name}</div>
                <div class="cart-item-price">${formatPrice(item.price)} MT cada</div>
            </div>
            <div class="cart-item-controls">
                <div class="quantity-control-simple">
                    <button class="quantity-btn-simple" onclick="removeFromNewOrderCart(${item.id})" ${item.quantity <= 1 ? '' : ''}>
                        −
                    </button>
                    <span class="quantity-display-simple">${item.quantity}</span>
                    <button class="quantity-btn-simple" onclick="addToNewOrderCart(${item.id})">
                        +
                    </button>
                </div>
                <button class="quantity-btn-simple" onclick="removeAllFromNewOrderCart(${item.id})" title="Remover item" style="background: var(--red);">
                    <ion-icon name="trash-outline"></ion-icon>
                </button>
            </div>
        </div>
    `).join('');
    
    // Calcular totais
    const totalItems = cartItems.reduce((sum, item) => sum + item.quantity, 0);
    const totalAmount = cartItems.reduce((sum, item) => sum + (item.quantity * item.price), 0);
    
    // Exibir resumo
    document.getElementById('newOrderTotalItems').textContent = totalItems;
    document.getElementById('newOrderTotalAmount').textContent = formatPrice(totalAmount) + ' MT';
    
    cartSummary.style.display = 'block';
    submitBtn.disabled = false;
}

// Remover todos os itens de um produto
function removeAllFromNewOrderCart(productId) {
    delete newOrderCart[productId];
    updateNewOrderCart();
}

// Submeter novo pedido
async function submitNewOrder() {
    try {
        // Validar dados do cliente
        const customerName = document.getElementById('newOrderCustomerName').value.trim();
        const customerPhone = document.getElementById('newOrderCustomerPhone').value.trim();
        const customerEmail = document.getElementById('newOrderCustomerEmail').value.trim();
        const tableNumber = document.getElementById('newOrderTable').value;
        const notes = document.getElementById('newOrderNotes').value.trim();
        
        if (!customerName || !customerPhone) {
            showError('Nome e telefone do cliente são obrigatórios');
            return;
        }
        
        if (Object.keys(newOrderCart).length === 0) {
            showError('Adicione pelo menos um produto ao pedido');
            return;
        }
        
        showLoading(true);
        
        // Preparar dados do pedido
        const cartItems = Object.values(newOrderCart);
        const totalAmount = cartItems.reduce((sum, item) => sum + (item.quantity * item.price), 0);
        
        const orderData = {
            restaurant_id: currentUser.restaurant_id,
            customer_name: customerName,
            customer_phone: customerPhone,
            customer_email: customerEmail || null,
            notes: notes || null,
            total_amount: totalAmount,
            items: cartItems.map(item => ({
                product_id: item.id,
                quantity: item.quantity,
                unit_price: item.price
            }))
        };
        
        // Adicionar mesa se selecionada
        if (tableNumber) {
            orderData.table_number = parseInt(tableNumber);
        }
        
        // Enviar pedido
        const response = await fetch(`${apiBaseUrl}/orders`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                credentials: 'include'
            },
            body: JSON.stringify(orderData)
        });
        
        const data = await response.json();
        
        if (data.success) {
            showSuccess(`Pedido #${data.data.order_number} criado com sucesso!`);
            closeNewOrderModal();
            
            // Recarregar lista de pedidos
            if (document.getElementById('orders').classList.contains('active')) {
                await loadOrders();
            }
            
            // Atualizar estatísticas
            await loadOrderStats();
        } else {
            throw new Error(data.message || 'Erro ao criar pedido');
        }
        
    } catch (error) {
        showError('Erro ao criar pedido: ' + error.message);
    } finally {
        showLoading(false);
    }
}

    </script>

    <!-- ====== ionicons ======= -->
    <script type="module" src="https://unpkg.com/ionicons@5.5.2/dist/ionicons/ionicons.esm.js"></script>
    <script nomodule src="https://unpkg.com/ionicons@5.5.2/dist/ionicons/ionicons.js"></script>
</body>

</html>
<script type="module" src="https://unpkg.com/ionicons@5.5.2/dist/ionicons/ionicons.esm.js"></script>
<script nomodule src="https://unpkg.com/ionicons@5.5.2/dist/ionicons/ionicons.js"></script>